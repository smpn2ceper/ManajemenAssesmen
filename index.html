<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Administrasi Asesmen (Online)</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        
        // Expose Firebase to Window so React can use it
        window.firebaseModules = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }

        /* --- SETTING CETAK (PRINT) --- */
        @media print {
            @page { size: A4; margin: 0; }
            html, body { margin: 0 !important; padding: 0 !important; background: white; }
            .no-print, .no-print * { display: none !important; }
            #root, .main-content-wrapper, .print-wrapper { margin: 0 !important; padding: 0 !important; width: 100% !important; background: white !important; }
            .a4-sheet { margin: 0 !important; padding: 10mm !important; width: 210mm !important; height: 296mm !important; box-shadow: none !important; border: none !important; page-break-after: always; position: relative !important; }
        }

        .print-only { display: none; }
        
        /* --- LAYOUT KERTAS A4 --- */
        .a4-sheet { background: white; width: 210mm; height: 297mm; padding: 10mm; margin: 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; box-sizing: border-box; overflow: hidden; }
        .doc-header { padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
        .doc-table th, .doc-table td { border: 1px solid black; padding: 5px; }
        .doc-table th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
        
        /* --- KARTU PESERTA --- */
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(4, 1fr); gap: 4mm; height: 100%; }
        .exam-card { border: 1px solid #000; height: 100%; display: flex; flex-direction: column; background-color: #fff; box-sizing: border-box; position: relative; font-size: 8pt; overflow: hidden; }
        .ec-header { border-bottom: 2px double #000; padding: 4px; display: flex; align-items: center; gap: 6px; height: 15mm; }
        .ec-logo { width: 30px; height: 30px; object-fit: contain; }
        .ec-title-box { flex: 1; text-align: center; line-height: 1.1; }
        .ec-agency { font-size: 5pt; text-transform: uppercase; font-weight: bold; }
        .ec-school { font-size: 7pt; font-weight: 800; text-transform: uppercase; }
        .ec-exam { font-size: 6pt; font-weight: bold; margin-top: 1px; }
        .ec-body { padding: 4px; flex: 1; display: flex; gap: 6px; }
        .ec-photo-box { width: 20mm; height: 25mm; border: 1px solid #aaa; background: #f9f9f9; display: flex; align-items: center; justify-content: center; font-size: 6pt; text-align: center; color: #bbb; flex-shrink: 0; margin-top: 2px; }
        .ec-details { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .ec-row { display: flex; margin-bottom: 1px; line-height: 1.2; }
        .ec-label { width: 50px; font-weight: 600; font-size: 7.5pt; }
        .ec-sep { width: 5px; text-align: center; font-size: 7.5pt; }
        .ec-val { flex: 1; font-weight: bold; font-size: 8pt; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ec-val.mono { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
        .ec-footer { display: flex; justify-content: flex-end; align-items: flex-end; margin-top: auto; font-size: 7pt; }
        .ec-signature { text-align: center; width: 120px; line-height: 1.1; position: relative; }
        .ec-sign-space { height: 30px; position: relative; width: 100%; }
        .ec-sign-img { height: 100%; width: auto; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 2; object-fit: contain; }
        .ec-stamp-img { height: 110%; width: auto; position: absolute; bottom: -5px; left: 10px; transform: rotate(-5deg); z-index: 1; opacity: 0.85; object-fit: contain; }
        .ec-kepsek { font-weight: bold; text-decoration: underline; font-size: 7pt; margin-top: 2px; position: relative; z-index: 3; }

        /* --- UTILS --- */
        .modal-backdrop { background-color: rgba(0,0,0,0.6); position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(2px); }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .signature-box { text-align: center; position: relative; }
        .sign-img { height: 50px; object-fit: contain; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .stamp-img { height: 55px; object-fit: contain; position: absolute; bottom: 5px; left: 30px; transform: rotate(-10deg); opacity: 0.8; z-index: 5; }

        /* --- PACT MODAL STYLE --- */
        .pact-content { max-height: 60vh; overflow-y: auto; background: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; font-size: 0.9rem; line-height: 1.6; color: #374151; margin-bottom: 1rem; text-align: justify; }
        .pact-list { list-style-type: decimal; padding-left: 1.5rem; space-y: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBXmFBcJix6doD1ZWxZ-bio-oqpeYqT7bM", 
          authDomain: "manajemenass.firebaseapp.com",
          projectId: "manajemenass",
          storageBucket: "manajemenass.firebasestorage.app",
          messagingSenderId: "665901034368",
          appId: "1:665901034368:web:ae4b55872ff47955b82f65"
        };
        
        // --- REACT LOGIC ---
        const { useState, useEffect, useMemo, useRef } = React;
        let db, auth;

        const waitForFirebase = () => new Promise(resolve => {
            const check = () => { if(window.firebaseModules) resolve(window.firebaseModules); else setTimeout(check, 100); };
            check();
        });

        // --- HOOK: FIREBASE FIRESTORE SYNC ---
        const useFirestoreState = (defaultValue, collectionKey) => {
            const [value, setValue] = useState(defaultValue);
            const [loading, setLoading] = useState(true);
            const [isDbReady, setIsDbReady] = useState(false);

            useEffect(() => {
                let unsubscribe = () => {};
                const initSync = async () => {
                    if (!db) {
                        const fb = await waitForFirebase();
                        const app = fb.initializeApp(firebaseConfig); 
                        db = fb.getFirestore(app);
                        auth = fb.getAuth(app);
                        await fb.signInAnonymously(auth);
                    }
                    const { doc, onSnapshot, setDoc } = window.firebaseModules;
                    const docRef = doc(db, 'artifacts', 'sekolah_demo', 'data', collectionKey);
                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) { setValue(docSnap.data().val); } else { setDoc(docRef, { val: defaultValue }); }
                        setLoading(false);
                    });
                    setIsDbReady(true);
                };
                initSync();
                return () => unsubscribe();
            }, [collectionKey]);

            const updateValue = (newValue) => {
                setValue(currentData => {
                    const resolvedValue = typeof newValue === 'function' ? newValue(currentData) : newValue;
                    if(isDbReady) {
                        const { doc, setDoc } = window.firebaseModules;
                        const docRef = doc(db, 'artifacts', 'sekolah_demo', 'data', collectionKey);
                        setDoc(docRef, { val: resolvedValue === undefined ? null : resolvedValue }).catch(err => console.error(err)); 
                    }
                    return resolvedValue;
                });
            };
            return [value, updateValue, loading];
        };

        // --- DATA DEFAULT ---
        const initialStudents = Array.from({ length: 42 }, (_, i) => ({ id: i + 1, name: `Siswa Peserta ${i + 1}`, class: i < 20 ? "XII IPA 1" : "XII IPS 1", examNumber: `24-01-${String(i+1).padStart(3,'0')}`, roomId: i < 20 ? 1 : 2 }));
        const initialTeachers = [{ id: 1, name: "Budi Santoso, S.Pd", nip: "19800101" }, { id: 2, name: "Siti Aminah, M.Pd", nip: "19850202" }, { id: 3, name: "Dedi Corbusi, S.Kom", nip: "-" }, { id: 4, name: "Rina Nose, S.Psi", nip: "-" }];
        const initialSubjects = [{ id: 1, name: "Matematika Wajib", date: "2023-12-04", time: "07:30 - 09:30" }, { id: 2, name: "Bahasa Indonesia", date: "2023-12-04", time: "10:00 - 12:00" }];
        const initialRooms = [{ id: 1, name: "Ruang 01", capacity: 20 }, { id: 2, name: "Ruang 02", capacity: 20 }];
        const initialSchoolInfo = { agency: "PEMERINTAH PROVINSI DAERAH KHUSUS", name: "SMA NEGERI CONTOH JAKARTA", address: "Jl. Pendidikan No. 1, Jakarta Selatan", examName: "PENILAIAN AKHIR SEMESTER (PAS)", year: "2023/2024", headmaster: "Dr. Kepala Sekolah, M.Pd", headmasterNip: "19700101 199002 1 001", adminPassword: "admin" };

        // --- COMPONENTS UI ---
        const NavButton = ({ active, onClick, icon, label }) => ( <button onClick={onClick} className={`no-print w-full flex items-center p-3 rounded-lg transition-colors duration-200 mb-1 ${active ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-slate-700 text-slate-300 hover:text-white'}`}> <div className="w-8 flex justify-center"><i className={`fas ${icon}`}></i></div> <span className="font-medium text-sm">{label}</span> </button> );
        const DocCard = ({ title, desc, icon, color, onClick }) => ( <div onClick={onClick} className="bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-lg hover:border-blue-500 border border-transparent transition-all group"> <div className="flex items-start justify-between"> <div> <h4 className="font-bold text-lg group-hover:text-blue-600">{title}</h4> <p className="text-sm text-gray-500 mt-1">{desc}</p> </div> <i className={`fas ${icon} text-2xl ${color}`}></i> </div> <div className="mt-4 text-xs font-bold text-gray-400 uppercase group-hover:text-blue-500">Klik untuk Preview</div> </div> );

        const IntegrityPactModal = ({ teacherName, onAgree }) => {
            const [checked, setChecked] = useState(false);
            return (
                <div className="modal-backdrop">
                    <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl m-4 overflow-hidden border border-slate-200 animate-fade-in-down">
                        <div className="bg-teal-600 p-4 text-white flex items-center gap-3">
                            <i className="fas fa-file-contract text-2xl"></i>
                            <div>
                                <h3 className="text-lg font-bold">Pakta Integritas Pengawas</h3>
                                <p className="text-xs text-teal-100">Harap setujui untuk melanjutkan ke sistem.</p>
                            </div>
                        </div>
                        <div className="p-6">
                            <p className="mb-4 text-sm text-gray-600">Saya yang bertanda tangan di bawah ini, <b>{teacherName}</b>, dalam rangka pelaksanaan tugas sebagai Pengawas Ujian, dengan ini menyatakan:</p>
                            <div className="pact-content">
                                <ol className="pact-list">
                                    <li>Sanggup melaksanakan tugas pengawasan dengan jujur, bertanggung jawab, dan disiplin sesuai dengan Jadwal dan Tata Tertib yang berlaku.</li>
                                    <li>Akan menjaga kerahasiaan dokumen negara dan tidak akan membocorkan soal ujian dalam bentuk apapun.</li>
                                    <li>Tidak akan memberikan bantuan jawaban kepada peserta ujian atau membiarkan terjadinya kecurangan.</li>
                                    <li>Bersedia menerima sanksi sesuai ketentuan perundang-undangan apabila melanggar pakta integritas ini.</li>
                                    <li>Akan hadir di ruang ujian tepat waktu (minimal 15 menit sebelum ujian dimulai) dan melakukan presensi digital.</li>
                                </ol>
                            </div>
                            <div className="flex items-center gap-2 mb-6 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                                <input type="checkbox" id="agreeCheck" className="w-5 h-5 text-teal-600 rounded focus:ring-teal-500 cursor-pointer" checked={checked} onChange={(e) => setChecked(e.target.checked)} />
                                <label htmlFor="agreeCheck" className="text-sm font-bold text-gray-700 cursor-pointer select-none">Saya telah membaca, memahami, dan menyetujui Pakta Integritas ini.</label>
                            </div>
                            <button onClick={onAgree} disabled={!checked} className={`w-full py-3 rounded-lg font-bold shadow-md transition-all flex items-center justify-center ${checked ? 'bg-teal-600 text-white hover:bg-teal-700 cursor-pointer' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                <i className="fas fa-signature mr-2"></i> Konfirmasi & Masuk
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ user, schedules, subjects, rooms, onLogout, studentAttendance, setStudentAttendance, violationLogs, setViolationLogs, teacherAgreements, setTeacherAgreements, supervisorAttendance, setSupervisorAttendance }) => {
            const [activeSession, setActiveSession] = useState(null);
            const [showPact, setShowPact] = useState(false);
            
            useEffect(() => {
                const hasAgreed = teacherAgreements && teacherAgreements[user.data.id];
                if (!hasAgreed) { setShowPact(true); }
            }, [user.data.id, teacherAgreements]);

            const handleAgreePact = () => {
                const now = new Date().toISOString();
                setTeacherAgreements(prev => ({ ...prev, [user.data.id]: { agreedAt: now, status: true } }));
                setShowPact(false);
            };

            const mySchedules = schedules.filter(s => s.invigilator1Id === user.data.id || s.invigilator2Id === user.data.id || s.invigilatorId === user.data.id);
            const handleAttendance = (key, sId, status) => setStudentAttendance(prev => ({...prev, [key]: {...(prev[key]||{}), [sId]: status}}));
            const handleViolation = (key, text) => setViolationLogs(prev => ({...prev, [key]: text}));

            const handleSupervisorCheckIn = (scheduleId) => {
                if(!confirm("Anda yakin sudah berada di Ruang Ujian dan ingin melakukan Check-In?")) return;
                const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                setSupervisorAttendance(prev => ({ ...prev, [scheduleId]: now }));
            };

            if (showPact) return <IntegrityPactModal teacherName={user.data.name} onAgree={handleAgreePact} />;

            if (!activeSession) return (
                <div className="min-h-screen bg-gray-100 flex flex-col">
                    <header className="bg-teal-600 text-white p-4 shadow-md flex justify-between items-center"><div><div className="text-xs opacity-80">Halo,</div><div className="font-bold">{user.data.name}</div></div><button onClick={onLogout} className="bg-teal-700 p-2 rounded hover:bg-teal-800"><i className="fas fa-sign-out-alt"></i></button></header>
                    <main className="flex-1 p-4 space-y-4 max-w-3xl mx-auto w-full">
                        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i className="fas fa-check-circle"></i></div>
                                <div><div className="font-bold text-gray-700">Status Akun</div><div className="text-xs text-green-600 font-semibold">Pakta Integritas Disetujui</div></div>
                            </div>
                        </div>
                        <h3 className="font-bold text-gray-700 mt-4">Jadwal Tugas Anda</h3>
                        {mySchedules.length === 0 ? <div className="text-center p-10 bg-white rounded-xl shadow text-gray-400"><i className="fas fa-coffee text-4xl mb-3"></i><p>Tidak ada jadwal pengawasan.</p></div> : mySchedules.map((sch, i) => { 
                            const sub = subjects.find(s => s.id === sch.subjectId); 
                            const room = rooms.find(r => r.id === sch.roomId); 
                            const isPresent = supervisorAttendance && supervisorAttendance[sch.id];
                            return (
                                <div key={i} onClick={() => setActiveSession(sch)} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-500 cursor-pointer hover:shadow-md transition relative overflow-hidden">
                                    <div className="flex justify-between items-start">
                                        <div><h4 className="font-bold text-gray-800">{sub?.name}</h4><div className="text-sm text-gray-500 mt-1"><i className="far fa-clock mr-1"></i>{sub?.time}</div></div>
                                        <div className="text-right"><div className="bg-teal-50 text-teal-700 px-3 py-1 rounded-lg text-sm font-bold mb-1">{room?.name}</div>{isPresent && <div className="text-xs font-bold text-green-600 flex items-center justify-end"><i className="fas fa-check mr-1"></i> Hadir {isPresent}</div>}</div>
                                    </div>
                                </div>
                            ); 
                        })}
                    </main>
                </div>
            );

            const sch = activeSession; 
            const sub = subjects.find(s => s.id === sch.subjectId); 
            const room = rooms.find(r => r.id === sch.roomId); 
            const roomStudents = Array.from({length: 20}, (_, i) => ({id: i + (room.id * 100), name: `Siswa ${room.name} - ${i+1}`, examNumber: `24-${room.id}-${String(i+1).padStart(3,'0')}`})); 
            const scheduleKey = `${sch.subjectId}-${sch.roomId}`; 
            const currentAttendance = studentAttendance[scheduleKey] || {}; 
            const currentViolation = violationLogs[scheduleKey] || "";
            const presenceTime = supervisorAttendance && supervisorAttendance[sch.id];

            return ( 
                <div className="min-h-screen bg-gray-100 flex flex-col"> 
                    <header className="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3"><button onClick={() => setActiveSession(null)} className="hover:bg-teal-700 p-1 rounded"><i className="fas fa-arrow-left text-xl"></i></button><div className="flex-1"><div className="font-bold text-lg leading-tight">{sub?.name}</div><div className="text-xs opacity-80">{room?.name}</div></div></header> 
                    <main className="flex-1 p-4 space-y-6 max-w-3xl mx-auto w-full"> 
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-user-check text-teal-600 mr-2"></i> Presensi Pengawas</h4>
                            {presenceTime ? (
                                <div className="w-full bg-green-50 text-green-700 border border-green-200 py-4 rounded-lg font-bold flex flex-col items-center justify-center animate-fade-in-down">
                                    <div className="text-2xl mb-1"><i className="fas fa-check-circle"></i></div>
                                    <div>Anda sudah Check-In</div>
                                    <div className="text-sm font-normal">Waktu Masuk: {presenceTime}</div>
                                </div>
                            ) : (
                                <button onClick={() => handleSupervisorCheckIn(sch.id)} className="w-full bg-teal-50 text-teal-700 border border-teal-200 py-4 rounded-lg font-bold hover:bg-teal-100 transition shadow-sm hover:shadow active:scale-95 flex flex-col items-center justify-center group">
                                    <i className="fas fa-fingerprint text-2xl mb-2 group-hover:scale-110 transition-transform"></i> 
                                    <span>Klik untuk Check-In Kehadiran</span>
                                    <span className="text-xs font-normal mt-1 text-teal-500">Pastikan Anda sudah di ruang ujian</span>
                                </button>
                            )}
                        </div> 
                        <div className={`transition-opacity duration-300 ${!presenceTime ? 'opacity-50 pointer-events-none filter blur-[1px]' : 'opacity-100'}`}>
                            <div className="bg-white p-4 rounded-xl shadow-sm mb-6">
                                <h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-users text-blue-600 mr-2"></i> Kehadiran Peserta</h4>
                                <div className="space-y-2 max-h-80 overflow-y-auto pr-1">
                                    {roomStudents.map(s => (
                                        <div key={s.id} className="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                                            <div className="flex-1"><div className="font-bold text-sm">{s.name}</div><div className="text-xs text-gray-500">{s.examNumber}</div></div>
                                            <div className="flex gap-1">{['H','S','I','A'].map(st => <button key={st} onClick={()=>handleAttendance(scheduleKey, s.id, st)} className={`w-8 h-8 rounded text-xs font-bold transition ${currentAttendance[s.id]===st ? (st==='H'?'bg-green-500 text-white':st==='A'?'bg-red-500 text-white':'bg-yellow-500 text-white') : 'bg-white border text-gray-400'}`}>{st}</button>)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div> 
                            <div className="bg-white p-4 rounded-xl shadow-sm">
                                <h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-exclamation-triangle text-red-600 mr-2"></i> Laporan Kejadian</h4>
                                <textarea className="w-full border p-3 rounded-lg h-32 focus:ring-2 focus:ring-red-200 outline-none" placeholder="Tuliskan kejadian khusus..." value={currentViolation} onChange={e=>handleViolation(scheduleKey, e.target.value)}></textarea>
                            </div>
                        </div>
                        {!presenceTime && <div className="text-center text-xs text-red-500 font-bold bg-red-50 p-2 rounded">Check-In terlebih dahulu untuk mengisi Absensi Siswa & Laporan.</div>}
                    </main> 
                </div> 
            );
        };

        const LoginPage = ({ teachers, schoolInfo, onLogin }) => {
            const [role, setRole] = useState('admin');
            const [selectedTeacher, setSelectedTeacher] = useState('');
            const [adminPass, setAdminPass] = useState('');

            const handleLogin = () => {
                if (role === 'admin') {
                    if(adminPass === (schoolInfo?.adminPassword || 'admin')) {
                        onLogin({ role: 'admin', data: null });
                    } else {
                        alert("Password Admin Salah!");
                    }
                } else {
                    if (!selectedTeacher) return alert("Pilih nama Anda terlebih dahulu.");
                    const teacherData = teachers.find(t => t.id === parseInt(selectedTeacher));
                    onLogin({ role: 'teacher', data: teacherData });
                }
            };
            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="bg-blue-600 p-8 text-center">
                            <div className="inline-block p-3 rounded-full bg-blue-500 mb-3 shadow-inner"><i className="fas fa-school text-4xl text-white"></i></div>
                            <h1 className="text-2xl font-bold text-white tracking-tight">Portal Asesmen</h1>
                            <p className="text-blue-100 text-sm mt-1">Sistem Manajemen Terpadu & Digital</p>
                        </div>
                        <div className="p-8">
                            <div className="flex bg-gray-100 rounded-lg p-1 mb-6 shadow-inner">
                                <button onClick={()=>setRole('admin')} className={`flex-1 py-2.5 rounded-md text-sm font-bold transition-all duration-200 ${role==='admin' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}><i className="fas fa-user-shield mr-2"></i>Admin</button>
                                <button onClick={()=>setRole('teacher')} className={`flex-1 py-2.5 rounded-md text-sm font-bold transition-all duration-200 ${role==='teacher' ? 'bg-white shadow text-teal-600' : 'text-gray-500 hover:text-gray-700'}`}><i className="fas fa-chalkboard-teacher mr-2"></i>Pengawas</button>
                            </div>
                            {role === 'teacher' && (
                                <div className="mb-6 animate-fade-in-down">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Pilih Identitas Pengawas</label>
                                    <div className="relative"><i className="fas fa-user absolute left-3 top-3.5 text-gray-400"></i><select className="w-full border border-gray-300 p-3 pl-10 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition bg-white" value={selectedTeacher} onChange={e=>setSelectedTeacher(e.target.value)}><option value="">-- Pilih Nama Anda --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                                </div>
                            )}
                            {role === 'admin' && (
                                <div className="mb-6 animate-fade-in-down">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Password Admin</label>
                                    <div className="relative"><i className="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i><input type="password" className="w-full border border-gray-300 p-3 pl-10 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-white" placeholder="Masukkan Password..." value={adminPass} onChange={e=>setAdminPass(e.target.value)} /></div>
                                </div>
                            )}
                            <button onClick={handleLogin} className={`w-full py-3.5 rounded-lg text-white font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center ${role==='admin' ? 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800' : 'bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700'}`}>Masuk Sistem <i className="fas fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const DataMaster = ({ students, setStudents, teachers, setTeachers, subjects, setSubjects, rooms, setRooms }) => {
            const [tab, setTab] = useState('siswa');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            const handleDelete = (id, type) => { if(confirm("Hapus data ini?")) { if(type==='siswa') setStudents(prev=>prev.filter(x=>x.id!==id)); if(type==='guru') setTeachers(prev=>prev.filter(x=>x.id!==id)); if(type==='mapel') setSubjects(prev=>prev.filter(x=>x.id!==id)); if(type==='ruang') setRooms(prev=>prev.filter(x=>x.id!==id)); } };
            const handleSave = (e) => { e.preventDefault(); const id=formData.id||Date.now(); const newData={...formData,id}; if(tab==='siswa') { if(formData.id) setStudents(prev=>prev.map(x=>x.id===id?newData:x)); else setStudents(prev=>[...prev,newData]); } if(tab==='guru') { if(formData.id) setTeachers(prev=>prev.map(x=>x.id===id?newData:x)); else setTeachers(prev=>[...prev,newData]); } if(tab==='mapel') { if(formData.id) setSubjects(prev=>prev.map(x=>x.id===id?newData:x)); else setSubjects(prev=>[...prev,newData]); } if(tab==='ruang') { if(formData.id) setRooms(prev=>prev.map(x=>x.id===id?newData:x)); else setRooms(prev=>[...prev,newData]); } setIsModalOpen(false); setFormData({}); };
            const openEdit = (item) => { setFormData(item); setIsModalOpen(true); };
            const openAdd = () => { setFormData({}); setIsModalOpen(true); };

            const tabs = [{id:'siswa', label:'Siswa', icon:'fa-user'}, {id:'guru', label:'Guru', icon:'fa-chalkboard-teacher'}, {id:'mapel', label:'Mapel', icon:'fa-book'}, {id:'ruang', label:'Ruang', icon:'fa-door-open'}];
            const getData = () => { if(tab==='siswa') return students; if(tab==='guru') return teachers; if(tab==='mapel') return subjects; return rooms; };
            const filtered = getData().filter(i => JSON.stringify(i).toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="space-y-6 animate-fade-in-down">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Data Master</h2>
                        <button onClick={openAdd} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition"><i className="fas fa-plus mr-2"></i> Tambah Data</button>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex gap-2 mb-4 overflow-x-auto">
                            {tabs.map(t => <button key={t.id} onClick={()=>setTab(t.id)} className={`px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap ${tab===t.id ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}><i className={`fas ${t.icon} mr-2`}></i>{t.label}</button>)}
                        </div>
                        <input type="text" placeholder="Cari data..." className="w-full border p-2 rounded-lg mb-4" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-4 py-3">Nama</th>
                                        <th className="px-4 py-3">Detail</th>
                                        <th className="px-4 py-3 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filtered.map(item => (
                                        <tr key={item.id} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 font-medium">{item.name}</td>
                                            <td className="px-4 py-3 text-gray-500">
                                                {tab==='siswa' && `${item.class} - ${item.examNumber}`}
                                                {tab==='guru' && `NIP: ${item.nip}`}
                                                {tab==='mapel' && `${item.date} ${item.time}`}
                                                {tab==='ruang' && `Kapasitas: ${item.capacity}`}
                                            </td>
                                            <td className="px-4 py-3 text-right">
                                                <button onClick={()=>openEdit(item)} className="text-blue-600 hover:text-blue-800 mr-3"><i className="fas fa-edit"></i></button>
                                                <button onClick={()=>handleDelete(item.id, tab)} className="text-red-600 hover:text-red-800"><i className="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {isModalOpen && (
                        <div className="modal-backdrop" onClick={()=>setIsModalOpen(false)}>
                            <div className="bg-white p-6 rounded-xl w-full max-w-md m-4" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">{formData.id ? 'Edit' : 'Tambah'} {tabs.find(t=>t.id===tab).label}</h3>
                                <form onSubmit={handleSave} className="space-y-3">
                                    <input required className="w-full border p-2 rounded" placeholder="Nama" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} />
                                    {tab==='siswa' && <><input required className="w-full border p-2 rounded" placeholder="Kelas" value={formData.class||''} onChange={e=>setFormData({...formData, class:e.target.value})} /><input required className="w-full border p-2 rounded" placeholder="No Ujian" value={formData.examNumber||''} onChange={e=>setFormData({...formData, examNumber:e.target.value})} /><select required className="w-full border p-2 rounded" value={formData.roomId||''} onChange={e=>setFormData({...formData, roomId: Number(e.target.value)})}> <option value="">Pilih Ruang</option> {rooms.map(r=><option key={r.id} value={r.id}>{r.name}</option>)} </select></>}
                                    {tab==='guru' && <input className="w-full border p-2 rounded" placeholder="NIP" value={formData.nip||''} onChange={e=>setFormData({...formData, nip:e.target.value})} />}
                                    {tab==='mapel' && <><input required type="date" className="w-full border p-2 rounded" value={formData.date||''} onChange={e=>setFormData({...formData, date:e.target.value})} /><input required className="w-full border p-2 rounded" placeholder="Waktu" value={formData.time||''} onChange={e=>setFormData({...formData, time:e.target.value})} /></>}
                                    {tab==='ruang' && <input required type="number" className="w-full border p-2 rounded" placeholder="Kapasitas" value={formData.capacity||''} onChange={e=>setFormData({...formData, capacity:e.target.value})} />}
                                    <div className="flex justify-end gap-2 mt-4">
                                        <button type="button" onClick={()=>setIsModalOpen(false)} className="px-4 py-2 text-gray-600">Batal</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ScheduleManager = ({ subjects, rooms, teachers, schedules, setSchedules }) => {
            const generateSchedule = () => {
                 const newSch = [];
                 subjects.forEach(sub => {
                     rooms.forEach((room, i) => {
                         const teacher = teachers[i % teachers.length];
                         newSch.push({ id: `${sub.id}-${room.id}`, subjectId: sub.id, roomId: room.id, invigilatorId: teacher.id });
                     });
                 });
                 setSchedules(newSch);
            };
            return (
                <div className="space-y-6 animate-fade-in-down">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center">
                        <div><h2 className="text-xl font-bold text-gray-800">Manajemen Jadwal</h2><p className="text-gray-500 text-sm">Generate jadwal otomatis berdasarkan ruang & mapel.</p></div>
                        <button onClick={generateSchedule} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition"><i className="fas fa-magic mr-2"></i> Auto Generate</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {schedules.map((sch, i) => {
                            const sub = subjects.find(s=>s.id===sch.subjectId);
                            const room = rooms.find(r=>r.id===sch.roomId);
                            const teacher = teachers.find(t=>t.id===sch.invigilatorId);
                            return (
                                <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                    <div className="font-bold text-gray-800">{sub?.name}</div>
                                    <div className="text-sm text-gray-500 mb-2">{sub?.date} â€¢ {sub?.time}</div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="bg-gray-100 px-2 py-1 rounded text-gray-600">{room?.name}</span>
                                        <span className="text-indigo-600 font-medium">{teacher?.name}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const PrintCenter = ({ schoolInfo, students, rooms, subjects, schedules, teachers }) => {
            const [view, setView] = useState('menu');
            const handlePrint = () => window.print();

            if(view === 'menu') return (
                <div className="animate-fade-in-down">
                    <h2 className="text-2xl font-bold mb-6">Pusat Cetak</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <DocCard title="Kartu Peserta" desc="Cetak kartu ujian siswa." icon="fa-id-card" color="text-blue-500" onClick={()=>{alert('Fitur preview kartu peserta (Gunakan browser print)');}} />
                        <DocCard title="Daftar Hadir" desc="Absensi siswa per ruang." icon="fa-clipboard-list" color="text-green-500" onClick={()=>{alert('Fitur preview absensi (Gunakan browser print)');}} />
                    </div>
                </div>
            );
            return null; // Simplified for brevity in this fix
        };

        const Settings = ({ info, setInfo }) => {
            const handleChange = (e) => setInfo({...info, [e.target.name]: e.target.value});
            return (
                <div className="animate-fade-in-down max-w-2xl bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                    <h2 className="text-2xl font-bold mb-6">Pengaturan Sekolah</h2>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-bold mb-1">Nama Sekolah</label><input className="w-full border p-2 rounded" name="name" value={info.name} onChange={handleChange} /></div>
                        <div><label className="block text-sm font-bold mb-1">Kepala Sekolah</label><input className="w-full border p-2 rounded" name="headmaster" value={info.headmaster} onChange={handleChange} /></div>
                        <div><label className="block text-sm font-bold mb-1">Password Admin</label><input className="w-full border p-2 rounded" name="adminPassword" value={info.adminPassword} onChange={handleChange} /></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [page, setPage] = useState('dashboard');
            
            const [students, setStudents, l1] = useFirestoreState(initialStudents, 'students');
            const [teachers, setTeachers, l2] = useFirestoreState(initialTeachers, 'teachers');
            const [subjects, setSubjects, l3] = useFirestoreState(initialSubjects, 'subjects');
            const [rooms, setRooms, l4] = useFirestoreState(initialRooms, 'rooms');
            const [schoolInfo, setSchoolInfo, l5] = useFirestoreState(initialSchoolInfo, 'schoolInfo');
            const [schedules, setSchedules, l6] = useFirestoreState([], 'schedules');
            const [studentAttendance, setStudentAttendance, l7] = useFirestoreState({}, 'attendance');
            const [violationLogs, setViolationLogs, l8] = useFirestoreState({}, 'logs');
            const [teacherAgreements, setTeacherAgreements, l9] = useFirestoreState({}, 'teacherAgreements');
            const [supervisorAttendance, setSupervisorAttendance, l10] = useFirestoreState({}, 'supervisorAttendance');

            const isLoading = l1 || l2 || l3 || l4 || l5 || l6 || l7 || l8 || l9 || l10;
            const stats = useMemo(() => ({ s: students.length, t: teachers.length, m: subjects.length, r: rooms.length, sch: schedules.length }), [students, teachers, subjects, rooms, schedules]);

            if (isLoading) return <div className="loading-screen"><div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div><p className="text-gray-500 font-medium">Menghubungkan ke Server Sekolah...</p></div>;

            if (!user) return <LoginPage teachers={teachers} schoolInfo={schoolInfo} onLogin={setUser} />;

            if (user.role === 'teacher') {
                return <TeacherDashboard 
                    user={user} 
                    schedules={schedules} 
                    subjects={subjects} 
                    rooms={rooms} 
                    onLogout={() => setUser(null)} 
                    studentAttendance={studentAttendance} 
                    setStudentAttendance={setStudentAttendance} 
                    violationLogs={violationLogs} 
                    setViolationLogs={setViolationLogs}
                    teacherAgreements={teacherAgreements}
                    setTeacherAgreements={setTeacherAgreements}
                    supervisorAttendance={supervisorAttendance}
                    setSupervisorAttendance={setSupervisorAttendance}
                />;
            }

            return (
                <div className="min-h-screen flex text-gray-800 font-sans main-content-wrapper">
                    <div className="w-64 bg-slate-800 text-slate-300 flex flex-col shadow-2xl z-20 no-print fixed h-full">
                        <div className="p-6 text-center border-b border-slate-700"> <i className="fas fa-layer-group text-4xl text-blue-500 mb-3"></i> <h1 className="text-white font-bold text-xl tracking-tight">Admin Panel</h1> </div>
                        <nav className="flex-1 p-4 overflow-y-auto"> 
                            <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-2">Menu Utama</p> 
                            <NavButton active={page==='dashboard'} onClick={()=>setPage('dashboard')} icon="fa-home" label="Dashboard" /> 
                            <NavButton active={page==='master'} onClick={()=>setPage('master')} icon="fa-database" label="Data Master" /> 
                            <NavButton active={page==='schedule'} onClick={()=>setPage('schedule')} icon="fa-calendar-alt" label="Jadwal Ujian" /> 
                            <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-6">Cetak & Laporan</p> 
                            <NavButton active={page==='print'} onClick={()=>setPage('print')} icon="fa-print" label="Pusat Cetak" /> 
                            <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-6">Konfigurasi</p> 
                            <NavButton active={page==='settings'} onClick={()=>setPage('settings')} icon="fa-cog" label="Pengaturan" /> 
                        </nav>
                        <div className="p-4 border-t border-slate-700"> <button onClick={()=>setUser(null)} className="flex items-center text-red-400 hover:text-red-300 transition w-full p-2"><i className="fas fa-sign-out-alt w-8"></i> Logout</button> </div>
                    </div>
                    <div className="flex-1 ml-64 p-8 overflow-y-auto h-screen print:ml-0 print:p-0">
                         {page === 'dashboard' && <Dashboard stats={stats} schedules={schedules} subjects={subjects} rooms={rooms} students={students} attendance={studentAttendance} />}
                         {page === 'master' && <DataMaster students={students} setStudents={setStudents} teachers={teachers} setTeachers={setTeachers} subjects={subjects} setSubjects={setSubjects} rooms={rooms} setRooms={setRooms} />}
                         {page === 'schedule' && <ScheduleManager subjects={subjects} rooms={rooms} teachers={teachers} schedules={schedules} setSchedules={setSchedules} />}
                         {page === 'print' && <PrintCenter schoolInfo={schoolInfo} students={students} rooms={rooms} subjects={subjects} schedules={schedules} teachers={teachers} />}
                         {page === 'settings' && <Settings info={schoolInfo} setInfo={setSchoolInfo} />}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ stats, schedules, subjects, rooms = [], students = [], attendance = {} }) => {
            const [date, setDate] = useState(new Date());
            const [viewMode, setViewMode] = useState('grid');
            
            useEffect(() => { const timer = setInterval(() => setDate(new Date()), 60000); return () => clearInterval(timer); }, []);
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            // Logic Monitoring Ruang
            const roomStats = rooms.map(room => {
                const roomStudents = students.filter(s => String(s.roomId) === String(room.id));
                const total = roomStudents.length;
                
                // Cari jadwal yang terhubung ke ruangan ini
                const roomSchedules = schedules.filter(s => String(s.roomId) === String(room.id));
                
                // Cari siswa yang absen (Sakit, Izin, Alpha) di ruangan ini (kumulatif dari semua sesi yang tercatat)
                // Kita gunakan Set untuk memastikan 1 siswa hanya dihitung 1x meskipun absen di beberapa mapel
                const uniqueAbsentStudents = new Set();
                
                roomSchedules.forEach(sch => {
                    const key = `${sch.subjectId}-${sch.roomId}`;
                    const log = attendance[key] || {};
                    Object.entries(log).forEach(([studentId, status]) => {
                        if (['S', 'I', 'A'].includes(status)) {
                            uniqueAbsentStudents.add(studentId);
                        }
                    });
                });

                const absentList = Array.from(uniqueAbsentStudents).map(id => {
                    const st = students.find(s => String(s.id) === String(id));
                    return st ? st.name : `ID: ${id}`;
                });

                return {
                    ...room,
                    total,
                    absentCount: uniqueAbsentStudents.size,
                    absentList
                };
            });

            return ( 
                <div className="space-y-8 animate-fade-in-down pb-10"> 
                    <div className="flex flex-col md:flex-row justify-between items-end gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100"> 
                        <div><h2 className="text-2xl font-bold text-slate-800">Dashboard Overview</h2><p className="text-slate-500 mt-1">Pantau aktivitas asesmen secara real-time (Online Mode).</p></div> 
                        <div className="text-right"><div className="text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full inline-block mb-1">{date.toLocaleDateString('id-ID', dateOptions)}</div><p className="text-xs text-slate-400">Semester Ganjil 2023/2024</p></div> 
                    </div> 
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"> 
                        <StatCard title="Total Peserta" value={stats.s || 0} icon="fa-user-graduate" color="text-blue-600" /> 
                        <StatCard title="Pengawas" value={stats.t || 0} icon="fa-chalkboard-teacher" color="text-emerald-600" /> 
                        <StatCard title="Mapel Ujian" value={stats.m || 0} icon="fa-book" color="text-violet-600" /> 
                        <StatCard title="Ruang Ujian" value={stats.r || 0} icon="fa-door-open" color="text-orange-600" /> 
                    </div> 

                    {/* NEW SECTION: MONITORING RUANG */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2">
                                <div className="bg-rose-100 text-rose-600 w-8 h-8 rounded flex items-center justify-center"><i className="fas fa-clipboard-check"></i></div>
                                <h3 className="font-bold text-slate-700 text-lg">Monitoring Kehadiran Per Ruang</h3>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button 
                                    onClick={() => setViewMode('grid')} 
                                    className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${viewMode === 'grid' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <i className="fas fa-th-large mr-1"></i> Kartu
                                </button>
                                <button 
                                    onClick={() => setViewMode('table')} 
                                    className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${viewMode === 'table' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <i className="fas fa-list mr-1"></i> Tabel
                                </button>
                            </div>
                        </div>

                        {viewMode === 'grid' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {roomStats.map(r => (
                                    <div key={r.id} className="border border-slate-200 rounded-xl p-4 bg-slate-50 hover:bg-white hover:shadow-md transition duration-300">
                                        <div className="flex justify-between items-start mb-3 border-b border-slate-200 pb-3">
                                            <div>
                                                <div className="font-bold text-slate-800 text-lg">{r.name}</div>
                                                <div className="text-xs text-slate-500">Kapasitas: {r.capacity} Kursi</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Total Siswa</div>
                                                <div className="text-xl font-black text-slate-700">{r.total}</div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white rounded-lg p-3 border border-slate-100">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-xs font-bold text-rose-600 uppercase tracking-wide">Tidak Hadir</span>
                                                <span className={`text-lg font-bold ${r.absentCount > 0 ? 'text-rose-600' : 'text-emerald-500'}`}>
                                                    {r.absentCount} <span className="text-xs font-normal text-slate-400">Siswa</span>
                                                </span>
                                            </div>
                                            
                                            {r.absentCount > 0 ? (
                                                <div className="mt-2 space-y-1 max-h-24 overflow-y-auto custom-scrollbar">
                                                    {r.absentList.map((name, i) => (
                                                        <div key={i} className="text-xs text-slate-600 bg-rose-50 px-2 py-1 rounded border border-rose-100 flex items-center gap-2">
                                                            <i className="fas fa-times-circle text-rose-400 text-[10px]"></i>
                                                            <span className="truncate">{name}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-xs text-emerald-600 bg-emerald-50 px-2 py-2 rounded border border-emerald-100 text-center font-medium">
                                                    <i className="fas fa-check-circle mr-1"></i> Semua Hadir / Belum Absen
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="overflow-x-auto border border-slate-200 rounded-lg">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200">
                                        <tr>
                                            <th className="px-4 py-3">Nama Ruang</th>
                                            <th className="px-4 py-3 text-center">Kapasitas</th>
                                            <th className="px-4 py-3 text-center">Total Siswa</th>
                                            <th className="px-4 py-3 text-center">Hadir</th>
                                            <th className="px-4 py-3 text-center">Tidak Hadir</th>
                                            <th className="px-4 py-3 w-1/3">Detail Ketidakhadiran</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 bg-white">
                                        {roomStats.map(r => (
                                            <tr key={r.id} className="hover:bg-slate-50">
                                                <td className="px-4 py-3 font-bold text-slate-700">{r.name}</td>
                                                <td className="px-4 py-3 text-center text-slate-500">{r.capacity}</td>
                                                <td className="px-4 py-3 text-center font-bold">{r.total}</td>
                                                <td className="px-4 py-3 text-center text-emerald-600 font-bold">{r.total - r.absentCount}</td>
                                                <td className={`px-4 py-3 text-center font-bold ${r.absentCount > 0 ? 'text-rose-600' : 'text-slate-300'}`}>
                                                    {r.absentCount}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {r.absentCount > 0 ? (
                                                        <div className="flex flex-wrap gap-1">
                                                            {r.absentList.map((name, i) => (
                                                                <span key={i} className="text-[10px] bg-rose-50 text-rose-600 px-2 py-0.5 rounded border border-rose-100 truncate max-w-[150px]" title={name}>
                                                                    {name}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <span className="text-xs text-emerald-500 italic"><i className="fas fa-check mr-1"></i> Lengkap</span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div> 
            );
        };

        const StatCard = ({ title, value, icon, color }) => (
            <div className={`p-4 rounded-xl shadow-sm bg-white border-l-4 ${color.replace('text-', 'border-')} flex justify-between items-center transform hover:-translate-y-1 transition duration-200`}>
                <div>
                    <p className="text-xs text-gray-500 uppercase font-bold tracking-wider">{title}</p>
                    <p className="text-2xl font-bold text-gray-800">{value}</p>
                </div>
                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl bg-gray-50 ${color}`}>
                    <i className={`fas ${icon}`}></i>
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
