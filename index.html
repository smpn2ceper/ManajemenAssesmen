<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Asesmen SMP (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        @media print {
            body { background-color: white !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { margin: 10mm; }
            .no-print { display: none !important; }
            .break-after-page { page-break-after: always; }
            .break-inside-avoid { page-break-inside: avoid; }
        }
        
        #toast-container { transition: all 0.3s ease; }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s; }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="flex flex-col items-center gap-3 text-center p-6" id="loading-message">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="font-bold text-indigo-800 animate-pulse">Menghubungkan ke Cloud...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 translate-x-[150%]"></div>

    <!-- Area Cetak -->
    <div id="print-area" class="hidden bg-white p-8"></div>

    <!-- Modal Global -->
    <div id="global-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden flex flex-col max-h-[90vh] transform scale-100 transition-all">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <h3 id="modal-title" class="font-bold text-xl text-slate-800 flex items-center gap-3">Judul Modal</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto custom-scrollbar bg-slate-50/50"></div>
        </div>
    </div>

    <!-- Container Utama -->
    <div id="app" class="min-h-screen flex flex-col"></div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        // --- 1. FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        window.appData = {
            siswa: [], guru: [], mapel: [], ruang: [], jadwal: [], jadwalPengawas: [], laporanUjian: [],
            settings: { 
                namaSekolah: "SMP CONTOH", namaDinas: "DINAS PENDIDIKAN", alamat: "-", kota: "-", 
                kepsek: "-", nipKepsek: "-", semester: "Ganjil", tahunAjaran: "2024/2025",
                logo: "", ttd: "", cap: "", passwordAdmin: "admin", passwordPengawas: "pengawas", formatNoUjian: "UJN-{YY}-{NO}"
            }
        };

        window.currentUser = null;
        window.currentPage = 'dashboard';
        window.integrityPactSigned = false;
        window.activeExamSession = null;
        window.dashboardState = { view: 'card', date: '' };

        let db = null;
        let auth = null;
        let appId = 'default';
        let unsubscribeListeners = [];

        // --- GLOBAL FUNCTIONS ATTACHMENT (DEFINED FIRST TO AVOID REFERENCE ERRORS) ---
        
        window.showToast = function(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-rose-500' : 'bg-blue-500');
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle');
            toast.className = `${colors} text-white px-5 py-3 rounded-xl shadow-xl flex items-center gap-3 fade-in transform transition-all duration-300 min-w-[300px] border border-white/20`;
            toast.innerHTML = `<i class="fas ${icon} text-lg"></i><span class="text-sm font-semibold">${message}</span>`;
            container.appendChild(toast);
            container.classList.remove('translate-x-[150%]');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.openModal = function() { document.getElementById('global-modal').classList.remove('hidden'); };
        window.closeModal = function() { document.getElementById('global-modal').classList.add('hidden'); };

        window.toggleLoginGuru = (val) => { 
            const el = document.getElementById('guru-select-container'); 
            const pass = document.getElementById('password-container');
            if(val === 'pengawas') { el.classList.remove('hidden'); pass.classList.add('hidden'); } 
            else { el.classList.add('hidden'); pass.classList.remove('hidden'); }
        };

        window.handleLoginSubmit = (e) => { 
            e.preventDefault(); 
            const r = document.getElementById('login-role').value; 
            const s = window.appData.settings; 
            
            if(r === 'admin'){ 
                const p = document.getElementById('login-pass').value;
                if(p === (s.passwordAdmin || 'admin')){ 
                    window.currentUser = {role:'admin', name:'Administrator'}; 
                    window.currentPage = 'dashboard'; 
                    renderApp(); 
                    window.showToast('Selamat datang, Admin!'); 
                } else {
                    window.showToast('Password Salah!', 'error'); 
                }
            } else { 
                const g = document.getElementById('login-guru-name').value; 
                window.currentUser = {role:'pengawas', name:g}; 
                window.integrityPactSigned = false; 
                window.activeExamSession = null; 
                renderApp(); 
                window.showToast(`Selamat datang, Bapak/Ibu ${g}`); 
            } 
        };

        window.handleLogout = () => { if(confirm('Keluar sistem?')) location.reload(); };

        window.navigateToPage = (page) => {
            window.currentPage = page;
            const content = document.getElementById('main-content');
            const title = document.getElementById('page-title');
            if(!content) return;
            
            document.querySelectorAll('.nav-item').forEach(el => {
                if (el.getAttribute('onclick') && el.getAttribute('onclick').includes(`'${page}'`)) {
                    el.className = 'nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group bg-indigo-600 text-white shadow-lg shadow-indigo-600/30';
                } else {
                    el.className = 'nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white';
                }
            });

            switch(page) {
                case 'dashboard': title.innerText = 'Dashboard Overview'; content.innerHTML = renderDashboard(); break;
                case 'siswa': title.innerText = 'Data Siswa'; content.innerHTML = renderDataSiswa(); break;
                case 'guru': title.innerText = 'Data Guru & Pengawas'; content.innerHTML = renderDataMaster('guru'); break;
                case 'mapel': title.innerText = 'Mata Pelajaran'; content.innerHTML = renderDataMaster('mapel'); break;
                case 'ruang': title.innerText = 'Manajemen Ruang'; content.innerHTML = renderDataMaster('ruang'); break;
                case 'jadwal': title.innerText = 'Jadwal Ujian'; content.innerHTML = renderDataMaster('jadwal'); break;
                case 'distribusi': title.innerText = 'Distribusi Pengawas'; content.innerHTML = renderDistribusiPengawas(); break;
                case 'cetak': title.innerText = 'Pusat Cetak'; content.innerHTML = renderCetak(); break;
                case 'settings': title.innerText = 'Pengaturan Sistem'; content.innerHTML = renderSettings(); break;
            }
        };

        // --- CONSTANTS ---
        const daftarKelas = ['7A','7B','7C','7D','7E','7F','7G','8A','8B','8C','8D','8E','8F','8G','9A','9B','9C','9D','9E','9F','9G'];
        
        const formConfig = {
            siswa: [
                { key: 'nisn', label: 'NISN', type: 'text' },
                { key: 'nama', label: 'Nama Lengkap', type: 'text' },
                { key: 'kelas', label: 'Kelas', type: 'select', options: () => daftarKelas },
                { key: 'noUjian', label: 'No Ujian', type: 'text', placeholder: 'Auto-generate' },
                { key: 'ruang', label: 'Ruang Ujian', type: 'select', options: () => window.appData.ruang.map(r => r.nama) }
            ],
            guru: [
                { key: 'nip', label: 'NIP', type: 'text' },
                { key: 'nama', label: 'Nama Lengkap', type: 'text' },
                { key: 'mapel', label: 'Mata Pelajaran', type: 'checkbox-group', options: () => window.appData.mapel.map(m => m.nama) },
                { key: 'kelas', label: 'Mengajar Kelas', type: 'checkbox-group', options: () => daftarKelas },
                { key: 'statusMengawas', label: 'Status Mengawas', type: 'select', options: () => ['Aktif', 'Pengecualian (Kondisi Khusus)'], defaultValue: 'Aktif' }
            ],
            mapel: [ { key: 'kode', label: 'Kode', type: 'text' }, { key: 'nama', label: 'Mata Pelajaran', type: 'text' } ],
            ruang: [
                { key: 'nama', label: 'Nama Ruang', type: 'text' },
                { key: 'kapasitas', label: 'Kapasitas', type: 'number' },
                { key: 'pengawas', label: 'PJ Ruang (Static)', type: 'select', options: () => window.appData.guru.map(g => ({ value: g.nama, label: `${g.nama} ${g.statusMengawas === 'Pengecualian (Kondisi Khusus)' ? '— (Pengecualian)' : ''}` })) },
                { key: 'isLocked', label: 'Kunci PJ Ruang?', type: 'select', options: () => ['Tidak (Bisa Diacak)', 'Ya (Kunci Manual)'], defaultValue: 'Tidak (Bisa Diacak)' }
            ],
            jadwal: [
                { key: 'tanggal', label: 'Tanggal', type: 'date' },
                { key: 'waktu', label: 'Waktu', type: 'text', placeholder: '07:30 - 09:30' },
                { key: 'mapel', label: 'Mata Pelajaran', type: 'select', options: () => window.appData.mapel.map(m => m.nama) },
                { key: 'jenis', label: 'Jenis Ujian', type: 'select', options: () => ['Utama', 'Susulan'] }
            ]
        };

        // --- CORE FUNCTIONS (DATA & UI SYNC) ---
        const refreshUI = () => {
            if (window.currentUser && window.currentPage !== 'dashboard') {
                window.navigateToPage(window.currentPage);
            } else if (window.currentUser && window.currentPage === 'dashboard') {
                const content = document.getElementById('main-content');
                if(content) content.innerHTML = renderDashboard();
            } else {
                if(!window.currentUser) renderApp();
            }
        };

        // --- DATA SUBSCRIPTION LOGIC ---
        const subscribeToData = () => {
            const collections = ['siswa', 'guru', 'mapel', 'ruang', 'jadwal', 'jadwalPengawas', 'laporanUjian'];
            let permissionErrorShown = false;

            collections.forEach(colName => {
                const q = collection(db, 'artifacts', appId, 'public', 'data', colName);
                const unsub = onSnapshot(q, (snapshot) => {
                    window.appData[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    refreshUI();
                }, (error) => {
                    if (error.code === 'permission-denied' && !permissionErrorShown) {
                        permissionErrorShown = true;
                        showPermissionErrorModal();
                    }
                });
                unsubscribeListeners.push(unsub);
            });

            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
            const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) window.appData.settings = { ...window.appData.settings, ...docSnap.data() };
                else setDoc(settingsRef, window.appData.settings).catch(() => {});
                refreshUI();
                setTimeout(() => {
                    const loader = document.getElementById('loading-overlay');
                    if(loader) loader.classList.add('hidden');
                }, 500);
            }, (error) => {
                 if (error.code === 'permission-denied' && !permissionErrorShown) {
                    permissionErrorShown = true;
                    showPermissionErrorModal();
                }
            });
            unsubscribeListeners.push(unsubSettings);
        };

        const showPermissionErrorModal = () => {
            const loader = document.getElementById('loading-overlay');
            if(loader) {
                loader.classList.remove('hidden');
                loader.innerHTML = `<div class="bg-white p-8 rounded-2xl shadow-2xl border border-red-100 max-w-lg mx-4 text-left relative"><h3 class="text-xl font-bold text-slate-800 mb-2">Akses Database Ditolak</h3><p class="text-sm text-slate-600 mb-4">Harap perbarui Security Rules di Firebase Console.</p><div class="bg-slate-800 text-slate-200 p-3 rounded-lg font-mono text-[10px] overflow-x-auto mb-6"><pre>match /{document=**} { allow read, write: if true; }</pre></div><button onclick="location.reload()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">Muat Ulang</button></div>`;
            }
        };

        // --- INITIALIZATION & FIREBASE CONNECT ---
        const initFirebase = async () => {
            try {
                // =================================================================
                // ⚠️ KONFIGURASI FIREBASE (MANUAL)
                // =================================================================
                const manualConfig = {
                    apiKey: "AIzaSyCajrNKcHj17q2D-d37mxnqkhs_J3ksRs4",             
                    authDomain: "administrasiass.firebaseapp.com",         
                    projectId: "administrasiass",          
                    storageBucket: "administrasiass.firebasestorage.app",      
                    messagingSenderId: "546218360584",  
                    appId: "1:546218360584:web:2f1b1456ae2e86aa37b6bd"               
                };

                let firebaseConfig;
                let useEnvToken = false;

                if (manualConfig.apiKey !== "") {
                    firebaseConfig = manualConfig; 
                    useEnvToken = false;
                } else if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config); 
                    useEnvToken = true;
                } else {
                    throw new Error("Config Kosong");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (useEnvToken && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        subscribeToData();
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-overlay').innerHTML = `
                    <div class="text-center bg-white p-6 rounded-xl shadow-2xl border border-red-100 max-w-sm mx-4">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Koneksi Database Gagal</h3>
                        <p class="text-sm text-slate-500 mb-4">Error: ${error.message}</p>
                        <button onclick="location.reload()" class="text-sm font-bold text-indigo-600 hover:underline">Coba Muat Ulang</button>
                    </div>`;
            }
        };

        // --- RENDER FUNCTIONS ---
        
        function renderApp() {
            const app = document.getElementById('app');
            if (!window.currentUser) { app.innerHTML = renderLogin(); return; }
            if (window.currentUser.role === 'pengawas') {
                if (!window.integrityPactSigned) app.innerHTML = renderPaktaIntegritas();
                else if (window.activeExamSession) app.innerHTML = renderRuangVirtual();
                else app.innerHTML = renderDashboardPengawas();
                return;
            }
            app.innerHTML = renderAdminLayout();
            if(window.currentPage === 'dashboard') {
                setTimeout(() => {
                    const content = document.getElementById('main-content');
                    if(content) content.innerHTML = renderDashboard();
                }, 50);
            } else {
                window.navigateToPage(window.currentPage);
            }
        }

        function renderLogin() {
            const guruOptions = (window.appData.guru || []).map(g => `<option value="${g.nama}">${g.nama}</option>`).join('');
            return `<div class="flex-1 flex items-center justify-center bg-gradient-to-br from-indigo-900 via-slate-800 to-slate-900 p-4 min-h-screen relative overflow-hidden"><div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div><div class="bg-white/95 backdrop-blur-sm p-10 rounded-3xl shadow-2xl w-full max-w-md fade-in relative z-10 border border-white/50"><div class="text-center mb-10"><div class="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-500/30 transform rotate-3"><i class="fas fa-graduation-cap text-4xl text-white"></i></div><h1 class="text-2xl font-bold text-slate-800 tracking-tight">E-Asesmen SMP</h1><p class="text-sm text-slate-500 mt-2 font-medium">Sistem Manajemen Terpadu</p></div><form onsubmit="handleLoginSubmit(event)" class="space-y-6"><div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Masuk Sebagai</label><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-indigo-500"><i class="fas fa-user-circle"></i></div><select id="login-role" onchange="toggleLoginGuru(this.value)" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all appearance-none font-medium text-slate-700"><option value="admin">Admin / Panitia</option><option value="pengawas">Pengawas Ruang</option></select><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div></div></div><div id="guru-select-container" class="hidden slide-up"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nama Pengawas</label><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-indigo-500"><i class="fas fa-id-badge"></i></div><select id="login-guru-name" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700">${guruOptions}</select></div></div><div id="password-container"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Kata Sandi</label><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-indigo-500"><i class="fas fa-lock"></i></div><input type="password" id="login-pass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-medium placeholder:text-slate-400 transition-all" placeholder="••••••••"></div></div><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/30 transition-all transform active:scale-95 flex justify-center items-center gap-2"><span>Masuk Aplikasi</span><i class="fas fa-arrow-right"></i></button></form></div></div>`;
        }

        function renderAdminLayout() {
            return `<div id="dashboard-page" class="flex h-screen overflow-hidden bg-slate-50"><aside class="w-72 bg-slate-900 flex flex-col shrink-0 transition-all duration-300 relative z-20"><div class="h-20 flex items-center px-8 bg-slate-950/50 border-b border-white/5 backdrop-blur-sm"><div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center mr-3 shadow-lg shadow-indigo-500/20"><i class="fas fa-graduation-cap text-white text-xl"></i></div><div><h1 class="text-white font-bold text-lg tracking-tight">E-Asesmen</h1><p class="text-slate-500 text-xs font-medium">Panel Admin</p></div></div><div class="flex-1 overflow-y-auto py-6 px-4 custom-scrollbar space-y-1"><div class="mb-6"><p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Utama</p><a href="#" onclick="navigateToPage('dashboard')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-gauge-high w-5 text-center transition-colors group-hover:text-indigo-400"></i><span class="font-medium text-sm">Dashboard</span></a></div><div class="mb-6"><p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Data Master</p><a href="#" onclick="navigateToPage('siswa')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-user-graduate w-5 text-center transition-colors group-hover:text-pink-400"></i><span class="font-medium text-sm">Data Siswa</span></a><a href="#" onclick="navigateToPage('guru')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-chalkboard-user w-5 text-center transition-colors group-hover:text-emerald-400"></i><span class="font-medium text-sm">Data Guru</span></a><a href="#" onclick="navigateToPage('mapel')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-book-open w-5 text-center transition-colors group-hover:text-amber-400"></i><span class="font-medium text-sm">Mata Pelajaran</span></a><a href="#" onclick="navigateToPage('ruang')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-door-open w-5 text-center transition-colors group-hover:text-cyan-400"></i><span class="font-medium text-sm">Data Ruang</span></a></div><div class="mb-6"><p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Ujian</p><a href="#" onclick="navigateToPage('jadwal')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-calendar-day w-5 text-center transition-colors group-hover:text-orange-400"></i><span class="font-medium text-sm">Jadwal Ujian</span></a><a href="#" onclick="navigateToPage('distribusi')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-people-arrows w-5 text-center transition-colors group-hover:text-violet-400"></i><span class="font-medium text-sm">Jadwal Pengawas</span></a><a href="#" onclick="navigateToPage('cetak')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-print w-5 text-center transition-colors group-hover:text-blue-400"></i><span class="font-medium text-sm">Cetak Laporan</span></a></div><div><p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">System</p><a href="#" onclick="navigateToPage('settings')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group text-slate-400 hover:bg-white/5 hover:text-white"><i class="fas fa-sliders w-5 text-center transition-colors group-hover:text-slate-300"></i><span class="font-medium text-sm">Pengaturan</span></a></div></div><div class="p-6 border-t border-white/5 bg-slate-950/30"><button onclick="handleLogout()" class="flex items-center justify-center w-full gap-2 px-4 py-3 rounded-xl text-sm font-bold text-red-400 bg-red-500/10 hover:bg-red-500 hover:text-white transition-all duration-200"><i class="fas fa-arrow-right-from-bracket"></i> Keluar</button></div></aside><div class="flex-1 flex flex-col min-w-0 bg-slate-50 relative"><header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-30"><h2 id="page-title" class="text-2xl font-bold text-slate-800 tracking-tight">Dashboard</h2><div class="flex items-center gap-4"><div class="text-right hidden md:block"><p id="user-name-display" class="text-sm font-bold text-slate-800">Administrator</p><p class="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-0.5 rounded-full inline-block">Panitia Pusat</p></div><div class="h-11 w-11 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 ring-2 ring-white"><i class="fas fa-user-astronaut text-lg"></i></div></div></header><main class="flex-1 overflow-y-auto p-8 relative custom-scrollbar" id="main-content"></main></div></div>`;
        }

        function renderDashboard() {
            if (!window.dashboardState.date && window.appData.jadwal.length > 0) window.dashboardState.date = window.appData.jadwal[0].tanggal;
            const dates = [...new Set(window.appData.jadwal.map(j => j.tanggal))].sort();
            const dateOpts = dates.map(d => `<option value="${d}" ${d===window.dashboardState.date?'selected':''}>${d}</option>`).join('');
            
            const stats = [
                { l: 'Total Siswa', v: window.appData.siswa.length, i: 'fa-users', c: 'from-blue-500 to-blue-600', bg: 'bg-blue-500/10 text-blue-600' },
                { l: 'Total Guru', v: window.appData.guru.length, i: 'fa-chalkboard-user', c: 'from-emerald-500 to-emerald-600', bg: 'bg-emerald-500/10 text-emerald-600' },
                { l: 'Ruang Ujian', v: window.appData.ruang.length, i: 'fa-door-open', c: 'from-violet-500 to-violet-600', bg: 'bg-violet-500/10 text-violet-600' },
                { l: 'Mata Pelajaran', v: window.appData.mapel.length, i: 'fa-book-bookmark', c: 'from-amber-500 to-amber-600', bg: 'bg-amber-500/10 text-amber-600' }
            ];

            const roomStats = window.appData.ruang.map(r => {
                const total = window.appData.siswa.filter(s => s.ruang === r.nama).length;
                const pct = total > 0 ? 100 : 0;
                return { nama: r.nama, pengawas: r.pengawas, total, pct };
            });

            return `
            <div class="space-y-8 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${stats.map(s => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden group hover:-translate-y-1 transition-all duration-300">
                        <div class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br ${s.c} opacity-5 rounded-bl-full -mr-8 -mt-8 group-hover:scale-110 transition-transform"></div>
                        <div class="flex items-center gap-4 relative z-10">
                            <div class="w-14 h-14 rounded-2xl ${s.bg} flex items-center justify-center text-2xl shadow-sm"><i class="fas ${s.i}"></i></div>
                            <div><p class="text-sm font-semibold text-slate-500">${s.l}</p><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight">${s.v}</h3></div>
                        </div>
                    </div>`).join('')}
                </div>
                <div>
                    <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                        <div><h3 class="text-lg font-bold text-slate-800">Monitoring Kehadiran</h3><p class="text-sm text-slate-500">Pantau aktivitas ruang ujian secara realtime.</p></div>
                        <div class="flex items-center gap-3 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                            <div class="px-3 py-1.5 flex items-center gap-2 text-sm font-semibold text-slate-600 border-r border-slate-100"><i class="far fa-calendar text-indigo-500"></i><select id="filter-tanggal" onchange="changeDashboardFilter()" class="bg-transparent outline-none cursor-pointer hover:text-indigo-600 transition-colors"><option value="">Pilih Tanggal</option>${dateOpts}</select></div>
                            <div class="flex p-1 bg-slate-100 rounded-lg"><button onclick="changeDashboardView('card')" class="w-8 h-8 rounded-md flex items-center justify-center transition-all bg-white text-indigo-600 shadow-sm"><i class="fas fa-border-all"></i></button><button onclick="changeDashboardView('table')" class="w-8 h-8 rounded-md flex items-center justify-center transition-all bg-white text-indigo-600 shadow-sm"><i class="fas fa-list"></i></button></div>
                        </div>
                    </div>
                    ${window.dashboardState.view === 'card' ? 
                        `<div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6">${roomStats.map(r => `<div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:shadow-md transition-all group"><div class="flex justify-between items-start mb-4"><div class="bg-slate-50 p-2 rounded-xl border border-slate-100 group-hover:border-indigo-100 group-hover:bg-indigo-50 transition-colors"><i class="fas fa-door-open text-indigo-500 text-lg"></i></div><span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded-lg">Aktif</span></div><h4 class="text-lg font-bold text-slate-800 mb-1">${r.nama}</h4><p class="text-xs text-slate-500 font-medium mb-4 flex items-center gap-1"><i class="fas fa-user-shield text-slate-400"></i> ${r.pengawas}</p><div class="grid grid-cols-3 gap-2 text-center pt-4 border-t border-slate-100"><div><p class="text-[10px] uppercase font-bold text-slate-400">Total</p><p class="font-bold text-slate-700">${r.total}</p></div><div><p class="text-[10px] uppercase font-bold text-emerald-500">Hadir</p><p class="font-bold text-emerald-600">-</p></div><div><p class="text-[10px] uppercase font-bold text-rose-500">Absen</p><p class="font-bold text-rose-600">-</p></div></div></div>`).join('')}</div>` 
                    : 
                        `<div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b border-slate-100 text-slate-500 uppercase text-xs font-bold"><tr><th class="px-6 py-4">Ruang</th><th class="px-6 py-4">Pengawas</th><th class="px-6 py-4 text-center">Total</th><th class="px-6 py-4 text-center text-emerald-600">Hadir</th><th class="px-6 py-4 text-center text-rose-600">Absen</th></tr></thead><tbody>${roomStats.map(r => `<tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors"><td class="px-6 py-4 font-bold text-slate-700">${r.nama}</td><td class="px-6 py-4 text-slate-600">${r.pengawas}</td><td class="px-6 py-4 text-center font-bold">${r.total}</td><td class="px-6 py-4 text-center">-</td><td class="px-6 py-4 text-center">-</td></tr>`).join('')}</tbody></table></div>`
                    }
                </div>
            </div>`;
        }

        function renderDataSiswa() {
            let data = window.appData.siswa || [];
            let rows = data.map(d => `<tr class="hover:bg-slate-50 transition-colors group"><td class="px-4 py-4 text-center"><input type="checkbox" class="student-cb w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${d.id}"></td><td class="px-6 py-4 font-semibold text-slate-700">${d.nisn}</td><td class="px-6 py-4 font-bold text-slate-800">${d.nama}</td><td class="px-6 py-4"><span class="px-2.5 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold border border-slate-200">${d.kelas}</span></td><td class="px-6 py-4 text-sm">${d.noUjian ? `<span class="font-mono text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100 font-bold">${d.noUjian}</span>` : `<span class="text-slate-400 text-xs italic">Belum ada</span>`}</td><td class="px-6 py-4 text-sm font-medium text-slate-600">${d.ruang || '-'}</td><td class="px-6 py-4 text-center"><button onclick="showFormModal('siswa', 'edit', '${d.id}')" class="w-8 h-8 rounded-lg text-amber-500 hover:bg-amber-50 transition-colors mr-1"><i class="fas fa-pen"></i></button><button onclick="deleteData('siswa', '${d.id}')" class="w-8 h-8 rounded-lg text-rose-500 hover:bg-rose-50 transition-colors"><i class="fas fa-trash"></i></button></td></tr>`);
            
            return `
            <div class="space-y-6 fade-in">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-col xl:flex-row justify-between gap-4 mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-pink-50 text-pink-500 flex items-center justify-center text-xl shadow-sm"><i class="fas fa-user-graduate"></i></div>
                            <div><h3 class="font-bold text-lg text-slate-800">Data Siswa</h3><p class="text-xs text-slate-500 font-medium">Total: ${data.length} Siswa</p></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadTemplate()" class="px-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl text-sm font-bold hover:bg-emerald-100 border border-emerald-100 transition-colors"><i class="fas fa-file-excel mr-2"></i> Template</button>
                            <button onclick="document.getElementById('file-import').click()" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold hover:bg-blue-100 border border-blue-100 transition-colors"><i class="fas fa-upload mr-2"></i> Import</button>
                            <input type="file" id="file-import" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleImport(event)">
                            <button onclick="showFormModal('siswa', 'add')" class="px-5 py-2 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors"><i class="fas fa-plus mr-2"></i> Tambah</button>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-slate-100">
                        <div class="relative flex-1"><i class="fas fa-search absolute left-3 top-3 text-slate-400"></i><input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Cari nama, NISN..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                        <div class="flex gap-2">
                            <button onclick="generateNoUjian()" class="px-4 py-2.5 bg-violet-50 text-violet-600 rounded-xl text-xs font-bold hover:bg-violet-100 border border-violet-100"><i class="fas fa-wand-magic-sparkles mr-2"></i> Generate No</button>
                            <button onclick="openMappingModal()" class="px-4 py-2.5 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-100 border border-indigo-100"><i class="fas fa-map-location-dot mr-2"></i> Mapping</button>
                            <button onclick="resetUjian()" class="px-4 py-2.5 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold hover:bg-rose-100 border border-rose-100"><i class="fas fa-rotate-left mr-2"></i> Reset</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto"><table id="dataTable" class="w-full text-left text-sm"><thead class="bg-indigo-50/50 border-b border-indigo-100 text-indigo-900 uppercase text-xs font-bold tracking-wider"><tr><th class="px-4 py-4 text-center w-12"><input type="checkbox" id="selectAll" onclick="toggleAllSiswa(this)" class="rounded text-indigo-600 focus:ring-indigo-500"></th><th class="px-6 py-4">NISN</th><th class="px-6 py-4">Nama Siswa</th><th class="px-6 py-4">Kelas</th><th class="px-6 py-4">No Ujian</th><th class="px-6 py-4">Ruang</th><th class="px-6 py-4 text-center">Aksi</th></tr></thead><tbody class="divide-y divide-slate-100">${rows.join('')}</tbody></table></div>
                </div>
            </div>`;
        }

        function renderDataMaster(type) {
            const config = {
                guru: { headers: ['NIP', 'Nama Lengkap', 'Mapel', 'Status'], keys: ['nip', 'nama', 'mapel', 'statusMengawas'], icon: 'fa-chalkboard-user', color: 'text-emerald-500', bg: 'bg-emerald-50' },
                mapel: { headers: ['Kode Mapel', 'Nama Mata Pelajaran'], keys: ['kode', 'nama'], icon: 'fa-book-open', color: 'text-amber-500', bg: 'bg-amber-50' },
                ruang: { headers: ['Nama Ruang', 'Kapasitas', 'PJ Ruang', 'Kunci'], keys: ['nama', 'kapasitas', 'pengawas', 'isLocked'], icon: 'fa-door-open', color: 'text-cyan-500', bg: 'bg-cyan-50' },
                jadwal: { headers: ['Tanggal', 'Waktu', 'Mata Pelajaran', 'Jenis'], keys: ['tanggal', 'waktu', 'mapel', 'jenis'], icon: 'fa-calendar-day', color: 'text-orange-500', bg: 'bg-orange-50' }
            }[type];

            return `
            <div class="space-y-6 fade-in">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4 w-full sm:w-auto">
                        <div class="w-12 h-12 rounded-xl ${config.bg} ${config.color} flex items-center justify-center text-xl shadow-sm"><i class="fas ${config.icon}"></i></div>
                        <div><h3 class="font-bold text-lg text-slate-800">Manajemen ${type.charAt(0).toUpperCase() + type.slice(1)}</h3><p class="text-xs text-slate-500 font-medium">Total: ${window.appData[type].length} Data</p></div>
                    </div>
                    <div class="flex gap-3 w-full sm:w-auto">
                        <div class="relative flex-1 sm:w-64"><i class="fas fa-search absolute left-3 top-3 text-slate-400"></i><input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Cari data..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                        ${type==='ruang' ? `<button onclick="generatePengawas()" class="bg-indigo-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200"><i class="fas fa-shuffle mr-2"></i> Acak PJ</button>` : ''}
                        <button onclick="showFormModal('${type}', 'add')" class="bg-blue-600 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200"><i class="fas fa-plus mr-2"></i> Tambah</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table id="dataTable" class="w-full text-left text-sm">
                            <thead class="bg-indigo-50/50 border-b border-indigo-100 text-indigo-900 uppercase text-xs font-bold tracking-wider"><tr>${config.headers.map(h => `<th class="px-6 py-4">${h}</th>`).join('')}<th class="px-6 py-4 text-center">Aksi</th></tr></thead>
                            <tbody class="divide-y divide-slate-100">${window.appData[type].map(d => `<tr class="hover:bg-slate-50 transition-colors group">${config.keys.map(k => `<td class="px-6 py-4 text-slate-600 font-medium group-hover:text-slate-800">${d[k]||'-'}</td>`).join('')}<td class="px-6 py-4 text-center"><button onclick="showFormModal('${type}','edit','${d.id}')" class="w-8 h-8 rounded-lg text-amber-500 hover:bg-amber-50 transition-colors mr-1"><i class="fas fa-pen"></i></button><button onclick="deleteData('${type}','${d.id}')" class="w-8 h-8 rounded-lg text-rose-500 hover:bg-rose-50 transition-colors"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }

        function renderDistribusiPengawas() {
            const data = window.appData.jadwalPengawas || [];
            data.sort((a, b) => {
                if (a.tanggal !== b.tanggal) return a.tanggal.localeCompare(b.tanggal);
                if (a.waktu !== b.waktu) return a.waktu.localeCompare(b.waktu);
                return a.ruang.localeCompare(b.ruang);
            });

            let rows = data.map(d => {
                const isWarning = d.pengawas === 'KURANG PENGAWAS';
                return `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="px-6 py-4 text-slate-600"><i class="far fa-calendar mr-2 text-slate-400"></i>${d.tanggal}</td>
                    <td class="px-6 py-4 font-medium text-slate-700">${d.waktu}</td>
                    <td class="px-6 py-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600 uppercase">${d.mapel}</span></td>
                    <td class="px-6 py-4 font-bold text-indigo-700">${d.ruang}</td>
                    <td class="px-6 py-4 font-semibold ${isWarning ? 'text-red-600 bg-red-50' : 'text-slate-800'}">
                        <i class="fas ${isWarning ? 'fa-exclamation-triangle' : 'fa-user-check'} mr-2 ${isWarning ? 'text-red-500' : 'text-emerald-500'}"></i>${d.pengawas}
                    </td>
                </tr>`;
            }).join('');
            
            return `
            <div class="space-y-6 fade-in">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-violet-50 text-violet-600 flex items-center justify-center text-xl shadow-sm"><i class="fas fa-people-arrows"></i></div>
                        <div><h3 class="font-bold text-lg text-slate-800">Distribusi Pengawas Otomatis</h3><p class="text-sm text-slate-500">Sistem akan merotasi guru agar mengawas di ruang berbeda setiap sesi.</p></div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="configurePrint('distribusi')" class="bg-white border border-slate-200 text-slate-700 px-5 py-2.5 rounded-xl font-bold hover:bg-slate-50 transition-colors"><i class="fas fa-print mr-2"></i> Cetak Jadwal</button>
                        <button onclick="generateDistribusiPengawas()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200"><i class="fas fa-wand-magic-sparkles mr-2"></i> Generate Jadwal</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs font-bold"><tr><th class="px-6 py-4">Tanggal</th><th class="px-6 py-4">Waktu</th><th class="px-6 py-4">Mata Pelajaran</th><th class="px-6 py-4">Ruang Ujian</th><th class="px-6 py-4">Pengawas Bertugas</th></tr></thead><tbody>${rows || '<tr><td colspan="5" class="p-8 text-center text-slate-500">Belum ada jadwal.</td></tr>'}</tbody></table></div>
                </div>
            </div>`;
        }

        function renderCetak() {
            const opts = [
                {id:'kartu', t:'Kartu Peserta', d:'Cetak kartu ujian dengan QR Code untuk siswa.', i:'fa-id-card', c:'blue'},
                {id:'hadir-siswa', t:'Daftar Hadir Siswa', d:'Format presensi siswa per ruang ujian.', i:'fa-clipboard-list', c:'emerald'},
                {id:'hadir-pengawas', t:'Daftar Hadir Pengawas', d:'Lembar tanda tangan pengawas per sesi.', i:'fa-user-pen', c:'violet'},
                {id:'label-meja', t:'Label Meja', d:'Stiker nomor meja untuk ditempel.', i:'fa-tags', c:'amber'},
                {id:'label-ruang', t:'Label Ruang', d:'Tanda pengenal besar untuk pintu ruang.', i:'fa-door-closed', c:'indigo'},
                {id:'ba-ljk', t:'Serah Terima LJK', d:'Checklist penyerahan LJK ke panitia.', i:'fa-file-signature', c:'rose'},
                {id:'ba-soal', t:'Serah Terima Soal', d:'Checklist pengambilan soal dari panitia.', i:'fa-box-archive', c:'cyan'},
                {id:'ba-guru', t:'Serah Terima Guru', d:'Berita acara penyerahan LJK ke guru mapel.', i:'fa-handshake', c:'orange'}
            ];
            return `
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 fade-in">
                ${opts.map(o => `
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md hover:border-${o.c}-200 transition-all group text-center cursor-pointer" onclick="configurePrint('${o.id}')">
                    <div class="w-16 h-16 mx-auto rounded-2xl bg-${o.c}-50 text-${o.c}-500 flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition-transform duration-300"><i class="fas ${o.i}"></i></div>
                    <h3 class="font-bold text-xl text-slate-800 mb-2 group-hover:text-${o.c}-600 transition-colors">${o.t}</h3>
                    <p class="text-sm text-slate-500 mb-6 leading-relaxed">${o.d}</p>
                    <button class="w-full py-3 bg-slate-50 text-slate-700 rounded-xl font-bold text-sm group-hover:bg-${o.c}-600 group-hover:text-white transition-all">Cetak Dokumen</button>
                </div>`).join('')}
            </div>`;
        }

        function renderSettings() {
            const s = window.appData.settings;
            return `
            <div class="max-w-5xl mx-auto h-full flex flex-col space-y-6 fade-in pb-10">
                <div class="flex justify-between items-center">
                    <div><h3 class="text-2xl font-bold text-slate-800">Pengaturan Sistem</h3><p class="text-slate-500 text-sm">Kelola identitas instansi, konfigurasi ujian, dan keamanan data.</p></div>
                    <button onclick="saveSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all flex items-center gap-2"><i class="fas fa-save"></i> <span>Simpan Perubahan</span></button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-school text-lg"></i></div><h4 class="font-bold text-slate-800 text-lg">Identitas Sekolah</h4></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="col-span-2 md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Nama Dinas</label><input type="text" id="set-dinas" value="${s.namaDinas}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"></div>
                                <div class="col-span-2 md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Nama Sekolah</label><input type="text" id="set-sekolah" value="${s.namaSekolah}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"></div>
                                <div class="col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Alamat Lengkap</label><textarea id="set-alamat" rows="2" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition-all resize-none">${s.alamat}</textarea></div>
                                <div class="col-span-2 md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Kota/Kabupaten</label><input type="text" id="set-kota" value="${s.kota}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><div class="w-10 h-10 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center"><i class="fas fa-user-tie text-lg"></i></div><h4 class="font-bold text-slate-800 text-lg">Kepala Sekolah & Tahun Ajaran</h4></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Nama Kepala Sekolah</label><input type="text" id="set-kepsek" value="${s.kepsek}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none transition-all"></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">NIP</label><input type="text" id="set-nip" value="${s.nipKepsek}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none transition-all"></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Tahun Ajaran</label><input type="text" id="set-ta" value="${s.tahunAjaran}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none transition-all"></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Semester</label><div class="relative"><select id="set-smt" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none"><option ${s.semester==='Ganjil'?'selected':''}>Ganjil</option><option ${s.semester==='Genap'?'selected':''}>Genap</option></select><div class="absolute right-3 top-3.5 pointer-events-none text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><div class="w-10 h-10 rounded-lg bg-amber-50 text-amber-600 flex items-center justify-center"><i class="fas fa-images text-lg"></i></div><h4 class="font-bold text-slate-800 text-lg">Aset Digital</h4></div>
                            <div class="space-y-4">
                                ${renderImageUpload('Logo Sekolah', 'logo', s.logo)}
                                ${renderImageUpload('Tanda Tangan', 'ttd', s.ttd)}
                                ${renderImageUpload('Stempel/Cap', 'cap', s.cap)}
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><div class="w-10 h-10 rounded-lg bg-rose-50 text-rose-600 flex items-center justify-center"><i class="fas fa-shield-halved text-lg"></i></div><h4 class="font-bold text-slate-800 text-lg">Keamanan</h4></div>
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Format No Ujian</label><input type="text" id="set-format-ujian" value="${s.formatNoUjian || 'UJN-{YY}-{NO}'}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-rose-500 outline-none font-mono text-sm"><p class="text-[10px] text-slate-400 mt-1">Placeholder: {YY} = Tahun, {NO} = Urut</p></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Password Admin</label><input type="text" id="set-pass-admin" value="${s.passwordAdmin || 'admin'}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-rose-500 outline-none"></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Password Pengawas</label><input type="text" id="set-pass-pengawas" value="${s.passwordPengawas || 'pengawas'}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 focus:ring-2 focus:ring-rose-500 outline-none"></div>
                            </div>
                        </div>
                        <div class="bg-indigo-900 rounded-2xl p-6 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-bl-full -mr-10 -mt-10"></div>
                            <h4 class="font-bold text-lg mb-2 relative z-10"><i class="fas fa-database mr-2"></i>Database</h4>
                            <p class="text-indigo-200 text-xs mb-4 relative z-10">Amankan data aplikasi secara berkala.</p>
                            <div class="space-y-2 relative z-10">
                                <button onclick="downloadBackup()" class="w-full py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-sm font-bold transition-colors flex items-center justify-center gap-2"><i class="fas fa-download"></i> Backup JSON</button>
                                <button onclick="document.getElementById('restore-file').click()" class="w-full py-2 bg-emerald-500 hover:bg-emerald-400 text-white rounded-lg text-sm font-bold transition-colors flex items-center justify-center gap-2 shadow-lg"><i class="fas fa-upload"></i> Restore Data</button>
                                <input type="file" id="restore-file" class="hidden" accept=".json" onchange="restoreBackup(event)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderImageUpload(label, key, src) {
            return `
            <div class="flex items-center gap-3">
                <div class="w-14 h-14 border border-slate-200 bg-slate-50 rounded-lg flex items-center justify-center overflow-hidden shrink-0">
                    <img id="preview-${key}" src="${src || ''}" class="w-full h-full object-contain" onerror="this.style.display='none'">
                </div>
                <div class="flex-1 overflow-hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">${label}</label>
                    <input type="file" accept="image/*" onchange="handleFileSelect(event, '${key}')" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                    <input type="hidden" id="input-${key}-base64" value="${src}">
                </div>
            </div>`;
        }

        function renderRuangVirtual() {
            const r = window.activeExamSession;
            const isCheckedIn = !!r.waktuCheckIn;
            
            const studentRows = r.absensi.map((s, idx) => `
            <div class="flex items-center justify-between p-4 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors group">
                <div class="flex items-center gap-4">
                    <div class="w-8 h-8 rounded-lg bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold font-mono group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">${idx+1}</div>
                    <div><p class="font-bold text-slate-800 text-sm">${s.nama}</p><p class="text-xs text-slate-500 font-mono bg-slate-100 px-1.5 rounded inline-block mt-0.5">${s.noUjian}</p></div>
                </div>
                <div class="flex bg-white border border-slate-200 rounded-lg p-1 gap-1 shadow-sm">
                    ${['H','S','I','A'].map(k => {
                        const colors = {'H':'bg-emerald-500','S':'bg-blue-500','I':'bg-amber-500','A':'bg-rose-500'};
                        const active = s.status===k;
                        return `<button onclick="updateAttendance('${s.id}','${k}')" class="w-8 h-8 rounded-md text-xs font-bold transition-all ${active ? `${colors[k]} text-white shadow-md transform scale-105` : 'text-slate-400 hover:bg-slate-100'}">${k}</button>`;
                    }).join('')}
                </div>
            </div>`).join('');

            return `
            <div class="min-h-screen bg-slate-100 flex flex-col h-screen overflow-hidden">
                <header class="bg-indigo-900 text-white px-8 py-4 shadow-lg flex justify-between items-center shrink-0 z-30">
                    <div class="flex items-center gap-4">
                        <button onclick="exitExamRoom()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"><i class="fas fa-arrow-left"></i></button>
                        <div>
                            <div class="flex items-center gap-3 mb-0.5">
                                <h2 class="font-bold text-xl tracking-tight">${r.ruang}</h2>
                                <span class="bg-indigo-800/80 text-indigo-200 border border-indigo-700/50 text-[10px] px-2 py-0.5 rounded uppercase tracking-wider font-bold">Virtual Room</span>
                            </div>
                            <p class="text-indigo-300 text-sm font-medium flex items-center gap-2"><i class="fas fa-book-open"></i> ${r.mapel}</p>
                        </div>
                    </div>
                    <div>
                        ${isCheckedIn 
                            ? `<div class="bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg backdrop-blur-sm"><i class="fas fa-clock"></i> Masuk: ${r.waktuCheckIn}</div>` 
                            : `<button onclick="performCheckIn()" class="check-in-pulse bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2"><i class="fas fa-fingerprint text-lg"></i> CHECK-IN KEHADIRAN</button>`
                        }
                    </div>
                </header>

                <main class="flex-1 flex overflow-hidden">
                    <!-- Left: Attendance -->
                    <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scrollbar">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center backdrop-blur-sm sticky top-0 z-10">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-users text-indigo-500"></i> Absensi Peserta</h3>
                                <span class="text-xs font-bold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">${r.absensi.length} Siswa</span>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${studentRows}
                            </div>
                        </div>
                    </div>

                    <!-- Right: Log & Actions -->
                    <div class="w-96 bg-white border-l border-slate-200 flex flex-col shrink-0 shadow-xl z-20">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-1"><i class="fas fa-file-signature text-amber-500"></i> Berita Acara</h3>
                            <p class="text-xs text-slate-500">Catat kejadian penting selama ujian.</p>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto custom-scrollbar bg-slate-50/50">
                            <textarea oninput="updateBeritaAcara(this.value)" class="w-full h-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm leading-relaxed resize-none bg-white shadow-sm transition-all placeholder:text-slate-400" placeholder="Tuliskan catatan kejadian di sini... (Contoh: Naskah kurang, siswa sakit, dll). Jika nihil, tulis 'NIHIL'.">${r.beritaAcara}</textarea>
                        </div>
                        <div class="p-6 border-t border-slate-100 bg-white space-y-3">
                            <button onclick="finishExamSession()" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-save"></i> Simpan & Selesai</button>
                        </div>
                    </div>
                </main>
            </div>`;
        }

        function renderDashboardPengawas() {
            const mySchedules = (window.appData.jadwalPengawas||[]).filter(j => j.pengawas === window.currentUser.name);
            mySchedules.sort((a,b) => a.tanggal.localeCompare(b.tanggal) || a.waktu.localeCompare(b.waktu));

            let contentHTML = '';
            if(mySchedules.length === 0) {
                contentHTML = `
                <div class="flex flex-col items-center justify-center h-96 text-center">
                    <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6"><i class="fas fa-calendar-check text-4xl text-slate-300"></i></div>
                    <h3 class="text-xl font-bold text-slate-700 mb-2">Tidak Ada Jadwal</h3>
                    <p class="text-slate-500 max-w-sm">Anda belum memiliki jadwal mengawas untuk saat ini. Silakan hubungi panitia jika ini adalah kesalahan.</p>
                </div>`;
            } else {
                contentHTML = `<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 fade-in">${mySchedules.map(s => { 
                    const report = window.appData.laporanUjian.find(l => l.jadwalId === s.id);
                    const isDone = report && report.status === 'Selesai';
                    const mapelIcon = s.mapel.toLowerCase().includes('mat') ? 'fa-calculator' : (s.mapel.toLowerCase().includes('ipa') ? 'fa-flask' : 'fa-book');
                    
                    return `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 relative overflow-hidden group hover:border-indigo-300 transition-all hover:shadow-md">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl font-bold shadow-sm group-hover:scale-110 transition-transform"><i class="fas ${mapelIcon}"></i></div>
                                <div><h4 class="font-bold text-slate-800 text-lg leading-tight line-clamp-1">${s.mapel}</h4><p class="text-xs text-slate-500 font-bold bg-slate-100 px-2 py-0.5 rounded inline-block mt-1">${s.ruang}</p></div>
                            </div>
                            ${isDone ? '<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider flex items-center gap-1"><i class="fas fa-check-circle"></i> Selesai</span>' : '<span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider flex items-center gap-1"><i class="fas fa-clock"></i> Pending</span>'}
                        </div>
                        <div class="space-y-3 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <div class="flex items-center gap-3 text-sm text-slate-600"><i class="far fa-calendar text-indigo-400 w-5 text-center"></i><span class="font-medium">${s.tanggal}</span></div>
                            <div class="flex items-center gap-3 text-sm text-slate-600"><i class="far fa-clock text-indigo-400 w-5 text-center"></i><span class="font-medium">${s.waktu}</span></div>
                        </div>
                        <button onclick="${isDone?'':'enterExamRoom(\''+s.id+'\')'}" class="w-full py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${isDone?'bg-slate-100 text-slate-400 cursor-not-allowed':'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200 active:scale-95'}">${isDone ? 'Tugas Selesai' : 'Masuk Ruang Ujian <i class="fas fa-arrow-right"></i>'}</button>
                    </div>`; 
                }).join('')}</div>`;
            }

            return `
            <div class="min-h-screen bg-slate-50 flex flex-col">
                <header class="glass-header px-8 py-4 flex justify-between items-center sticky top-0 z-20">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 text-white flex items-center justify-center font-bold text-lg shadow-lg shadow-indigo-500/30"><i class="fas fa-user-shield"></i></div>
                        <div><h1 class="font-bold text-slate-800 leading-tight text-lg">${window.currentUser.name}</h1><p class="text-xs text-slate-500 font-medium">Portal Pengawas</p></div>
                    </div>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-xl bg-red-50 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all" title="Keluar"><i class="fas fa-power-off"></i></button>
                </header>
                <main class="flex-1 p-8 max-w-7xl mx-auto w-full custom-scrollbar">
                    <div class="mb-8"><h2 class="text-2xl font-bold text-slate-800">Jadwal Mengawas</h2><p class="text-slate-500">Kelola kehadiran dan berita acara ujian.</p></div>
                    ${contentHTML}
                </main>
            </div>`;
        }

        function renderPaktaIntegritas() {
            return `
            <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-64 bg-indigo-600 transform -skew-y-3 origin-top-left z-0"></div>
                <div class="bg-white max-w-2xl w-full rounded-3xl shadow-2xl overflow-hidden relative z-10 fade-in border border-slate-100">
                    <div class="px-8 py-8 text-center bg-white border-b border-slate-100">
                        <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fas fa-file-contract"></i></div>
                        <h2 class="text-2xl font-extrabold text-slate-800 tracking-tight">Pakta Integritas</h2>
                        <p class="text-slate-500 mt-2 text-sm font-medium">Pengawas Ruang Ujian</p>
                    </div>
                    <div class="p-8 space-y-6 max-h-[50vh] overflow-y-auto custom-scrollbar bg-slate-50/50">
                        <p class="text-slate-700 font-medium leading-relaxed">Demi menjamin kredibilitas dan integritas pelaksanaan asesmen, saya yang bertanda tangan secara digital di bawah ini menyatakan sanggup:</p>
                        <ul class="space-y-4">
                            <li class="flex gap-4 items-start"><div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">1</div><p class="text-sm text-slate-600 leading-relaxed">Hadir di lokasi ujian selambat-lambatnya 30 menit sebelum jadwal dimulai.</p></li>
                            <li class="flex gap-4 items-start"><div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">2</div><p class="text-sm text-slate-600 leading-relaxed">Memeriksa kelengkapan ruang ujian dan memastikan kerapihan tempat duduk peserta sesuai denah.</p></li>
                            <li class="flex gap-4 items-start"><div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">3</div><p class="text-sm text-slate-600 leading-relaxed">Mengawasi jalannya ujian dengan tertib, jujur, dan penuh tanggung jawab.</p></li>
                            <li class="flex gap-4 items-start"><div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">4</div><p class="text-sm text-slate-600 leading-relaxed">Tidak membawa alat komunikasi (HP) ke dalam ruang ujian saat mengawas.</p></li>
                            <li class="flex gap-4 items-start"><div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">5</div><p class="text-sm text-slate-600 leading-relaxed">Mencatat segala kejadian luar biasa pada Berita Acara Pelaksanaan Ujian.</p></li>
                        </ul>
                    </div>
                    <div class="p-6 bg-white border-t border-slate-100 flex justify-between items-center gap-4">
                        <button onclick="location.reload()" class="px-6 py-3 text-slate-500 hover:text-slate-700 font-bold text-sm transition-colors">Batalkan</button>
                        <button onclick="signIntegrityPact()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center gap-2"><span>Saya Menyetujui</span><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>`;
        }

        window.signIntegrityPact = () => { window.integrityPactSigned = true; renderApp(); };

        // --- GLOBAL HELPERS (MUST BE DEFINED AFTER RENDER FUNCTIONS) ---
        window.handleSearch = () => { const term = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('#dataTable tbody tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); };
        window.changeDashboardView = (v) => { window.dashboardState.view = v; document.getElementById('main-content').innerHTML = renderDashboard(); };
        window.changeDashboardFilter = () => { window.dashboardState.date = document.getElementById('filter-tanggal').value; document.getElementById('main-content').innerHTML = renderDashboard(); };
        window.toggleAllSiswa = (src) => { document.querySelectorAll('.student-cb').forEach(cb => cb.checked = src.checked); };
        window.downloadTemplate = () => { const data = [{ "NISN": "001", "Nama Lengkap": "Contoh", "Kelas": "7A" }]; const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Template.xlsx"); };
        
        window.handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            window.showToast("Membaca file...", "info");

            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) { window.showToast("File kosong!", "error"); return; }

                    const batchSize = 400; 
                    let batch = writeBatch(db);
                    let count = 0;
                    let total = 0;

                    for (const row of jsonData) {
                        const newSiswa = {
                            nisn: String(row['NISN'] || row['nisn'] || ''),
                            nama: row['Nama'] || row['nama'] || row['Nama Lengkap'] || '',
                            kelas: String(row['Kelas'] || row['kelas'] || ''),
                            noUjian: row['No Ujian'] || '',
                            ruang: row['Ruang'] || ''
                        };

                        if (!newSiswa.nama) continue; 

                        const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'siswa'));
                        batch.set(ref, newSiswa);
                        count++;
                        total++;

                        if (count >= batchSize) {
                            await batch.commit();
                            batch = writeBatch(db);
                            count = 0;
                            window.showToast(`Mengupload ${total} data...`, "info");
                        }
                    }

                    if (count > 0) await batch.commit();
                    window.showToast(`Selesai! ${total} siswa diimpor.`, "success");
                    e.target.value = '';

                } catch (err) {
                    console.error(err);
                    window.showToast("Gagal import: " + err.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.generateNoUjian = async () => {
            const selectedCb = document.querySelectorAll('.student-cb:checked');
            if (selectedCb.length === 0 && !confirm("Generate semua siswa?")) return;
            
            window.showToast("Sedang generate...", "info");
            const format = window.appData.settings.formatNoUjian || "UJN-{YY}-{NO}";
            const yy = new Date().getFullYear().toString().slice(-2);
            
            const batch = writeBatch(db);
            let counter = 1;
            
            const targets = selectedCb.length > 0 
                ? Array.from(selectedCb).map(c => window.appData.siswa.find(s => s.id === c.value))
                : window.appData.siswa;

            targets.forEach(s => {
                if (s) {
                    const no = format.replace('{YY}', yy).replace('{NO}', counter.toString().padStart(3, '0'));
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'siswa', s.id);
                    batch.update(ref, { noUjian: no });
                    counter++;
                }
            });

            try {
                await batch.commit();
                window.showToast("Nomor ujian berhasil digenerate!", "success");
            } catch(e) {
                window.showToast("Gagal generate.", "error");
            }
        };

        window.openMappingModal = () => { 
            const selected = document.querySelectorAll('.student-cb:checked'); 
            if(selected.length===0){window.showToast("Pilih siswa dulu","error"); return;} 
            document.getElementById('modal-title').innerText="Mapping Ruang"; 
            const opts = window.appData.ruang.map(r=>`<option value="${r.nama}">${r.nama}</option>`).join(''); 
            document.getElementById('modal-content').innerHTML=`<form onsubmit="processMapping(event, '${Array.from(selected).map(c=>c.value).join(',')}')" class="space-y-4"><select id="map-room" class="w-full border p-3 rounded-xl"><option value="">Pilih Ruang</option>${opts}<option value="reset">Reset Ruang</option></select><button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Simpan</button></form>`; 
            window.openModal(); 
        };

        window.processMapping = async (e, ids) => {
            e.preventDefault();
            const room = document.getElementById('map-room').value;
            const idArr = ids.split(',');
            const batch = writeBatch(db);
            
            idArr.forEach(id => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'siswa', id);
                batch.update(ref, { ruang: room === 'reset' ? '' : room });
            });
            
            await batch.commit();
            window.closeModal();
            window.showToast("Mapping tersimpan di cloud.", "success");
        };

        window.resetUjian = async () => {
            if(!confirm("Reset No Ujian & Ruang semua siswa?")) return;
            const batch = writeBatch(db);
            window.appData.siswa.forEach(s => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'siswa', s.id);
                batch.update(ref, { noUjian: "", ruang: "" });
            });
            await batch.commit();
            window.showToast("Data direset.", "success");
        };

        window.generateDistribusiPengawas = async () => {
            const jadwalList = window.appData.jadwal;
            const ruangList = window.appData.ruang;
            const guruList = window.appData.guru.filter(g => g.statusMengawas !== 'Pengecualian (Kondisi Khusus)');

            if (!jadwalList.length || !ruangList.length || !guruList.length) {
                window.showToast("Data master belum lengkap!", "error");
                return;
            }

            if (!confirm("Generate Jadwal Pengawas? Data lama akan ditimpa.")) return;

            const lockedRooms = ruangList.filter(r => r.isLocked === 'Ya (Kunci Manual)');
            const lockedTeachersNames = lockedRooms.map(r => r.pengawas);
            let floatingTeachers = guruList.filter(g => !lockedTeachersNames.includes(g.nama)).map(g => g.nama);
            
            floatingTeachers.sort(() => 0.5 - Math.random());
            
            const batch = writeBatch(db);
            const sortedJadwal = [...jadwalList].sort((a, b) => a.tanggal.localeCompare(b.tanggal) || a.waktu.localeCompare(b.waktu));

            sortedJadwal.forEach((sesi, indexSesi) => {
                if (indexSesi > 0) floatingTeachers.push(floatingTeachers.shift());
                let sessionTeachers = [...floatingTeachers];

                ruangList.forEach(ruang => {
                    let assignedGuru = '';
                    if (ruang.isLocked === 'Ya (Kunci Manual)') {
                        assignedGuru = ruang.pengawas;
                    } else {
                        assignedGuru = sessionTeachers.length > 0 ? sessionTeachers.shift() : 'KURANG PENGAWAS';
                    }

                    const newDoc = doc(collection(db, 'artifacts', appId, 'public', 'data', 'jadwalPengawas'));
                    batch.set(newDoc, {
                        tanggal: sesi.tanggal,
                        waktu: sesi.waktu,
                        mapel: sesi.mapel,
                        ruang: ruang.nama,
                        pengawas: assignedGuru
                    });
                });
            });

            await batch.commit();
            window.showToast("Jadwal Pengawas Tergenerate di Cloud!", "success");
            window.navigateToPage('distribusi');
        };

        window.generatePengawas = async () => {
            if(!confirm("Acak ulang PJ Ruang di Cloud?")) return;
            const batch = writeBatch(db);
            
            const lockedRooms = window.appData.ruang.filter(r => r.isLocked === 'Ya (Kunci Manual)');
            const usedTeachers = new Set(lockedRooms.map(r => r.pengawas));
            const availableTeachers = window.appData.guru.filter(g => g.statusMengawas === 'Aktif' && !usedTeachers.has(g.nama)).map(g => g.nama);
            
            availableTeachers.sort(() => Math.random() - 0.5);
            let teacherIdx = 0;

            window.appData.ruang.forEach(r => {
                if (r.isLocked !== 'Ya (Kunci Manual)') {
                    const guru = teacherIdx < availableTeachers.length ? availableTeachers[teacherIdx++] : "KURANG GURU";
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'ruang', r.id);
                    batch.update(ref, { pengawas: guru });
                }
            });

            await batch.commit();
            window.showToast("PJ Ruang berhasil diacak!", "success");
        };

        window.configurePrint = (type) => { 
            const rooms = [...new Set(window.appData.siswa.map(s => s.ruang).filter(Boolean))].sort();
            const date = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
            const html = `
            <div class="space-y-4">
                ${!['distribusi', 'ba-ljk', 'ba-soal', 'ba-guru'].includes(type) ?`<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Filter Ruang</label><select id="print-room-filter" class="w-full border border-slate-300 rounded-xl p-3 bg-slate-50 outline-none"><option value="all">Semua Ruang</option>${rooms.map(r=>`<option value="${r}">${r}</option>`).join('')}</select></div>`:''}
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Titimangsa</label><input type="text" id="print-date-input" value="${date}" class="w-full border border-slate-300 rounded-xl p-3 bg-slate-50 outline-none"></div>
                <div class="flex justify-end gap-2 pt-4">
                    <button onclick="closeModal()" class="px-5 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">Batal</button>
                    <button onclick="runPrint('${type}')" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors">Print Preview</button>
                </div>
            </div>`;
            document.getElementById('modal-title').innerText = `Cetak ${type.replace(/-/g,' ').toUpperCase()}`;
            document.getElementById('modal-content').innerHTML = html; 
            window.openModal();
        };

        window.runPrint = (t) => { const f = document.getElementById('print-room-filter')?.value||'all'; const d = document.getElementById('print-date-input').value; window.closeModal(); window.executePrint(t, f, d); };

        window.executePrint = (type, roomFilter, customDate) => {
            const s = window.appData.settings; const date = customDate;
            const logo = s.logo ? `<img src="${s.logo}" class="w-8 h-8 object-contain">` : ''; 
            const ttd = s.ttd ? `<img src="${s.ttd}" class="absolute bottom-1 left-1/2 -translate-x-1/2 h-12 object-contain" style="z-index:0">` : '';
            const cap = s.cap ? `<img src="${s.cap}" class="absolute bottom-1 left-0 h-16 object-contain opacity-80" style="z-index:1">` : '';
            let html = '';

            if(type === 'distribusi') {
                const data = window.appData.jadwalPengawas;
                const grp = {}; data.forEach(d => { if(!grp[d.tanggal]) grp[d.tanggal]=[]; grp[d.tanggal].push(d); });
                Object.keys(grp).forEach(t => {
                    grp[t].sort((a,b) => a.waktu.localeCompare(b.waktu) || a.ruang.localeCompare(b.ruang));
                    html += `<div class="mb-8 break-inside-avoid"><div class="text-center mb-4 pb-2 border-b-2 border-black"><h2 class="font-bold text-xl uppercase">${s.namaSekolah}</h2><p>JADWAL PENGAWAS - ${s.semester} ${s.tahunAjaran}</p></div><h3 class="font-bold mb-2">Tanggal: ${t}</h3><table class="w-full border-collapse border border-black text-sm mb-4"><thead class="bg-gray-200"><tr><th class="border border-black p-1">Waktu</th><th class="border border-black p-1">Mapel</th><th class="border border-black p-1">Ruang</th><th class="border border-black p-1">Pengawas</th></tr></thead><tbody>${grp[t].map(d=>`<tr><td class="border border-black p-1">${d.waktu}</td><td class="border border-black p-1">${d.mapel}</td><td class="border border-black p-1 text-center font-bold">${d.ruang}</td><td class="border border-black p-1">${d.pengawas}</td></tr>`).join('')}</tbody></table><div class="flex justify-end mt-8"><div class="text-center min-w-[150px]"><p class="text-sm">${s.kota}, ${date}</p><p class="text-sm font-bold mb-12">Kepala Sekolah,</p><p class="text-sm font-bold underline uppercase">${s.kepsek}</p><p class="text-sm">NIP. ${s.nipKepsek}</p></div></div></div>`;
                });
            } else if (type === 'hadir-pengawas') {
                let schedules = window.appData.jadwalPengawas || [];
                if (roomFilter !== 'all') schedules = schedules.filter(s => s.ruang === roomFilter);
                schedules.sort((a,b) => a.tanggal.localeCompare(b.tanggal) || a.waktu.localeCompare(b.waktu) || a.ruang.localeCompare(b.ruang));
                if (schedules.length === 0) { window.showToast("Belum ada jadwal pengawas.", "error"); return; }
                schedules.forEach(sch => {
                     const guru = window.appData.guru.find(g => g.nama === sch.pengawas);
                     const nip = guru ? guru.nip : '-';
                     const record = window.appData.laporanUjian.find(l => l.jadwalId === sch.id || (l.ruang === sch.ruang && l.mapel === sch.mapel && l.tanggal === sch.tanggal && l.waktu === sch.waktu));
                     const checkInText = (record && record.waktuCheckIn) ? `<div class='text-center'><span class='font-bold text-xs bg-slate-100 px-2 py-1 border border-slate-300 rounded'>DIGITAL CHECK-IN</span><br><span class='text-[10px]'>${record.waktuCheckIn}</span></div>` : '1. ....................';
                     html += `<div class="break-after-page p-8 border border-slate-200" style="height: 100vh;"><div class="flex items-center gap-4 mb-4 border-b-2 border-black pb-4"><div class="w-16 h-16 flex items-center justify-center">${logo.replace('w-8','w-16')}</div><div class="flex-1 text-center"><h2 class="font-bold text-xl uppercase">${s.namaDinas}</h2><h1 class="font-bold text-2xl uppercase">${s.namaSekolah}</h1><p>${s.alamat}</p></div></div><div class="text-center mb-8"><h2 class="font-bold text-lg uppercase underline">DAFTAR HADIR PENGAWAS RUANG</h2><p class="font-bold uppercase">${s.semester} / ${s.tahunAjaran}</p></div><table class="w-full text-sm font-medium mb-6"><tr><td class="w-32 py-1">Hari, Tanggal</td><td>: ${sch.tanggal}</td></tr><tr><td class="py-1">Waktu</td><td>: ${sch.waktu}</td></tr><tr><td class="py-1">Mata Pelajaran</td><td>: ${sch.mapel}</td></tr><tr><td class="py-1">Ruang</td><td>: ${sch.ruang}</td></tr></table><table class="w-full border-collapse border border-black text-sm mb-8"><thead><tr class="bg-gray-100"><th class="border border-black p-3 w-12">No</th><th class="border border-black p-3">Nama Pengawas</th><th class="border border-black p-3">NIP</th><th class="border border-black p-3 w-40">Tanda Tangan</th></tr></thead><tbody><tr><td class="border border-black p-4 text-center">1</td><td class="border border-black p-4 font-bold uppercase">${sch.pengawas}</td><td class="border border-black p-4 text-center">${nip}</td><td class="border border-black p-4 align-bottom h-24 text-center align-middle">${checkInText}</td></tr><tr><td class="border border-black p-4 text-center">2</td><td class="border border-black p-4 text-slate-400 italic">(Cadangan/Pendamping)</td><td class="border border-black p-4 text-center">-</td><td class="border border-black p-4 align-bottom h-24">2. ....................</td></tr></tbody></table><div class="flex justify-end mt-12"><div class="text-center w-64"><p class="text-sm mb-20">${s.kota}, ${sch.tanggal}<br>Ketua Panitia,</p><p class="font-bold border-b border-black inline-block min-w-[150px]"></p><p class="text-xs mt-1">NIP. ..........................</p></div></div></div>`;
                });
            } else if (type === 'ba-guru') {
                const schedules = window.appData.jadwalPengawas || [];
                const groupedByMapel = {};
                schedules.forEach(sc => { if(!groupedByMapel[sc.mapel]) groupedByMapel[sc.mapel] = []; groupedByMapel[sc.mapel].push(sc); });
                Object.keys(groupedByMapel).sort().forEach(mapel => {
                    const sessionData = groupedByMapel[mapel].sort((a,b) => a.ruang.localeCompare(b.ruang));
                    const tgl = sessionData[0].tanggal; 
                    html += `<div class="break-after-page p-8 border border-slate-200 min-h-screen"><div class="flex items-center gap-4 mb-4 border-b-2 border-black pb-4"><div class="w-16 h-16 flex items-center justify-center">${logo.replace('w-8','w-16')}</div><div class="flex-1 text-center"><h2 class="font-bold text-xl uppercase">${s.namaDinas}</h2><h1 class="font-bold text-2xl uppercase">${s.namaSekolah}</h1><p>${s.alamat}</p></div></div><div class="text-center mb-6"><h2 class="font-bold text-lg uppercase underline">DAFTAR SERAH TERIMA LJK KE GURU MAPEL</h2><p class="font-bold uppercase">TAHUN PELAJARAN ${s.tahunAjaran}</p></div><div class="mb-4 text-sm font-bold uppercase"><table class="w-full"><tr><td class="w-32">Mata Pelajaran</td><td>: ${mapel}</td></tr><tr><td>Hari/Tanggal</td><td>: ${tgl}</td></tr></table></div><table class="w-full border-collapse border border-black text-sm"><thead><tr class="bg-gray-100"><th class="border border-black p-2 w-10">No</th><th class="border border-black p-2">Ruang Ujian</th><th class="border border-black p-2">Kelas</th><th class="border border-black p-2 w-32">Jml Lembar</th><th class="border border-black p-2">Keterangan</th></tr></thead><tbody>${sessionData.map((d, i) => {
                        const sampleSiswa = window.appData.siswa.find(s => s.ruang === d.ruang);
                        const kelas = sampleSiswa ? sampleSiswa.kelas : '-';
                        const report = window.appData.laporanUjian.find(l => l.jadwalId === d.id || (l.ruang === d.ruang && l.mapel === d.mapel && l.tanggal === d.tanggal && l.waktu === d.waktu));
                        const count = report ? report.absensi.filter(a => a.status === 'H').length : '';
                        const ket = count ? 'Lengkap' : '';
                        return `<tr><td class="border border-black p-2 text-center">${i+1}</td><td class="border border-black p-2 font-bold text-center">${d.ruang}</td><td class="border border-black p-2 text-center">${kelas}</td><td class="border border-black p-2 text-center font-bold">${count}</td><td class="border border-black p-2 text-center">${ket}</td></tr>`;
                    }).join('')}</tbody></table><div class="mt-12 flex justify-between"><div class="text-center w-64"><p class="text-sm mb-20">Yang Menyerahkan<br>Panitia,</p><p class="font-bold border-b border-black inline-block min-w-[150px]"></p></div><div class="text-center w-64"><p class="text-sm mb-20">${s.kota}, ${date}<br>Yang Menerima<br>Guru Mata Pelajaran,</p><p class="font-bold border-b border-black inline-block min-w-[150px]"></p><p class="text-xs mt-1">NIP. ..........................</p></div></div></div>`;
                });
            } else if (type === 'label-ruang') {
                let roomsToPrint = [...new Set(window.appData.siswa.map(s => s.ruang).filter(Boolean))].sort();
                if (roomFilter !== 'all') roomsToPrint = [roomFilter];
                html = `<div class="w-full">`;
                roomsToPrint.forEach(r => {
                    const students = window.appData.siswa.filter(s => s.ruang === r).sort((a,b) => a.noUjian.localeCompare(b.noUjian));
                    let range = "Tidak ada peserta";
                    if(students.length > 0) { const first = students[0].noUjian.split('-').pop(); const last = students[students.length-1].noUjian.split('-').pop(); range = `${first} s.d ${last}`; }
                    html += `<div class="break-after-page border-8 border-slate-800 p-8 flex flex-col items-center justify-center text-center h-[95vh] relative bg-white"><div class="absolute top-8 left-8 w-24 opacity-80">${logo.replace('w-8 h-8', 'w-full')}</div><h2 class="text-2xl font-bold uppercase tracking-widest text-slate-600 mb-8 mt-4">${s.namaSekolah}</h2><div class="flex-1 flex flex-col justify-center w-full"><h1 class="text-[12rem] font-black leading-none text-slate-900 mb-4 tracking-tighter">${r.replace('Ruang ', '')}</h1><div class="bg-slate-900 text-white py-4 px-12 rounded-full mx-auto mb-12"><h2 class="text-4xl font-bold uppercase tracking-widest">RUANG UJIAN</h2></div></div><div class="w-full border-t-4 border-slate-200 pt-8"><p class="text-xl text-slate-500 font-bold uppercase mb-2">NOMOR PESERTA</p><p class="text-5xl font-mono font-bold text-indigo-700">${range}</p><p class="text-lg text-slate-400 mt-4 font-bold">JML PESERTA: ${students.length} ORANG</p></div></div>`;
                });
                html += `</div>`;
            } else {
                // ... Existing Logic for Kartu, Hadir Siswa, Label Meja ...
                let list = window.appData.siswa.filter(x => x.noUjian && x.ruang);
                if(roomFilter !== 'all') list = list.filter(x => x.ruang === roomFilter);
                if(!list.length) { window.showToast("Data kosong.", "error"); return; }
                const jadwalList = window.appData.jadwal || [];
                const jadwalText = jadwalList.length > 0 ? jadwalList.map((j, i) => `${i+1}. ${j.mapel}\n   ${j.tanggal} (${j.waktu})`).join('\n') : '- Belum ada jadwal';
                if(type === 'kartu') {
                    html = `<div class="grid grid-cols-2 gap-x-4 gap-y-3">`;
                    list.forEach(sis => { const qrContent = `IDENTITAS PESERTA\nNama: ${sis.nama.toUpperCase()}\nNo Ujian: ${sis.noUjian}\nRuang: ${sis.ruang}\nNISN: ${sis.nisn}\n\nJADWAL UJIAN:\n${jadwalText}`; const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(qrContent)}`; html += `<div class="border border-slate-900 p-2 break-inside-avoid flex flex-col bg-white relative shadow-sm" style="height: 6.5cm; width: 100%;"><div class="flex items-center border-b border-slate-900 pb-1 mb-1.5 gap-2"><div class="w-10 h-10 flex items-center justify-center shrink-0">${logo}</div><div class="flex-1 text-center leading-none"><p class="text-[7px] font-bold uppercase text-slate-600 mb-0.5">${s.namaDinas}</p><h2 class="font-bold text-[10px] uppercase text-slate-900 my-0.5 scale-y-105">${s.namaSekolah}</h2><div class="bg-slate-900 text-white text-[7px] font-bold px-2 py-0.5 rounded-sm inline-block uppercase">KARTU PESERTA</div></div></div><div class="flex gap-2 items-start flex-1 overflow-hidden"><div class="w-16 h-16 border flex items-center justify-center shrink-0 mt-1 p-0.5"><img src="${qr}" class="w-full h-full object-contain"></div><table class="text-[9px] w-full font-medium leading-snug"><tr><td class="w-12">No</td><td>:</td><td class="font-bold">${sis.noUjian}</td></tr><tr><td>Nama</td><td>:</td><td class="font-bold uppercase">${sis.nama}</td></tr><tr><td>NISN</td><td>:</td><td>${sis.nisn}</td></tr><tr><td>Ruang</td><td>:</td><td>${sis.ruang}</td></tr></table></div><div class="flex justify-between items-end mt-1"><div class="text-[6px] italic">Scan QR untuk Jadwal<br>Tgl: ${date}</div><div class="text-center min-w-[80px] leading-none"><p class="text-[7px] mb-0.5">${s.kota}, ${date}</p><p class="text-[7px] font-bold mb-5">Kepala Sekolah,</p><div class="relative h-8 w-full">${ttd}${cap}</div><p class="text-[8px] font-bold underline uppercase relative z-10">${s.kepsek}</p></div></div></div>`; });
                    html += `</div>`;
                } else if (type === 'hadir-siswa') {
                    const rms = [...new Set(list.map(x=>x.ruang))].sort();
                    rms.forEach(r => { const sub = list.filter(x=>x.ruang===r).sort((a,b)=>a.noUjian.localeCompare(b.noUjian)); html += `<div class="break-after-page mb-8"><div class="flex items-center gap-4 mb-4 border-b-2 border-black pb-4"><div class="w-16 h-16 flex items-center justify-center">${logo.replace('w-8','w-16')}</div><div class="flex-1 text-center"><h2 class="font-bold text-xl uppercase">${s.namaDinas}</h2><h1 class="font-bold text-2xl uppercase">${s.namaSekolah}</h1><p>${s.alamat}</p></div></div><div class="text-center mb-6"><h2 class="font-bold text-lg uppercase bg-slate-200 inline-block px-4 py-1">DAFTAR HADIR PESERTA</h2><div class="flex justify-center gap-8 mt-2 text-sm font-bold"><p>RUANG: ${r}</p><p>TAHUN: ${s.tahunAjaran}</p><p>SEMESTER: ${s.semester.toUpperCase()}</p></div></div><table class="w-full border-collapse border border-black text-sm"><thead><tr class="bg-gray-100"><th class="border border-black p-2 w-10">No</th><th class="border border-black p-2">No Ujian</th><th class="border border-black p-2">Nama</th><th class="border border-black p-2" colspan="2">Tanda Tangan</th></tr></thead><tbody>${sub.map((x,i)=>`<tr><td class="border border-black p-2 text-center">${i+1}</td><td class="border border-black p-2">${x.noUjian}</td><td class="border border-black p-2 uppercase">${x.nama}</td><td class="border border-black p-2 w-24 text-xs align-top">${i%2===0?i+1+'.':''}</td><td class="border border-black p-2 w-24 text-xs align-top">${i%2!==0?i+1+'.':''}</td></tr>`).join('')}</tbody></table><div class="mt-8 flex justify-end"><div class="text-center w-64"><p class="text-sm mb-20">${s.kota}, ${date}<br>Pengawas Ruang,</p><p class="font-bold border-b border-black">....................................</p></div></div></div>`; });
                } else if (type === 'label-meja') {
                    html = `<div class="grid grid-cols-2 gap-6">`;
                    const ruanganLabel = [...new Set(list.map(x => x.ruang))].sort();
                    ruanganLabel.forEach(r => { const siswaDiRuang = list.filter(x => x.ruang === r).sort((a, b) => a.noUjian.localeCompare(b.noUjian)); siswaDiRuang.forEach((sis, index) => { const nomorUrut = index + 1; html += `<div class="border-4 border-slate-800 p-6 rounded-2xl break-inside-avoid text-center relative overflow-hidden bg-white"><div class="absolute top-0 right-0 bg-slate-800 text-white font-bold px-6 py-2 rounded-bl-xl text-lg z-10">${sis.ruang}</div><div class="absolute top-4 left-4 w-16 opacity-30">${logo.replace('w-8 h-8', 'w-full')}</div><h2 class="font-bold text-lg mb-2 mt-4 tracking-widest text-slate-500 uppercase">NOMOR MEJA</h2><div class="border-y-4 border-slate-800 py-4 my-2 bg-slate-50"><p class="text-7xl font-black tracking-tighter text-slate-900">${nomorUrut.toString().padStart(2, '0')}</p></div><div class="mt-4"><h3 class="font-bold text-xl uppercase truncate text-slate-800 mb-1 leading-tight">${sis.nama}</h3><p class="text-sm font-bold text-indigo-700 font-mono mb-1">${sis.noUjian}</p><span class="inline-block bg-slate-800 text-white text-xs font-bold px-3 py-1 rounded-full">Kelas ${sis.kelas}</span></div></div>`; }); });
                    html += `</div>`;
                } else if (type === 'ba-ljk' || type === 'ba-soal') {
                    const isLJK = type === 'ba-ljk';
                    const title = isLJK ? 'DAFTAR SERAH TERIMA LJK' : 'DAFTAR SERAH TERIMA NASKAH SOAL';
                    const col3 = isLJK ? 'Jml LJK (Isi)' : 'Jml Amplop';
                    const col4 = isLJK ? 'Jml LJK (Kosong)' : 'Jml Naskah';
                    const signer1 = isLJK ? 'Pengawas (Menyerahkan)' : 'Pengawas (Menerima)';
                    const signer2 = isLJK ? 'Panitia (Menerima)' : 'Panitia (Menyerahkan)';
                    const schedules = window.appData.jadwalPengawas || [];
                    const grouped = {};
                    schedules.forEach(sc => { const key = `${sc.tanggal}||${sc.waktu}`; if(!grouped[key]) grouped[key] = []; grouped[key].push(sc); });
                    Object.keys(grouped).sort().forEach(key => {
                        const [tgl, wkt] = key.split('||');
                        const sessionData = grouped[key].sort((a,b) => a.ruang.localeCompare(b.ruang));
                        html += `<div class="break-after-page p-8 border border-slate-200 min-h-screen"><div class="flex items-center gap-4 mb-4 border-b-2 border-black pb-4"><div class="w-16 h-16 flex items-center justify-center">${logo.replace('w-8','w-16')}</div><div class="flex-1 text-center"><h2 class="font-bold text-xl uppercase">${s.namaDinas}</h2><h1 class="font-bold text-2xl uppercase">${s.namaSekolah}</h1><p>${s.alamat}</p></div></div><div class="text-center mb-6"><h2 class="font-bold text-lg uppercase underline">${title}</h2><p class="font-bold uppercase">TAHUN PELAJARAN ${s.tahunAjaran}</p></div><div class="flex justify-between text-sm font-bold mb-4 uppercase"><p>HARI/TANGGAL: ${tgl}</p><p>PUKUL: ${wkt}</p></div><table class="w-full border-collapse border border-black text-sm"><thead><tr class="bg-gray-100"><th class="border border-black p-2 w-10">No</th><th class="border border-black p-2">Ruang</th><th class="border border-black p-2">Mata Pelajaran</th><th class="border border-black p-2 w-24">${col3}</th><th class="border border-black p-2 w-24">${col4}</th><th class="border border-black p-2 w-32">${signer1}</th><th class="border border-black p-2 w-32">${signer2}</th></tr></thead><tbody>${sessionData.map((d, i) => `<tr><td class="border border-black p-2 text-center">${i+1}</td><td class="border border-black p-2 font-bold text-center">${d.ruang}</td><td class="border border-black p-2">${d.mapel}</td><td class="border border-black p-2"></td><td class="border border-black p-2"></td><td class="border border-black p-2"></td><td class="border border-black p-2"></td></tr>`).join('')}</tbody></table><div class="mt-8 text-sm"><p>Catatan: ${isLJK ? 'Pastikan LJK disusun urut sesuai Nomor Peserta.' : 'Cek kondisi segel amplop sebelum dibuka.'}</p></div><div class="flex justify-end mt-8"><div class="text-center w-64"><p class="text-sm mb-20">${s.kota}, ${date}<br>Koordinator Ujian,</p><p class="font-bold border-b border-black inline-block min-w-[150px]"></p></div></div></div>`;
                    });
                }
            }

            const pa = document.getElementById('print-area'); const aa = document.getElementById('app');
            pa.innerHTML = html; aa.classList.add('hidden'); pa.classList.remove('hidden');
            setTimeout(() => window.print(), 800);
        };

        window.addEventListener('afterprint', () => { document.getElementById('print-area').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); });

        window.handleFileSelect = (event, key) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { document.getElementById(`preview-${key}`).src = e.target.result; document.getElementById(`preview-${key}`).style.display = 'block'; document.getElementById(`input-${key}-base64`).value = e.target.result; }; reader.readAsDataURL(file); };
        
        window.saveSettings = async () => {
            const s = {
                namaDinas: document.getElementById('set-dinas').value,
                namaSekolah: document.getElementById('set-sekolah').value,
                alamat: document.getElementById('set-alamat').value,
                kota: document.getElementById('set-kota').value,
                kepsek: document.getElementById('set-kepsek').value,
                nipKepsek: document.getElementById('set-nip').value,
                semester: document.getElementById('set-smt').value,
                tahunAjaran: document.getElementById('set-ta').value,
                logo: document.getElementById('input-logo-base64').value,
                ttd: document.getElementById('input-ttd-base64').value,
                cap: document.getElementById('input-cap-base64').value,
                formatNoUjian: document.getElementById('set-format-ujian').value,
                passwordAdmin: document.getElementById('set-pass-admin').value,
                passwordPengawas: document.getElementById('set-pass-pengawas').value
            };
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), s, {merge: true});
                window.showToast("Pengaturan tersimpan di Cloud!", "success");
            } catch (err) {
                window.showToast("Gagal simpan settings.", "error");
            }
        };

        window.downloadBackup = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.appData)); a.download = `backup_asesmen_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); window.showToast("Backup diunduh!", "success"); };
        window.restoreBackup = (e) => { const f = e.target.files[0]; if(!f) return; window.showToast("Fitur Restore via JSON dimatikan saat Mode Cloud aktif. Silakan import Excel.", "warning"); e.target.value=''; };

        // --- Logic Exam Session (Pengawas) ---
        window.enterExamRoom = async (sid) => {
            const sch = window.appData.jadwalPengawas.find(s => s.id === sid);
            let rep = window.appData.laporanUjian.find(l => l.jadwalId === sid);
            
            if(!rep) {
                const studs = window.appData.siswa.filter(s => s.ruang === sch.ruang);
                const newRep = {
                    jadwalId: sid,
                    pengawas: window.currentUser.name,
                    ruang: sch.ruang,
                    mapel: sch.mapel,
                    tanggal: sch.tanggal,
                    waktu: sch.waktu,
                    waktuCheckIn: null,
                    status: 'Aktif',
                    beritaAcara: '',
                    absensi: studs.map(s => ({id:s.id, nama:s.nama, noUjian:s.noUjian, status:'H'}))
                };
                
                try {
                    const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'laporanUjian'), newRep);
                    rep = { id: ref.id, ...newRep }; 
                } catch(e) {
                    window.showToast("Gagal membuat sesi ujian", "error");
                    return;
                }
            }
            window.activeExamSession = rep;
            renderApp();
        };

        window.performCheckIn = async () => {
            if(!window.activeExamSession) return;
            const time = new Date().toLocaleTimeString('id-ID');
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'laporanUjian', window.activeExamSession.id);
            await updateDoc(ref, { waktuCheckIn: time });
            window.showToast("Check-In Tersimpan!", "success");
        };

        window.updateAttendance = async (sid, st) => {
            const newAbsensi = window.activeExamSession.absensi.map(s => s.id === sid ? {...s, status: st} : s);
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'laporanUjian', window.activeExamSession.id);
            window.activeExamSession.absensi = newAbsensi;
            renderApp(); 
            await updateDoc(ref, { absensi: newAbsensi });
        };

        window.updateBeritaAcara = async (txt) => {
            window.activeExamSession.beritaAcara = txt; 
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'laporanUjian', window.activeExamSession.id);
            await updateDoc(ref, { beritaAcara: txt });
        };

        window.finishExamSession = async () => {
            if(!window.activeExamSession.waktuCheckIn) { window.showToast("Wajib Check-In dahulu!", "error"); return; }
            if((window.activeExamSession.beritaAcara||'').length < 3) { window.showToast("Isi Berita Acara!", "error"); return; }
            
            if(confirm("Selesaikan sesi ujian ini?")) {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'laporanUjian', window.activeExamSession.id);
                await updateDoc(ref, { status: 'Selesai' });
                window.activeExamSession = null;
                renderApp();
                window.showToast("Laporan terkirim ke Cloud!", "success");
            }
        };

        window.exitExamRoom = () => { if(confirm("Keluar sementara? Data tersimpan di draft.")) { window.activeExamSession = null; renderApp(); } };

        // --- NEW MISSING FUNCTIONS FOR MODAL (ADD/EDIT) ---
        window.showFormModal = (type, mode, id = null) => {
            const config = formConfig[type];
            if (!config) return;
            
            let data = {};
            if (mode === 'edit' && id) {
                data = window.appData[type].find(d => d.id === id) || {};
            }

            const formHtml = config.map(field => {
                const val = data[field.key] || field.defaultValue || '';
                if (field.type === 'select') {
                    const opts = field.options().map(opt => {
                        const v = typeof opt === 'object' ? opt.value : opt;
                        const l = typeof opt === 'object' ? opt.label : opt;
                        return `<option value="${v}" ${v == val ? 'selected' : ''}>${l}</option>`;
                    }).join('');
                    return `<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">${field.label}</label><select name="${field.key}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none">${opts}</select></div>`;
                } else if (field.type === 'checkbox-group') {
                     const options = field.options();
                     const currentVals = Array.isArray(val) ? val : (typeof val === 'string' ? val.split(',') : []);
                     const checks = options.map(o => {
                         const v = typeof o === 'object' ? o.value : o;
                         const checked = currentVals.includes(v) ? 'checked' : '';
                         return `<label class="inline-flex items-center mr-3 mb-2 text-sm text-slate-600"><input type="checkbox" name="${field.key}" value="${v}" ${checked} class="mr-2 rounded text-indigo-600 focus:ring-indigo-500">${v}</label>`;
                     }).join('');
                     return `<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">${field.label}</label><div class="flex flex-wrap bg-slate-50 p-3 rounded-xl border border-slate-200 max-h-32 overflow-y-auto custom-scrollbar">${checks}</div></div>`;
                } else {
                    return `<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">${field.label}</label><input type="${field.type}" name="${field.key}" value="${val}" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="${field.placeholder||''}"></div>`;
                }
            }).join('');

            document.getElementById('modal-title').innerText = `${mode === 'add' ? 'Tambah' : 'Edit'} Data ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('modal-content').innerHTML = `<form onsubmit="handleFormSave(event, '${type}', '${mode}', '${id}')" class="space-y-4">${formHtml}<div class="pt-4 flex justify-end gap-2 border-t border-slate-100 mt-2"><button type="button" onclick="closeModal()" class="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors">Batal</button><button type="submit" class="px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors">Simpan Data</button></div></form>`;
            window.openModal();
        };

        window.handleFormSave = async (e, type, mode, id) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            let payload = {};
            
            formConfig[type].forEach(field => {
                if (field.type === 'checkbox-group') {
                    const checked = Array.from(e.target.querySelectorAll(`input[name="${field.key}"]:checked`)).map(cb => cb.value);
                    payload[field.key] = checked; 
                } else {
                    payload[field.key] = formData.get(field.key);
                }
            });

            // Prevent undefined id string
            if (id === 'null' || id === 'undefined') id = null;

            try {
                if (mode === 'add') {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', type), payload);
                    window.showToast("Data berhasil ditambahkan", "success");
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id), payload);
                    window.showToast("Data berhasil diperbarui", "success");
                }
                window.closeModal();
            } catch (err) {
                console.error(err);
                window.showToast("Gagal menyimpan data: " + err.message, "error");
            }
        };
        
        window.deleteData = async (type, id) => {
            if(!confirm("Yakin ingin menghapus data ini secara permanen?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id));
                window.showToast("Data berhasil dihapus.", "success");
            } catch(e) {
                window.showToast("Gagal menghapus data.", "error");
            }
        };

        // Initialize
        initFirebase();

    </script>
</body>
</html>
