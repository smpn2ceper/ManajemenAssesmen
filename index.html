<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Administrasi Asesmen (Online)</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        
        // Expose Firebase to Window so React can use it
        window.firebaseModules = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }

        /* --- SETTING CETAK (PRINT) --- */
        @media print {
            @page { size: A4; margin: 0; }
            html, body { margin: 0 !important; padding: 0 !important; background: white; }
            .no-print, .no-print * { display: none !important; }
            #root, .main-content-wrapper, .print-wrapper { margin: 0 !important; padding: 0 !important; width: 100% !important; background: white !important; }
            .a4-sheet { margin: 0 !important; padding: 10mm !important; width: 210mm !important; height: 296mm !important; box-shadow: none !important; border: none !important; page-break-after: always; position: relative !important; }
        }

        .print-only { display: none; }
        
        /* --- LAYOUT KERTAS A4 --- */
        .a4-sheet { background: white; width: 210mm; height: 297mm; padding: 10mm; margin: 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; box-sizing: border-box; overflow: hidden; }
        .doc-header { padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
        .doc-table th, .doc-table td { border: 1px solid black; padding: 5px; }
        .doc-table th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
        
        /* --- LAYOUT TANDA TANGAN --- */
        .signature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 40px; page-break-inside: avoid; }
        .signature-box { text-align: center; position: relative; }
        .sign-img { height: 50px; object-fit: contain; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .stamp-img { height: 55px; object-fit: contain; position: absolute; bottom: 5px; left: 30px; transform: rotate(-10deg); opacity: 0.8; z-index: 5; }

        /* --- KARTU PESERTA --- */
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(4, 1fr); gap: 4mm; height: 100%; }
        .exam-card { border: 1px solid #000; height: 100%; display: flex; flex-direction: column; background-color: #fff; box-sizing: border-box; position: relative; font-size: 8pt; overflow: hidden; }
        .ec-header { border-bottom: 2px double #000; padding: 4px; display: flex; align-items: center; gap: 6px; height: 15mm; }
        .ec-logo { width: 30px; height: 30px; object-fit: contain; }
        .ec-title-box { flex: 1; text-align: center; line-height: 1.1; }
        .ec-agency { font-size: 5pt; text-transform: uppercase; font-weight: bold; }
        .ec-school { font-size: 7pt; font-weight: 800; text-transform: uppercase; }
        .ec-exam { font-size: 6pt; font-weight: bold; margin-top: 1px; }
        .ec-body { padding: 4px; flex: 1; display: flex; gap: 6px; }
        .ec-photo-box { width: 20mm; height: 25mm; border: 1px solid #aaa; background: #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; overflow: hidden; }
        .ec-details { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .ec-row { display: flex; margin-bottom: 1px; line-height: 1.2; }
        .ec-label { width: 50px; font-weight: 600; font-size: 7.5pt; }
        .ec-sep { width: 5px; text-align: center; font-size: 7.5pt; }
        .ec-val { flex: 1; font-weight: bold; font-size: 8pt; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ec-val.mono { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
        .ec-footer { display: flex; justify-content: flex-end; align-items: flex-end; margin-top: auto; font-size: 7pt; }
        .ec-signature { text-align: center; width: 120px; line-height: 1.1; position: relative; }
        .ec-sign-space { height: 30px; position: relative; width: 100%; }
        .ec-sign-img { height: 100%; width: auto; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 2; object-fit: contain; }
        .ec-stamp-img { height: 110%; width: auto; position: absolute; bottom: -5px; left: 10px; transform: rotate(-5deg); z-index: 1; opacity: 0.85; object-fit: contain; }
        .ec-kepsek { font-weight: bold; text-decoration: underline; font-size: 7pt; margin-top: 2px; position: relative; z-index: 3; }

        /* --- UTILS --- */
        .modal-backdrop { background-color: rgba(0,0,0,0.6); position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(2px); }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* --- PACT MODAL STYLE --- */
        .pact-content { max-height: 60vh; overflow-y: auto; background: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; font-size: 0.9rem; line-height: 1.6; color: #374151; margin-bottom: 1rem; text-align: justify; }
        .pact-list { list-style-type: decimal; padding-left: 1.5rem; space-y: 0.5rem; }
        
        /* --- LABEL MEJA --- */
        .desk-label-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10mm; height: 100%; }
        .desk-label-card { border: 2px solid #000; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBXmFBcJix6doD1ZWxZ-bio-oqpeYqT7bM", 
          authDomain: "manajemenass.firebaseapp.com",
          projectId: "manajemenass",
          storageBucket: "manajemenass.firebasestorage.app",
          messagingSenderId: "665901034368",
          appId: "1:665901034368:web:ae4b55872ff47955b82f65"
        };
        
        // --- REACT LOGIC ---
        const { useState, useEffect, useMemo, useRef } = React;
        let db, auth;

        const waitForFirebase = () => new Promise(resolve => {
            const check = () => { if(window.firebaseModules) resolve(window.firebaseModules); else setTimeout(check, 100); };
            check();
        });

        // --- HOOK: FIREBASE FIRESTORE SYNC ---
        const useFirestoreState = (defaultValue, collectionKey) => {
            const [value, setValue] = useState(defaultValue);
            const [loading, setLoading] = useState(true);
            const [isDbReady, setIsDbReady] = useState(false);

            useEffect(() => {
                let unsubscribe = () => {};
                const initSync = async () => {
                    if (!db) {
                        const fb = await waitForFirebase();
                        const app = fb.initializeApp(firebaseConfig); 
                        db = fb.getFirestore(app);
                        auth = fb.getAuth(app);
                        await fb.signInAnonymously(auth);
                    }
                    const { doc, onSnapshot, setDoc } = window.firebaseModules;
                    const docRef = doc(db, 'artifacts', 'sekolah_demo', 'data', collectionKey);
                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) { setValue(docSnap.data().val); } else { setDoc(docRef, { val: defaultValue }); }
                        setLoading(false);
                    });
                    setIsDbReady(true);
                };
                initSync();
                return () => unsubscribe();
            }, [collectionKey]);

            const updateValue = (newValue) => {
                setValue(currentData => {
                    const resolvedValue = typeof newValue === 'function' ? newValue(currentData) : newValue;
                    if(isDbReady) {
                        const { doc, setDoc } = window.firebaseModules;
                        const docRef = doc(db, 'artifacts', 'sekolah_demo', 'data', collectionKey);
                        setDoc(docRef, { val: resolvedValue === undefined ? null : resolvedValue }).catch(err => console.error(err)); 
                    }
                    return resolvedValue;
                });
            };
            return [value, updateValue, loading];
        };

        // --- DATA DEFAULT (FACTORY RESET) ---
        const initialStudents = Array.from({ length: 42 }, (_, i) => ({ id: `init-st-${i}`, name: `Siswa Peserta ${i + 1}`, class: i < 20 ? "XII IPA 1" : "XII IPS 1", examNumber: `24-01-${String(i+1).padStart(3,'0')}`, roomId: i < 20 ? 1 : 2 }));
        const initialTeachers = [
            { id: 1, name: "Budi Santoso, S.Pd", nip: "19800101", subjects: ["Matematika Wajib", "Matematika Peminatan"], classes: ["XII IPA 1", "XII IPA 2"] },
            { id: 2, name: "Siti Aminah, M.Pd", nip: "19850202", subjects: ["Bahasa Indonesia"], classes: ["XII IPA 1", "XII IPS 1"] },
            { id: 3, name: "Dedi Corbusi, S.Kom", nip: "-", subjects: ["TIK"], classes: ["XII IPA 1", "XII IPA 2", "XII IPS 1"] },
            { id: 4, name: "Rina Nose, S.Psi", nip: "-", subjects: ["BK"], classes: ["Semua Kelas"] }
        ];
        const initialSubjects = [{ id: 1, name: "Matematika Wajib", date: "2023-12-04", time: "07:30 - 09:30" }, { id: 2, name: "Bahasa Indonesia", date: "2023-12-04", time: "10:00 - 12:00" }];
        const initialRooms = [{ id: 1, name: "Ruang 01", capacity: 20 }, { id: 2, name: "Ruang 02", capacity: 20 }];
        const initialSchoolInfo = { 
            agency: "PEMERINTAH PROVINSI DAERAH KHUSUS", 
            name: "SMA NEGERI CONTOH JAKARTA", 
            address: "Jl. Pendidikan No. 1, Jakarta Selatan", 
            examName: "PENILAIAN AKHIR SEMESTER (PAS)", 
            year: "2023/2024", 
            headmaster: "Dr. Kepala Sekolah, M.Pd", 
            headmasterNip: "19700101 199002 1 001", 
            adminPassword: "admin",
            studentIdFormat: "{YY}-{CLASS}-{NUM}" 
        };

        // --- COMPONENTS UI ---
        const NavButton = ({ active, onClick, icon, label }) => ( <button onClick={onClick} className={`no-print w-full flex items-center p-3 rounded-lg transition-colors duration-200 mb-1 ${active ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-slate-700 text-slate-300 hover:text-white'}`}> <div className="w-8 flex justify-center"><i className={`fas ${icon}`}></i></div> <span className="font-medium text-sm">{label}</span> </button> );
        const DocCard = ({ title, desc, icon, color, onClick }) => ( <div onClick={onClick} className="bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-lg hover:border-blue-500 border border-transparent transition-all group"> <div className="flex items-start justify-between"> <div> <h4 className="font-bold text-lg group-hover:text-blue-600">{title}</h4> <p className="text-sm text-gray-500 mt-1">{desc}</p> </div> <i className={`fas ${icon} text-2xl ${color}`}></i> </div> <div className="mt-4 text-xs font-bold text-gray-400 uppercase group-hover:text-blue-500">Klik untuk Preview</div> </div> );
        
        const StatCard = ({ title, value, icon, color }) => (
            <div className={`p-4 rounded-xl shadow-sm bg-white border-l-4 ${color.replace('text-', 'border-')} flex justify-between items-center transform hover:-translate-y-1 transition duration-200`}>
                <div>
                    <p className="text-xs text-gray-500 uppercase font-bold tracking-wider">{title}</p>
                    <p className="text-2xl font-bold text-gray-800">{value}</p>
                </div>
                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl bg-gray-50 ${color}`}>
                    <i className={`fas ${icon}`}></i>
                </div>
            </div>
        );

        const IntegrityPactModal = ({ teacherName, onAgree }) => {
            const [checked, setChecked] = useState(false);
            return (
                <div className="modal-backdrop">
                    <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl m-4 overflow-hidden border border-slate-200 animate-fade-in-down">
                        <div className="bg-teal-600 p-4 text-white flex items-center gap-3">
                            <i className="fas fa-file-contract text-2xl"></i>
                            <div>
                                <h3 className="text-lg font-bold">Pakta Integritas Pengawas</h3>
                                <p className="text-xs text-teal-100">Harap setujui untuk melanjutkan ke sistem.</p>
                            </div>
                        </div>
                        <div className="p-6">
                            <p className="mb-4 text-sm text-gray-600">Saya yang bertanda tangan di bawah ini, <b>{teacherName}</b>, dalam rangka pelaksanaan tugas sebagai Pengawas Ujian, dengan ini menyatakan:</p>
                            <div className="pact-content">
                                <ol className="pact-list">
                                    <li>Sanggup melaksanakan tugas pengawasan dengan jujur, bertanggung jawab, dan disiplin sesuai dengan Jadwal dan Tata Tertib yang berlaku.</li>
                                    <li>Akan menjaga kerahasiaan dokumen negara dan tidak akan membocorkan soal ujian dalam bentuk apapun.</li>
                                    <li>Tidak akan memberikan bantuan jawaban kepada peserta ujian atau membiarkan terjadinya kecurangan.</li>
                                    <li>Bersedia menerima sanksi sesuai ketentuan perundang-undangan apabila melanggar pakta integritas ini.</li>
                                    <li>Akan hadir di ruang ujian tepat waktu (minimal 15 menit sebelum ujian dimulai) dan melakukan presensi digital.</li>
                                </ol>
                            </div>
                            <div className="flex items-center gap-2 mb-6 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                                <input type="checkbox" id="agreeCheck" className="w-5 h-5 text-teal-600 rounded focus:ring-teal-500 cursor-pointer" checked={checked} onChange={(e) => setChecked(e.target.checked)} />
                                <label htmlFor="agreeCheck" className="text-sm font-bold text-gray-700 cursor-pointer select-none">Saya telah membaca, memahami, dan menyetujui Pakta Integritas ini.</label>
                            </div>
                            <button onClick={onAgree} disabled={!checked} className={`w-full py-3 rounded-lg font-bold shadow-md transition-all flex items-center justify-center ${checked ? 'bg-teal-600 text-white hover:bg-teal-700 cursor-pointer' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                <i className="fas fa-signature mr-2"></i> Konfirmasi & Masuk
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ user, schedules, subjects, rooms, onLogout, studentAttendance, setStudentAttendance, violationLogs, setViolationLogs, teacherAgreements, setTeacherAgreements, supervisorAttendance, setSupervisorAttendance }) => {
            const [activeSession, setActiveSession] = useState(null);
            const [showPact, setShowPact] = useState(false);
            
            useEffect(() => {
                const hasAgreed = teacherAgreements && teacherAgreements[user.data.id];
                if (!hasAgreed) { setShowPact(true); }
            }, [user.data.id, teacherAgreements]);

            const handleAgreePact = () => {
                const now = new Date().toISOString();
                setTeacherAgreements(prev => ({ ...prev, [user.data.id]: { agreedAt: now, status: true } }));
                setShowPact(false);
            };

            const mySchedules = schedules.filter(s => s.invigilator1Id === user.data.id || s.invigilator2Id === user.data.id || s.invigilatorId === user.data.id);
            const handleAttendance = (key, sId, status) => setStudentAttendance(prev => ({...prev, [key]: {...(prev[key]||{}), [sId]: status}}));
            const handleViolation = (key, text) => setViolationLogs(prev => ({...prev, [key]: text}));

            const handleSupervisorCheckIn = (scheduleId) => {
                if(!confirm("Anda yakin sudah berada di Ruang Ujian dan ingin melakukan Check-In?")) return;
                const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                setSupervisorAttendance(prev => ({ ...prev, [scheduleId]: now }));
            };

            if (showPact) return <IntegrityPactModal teacherName={user.data.name} onAgree={handleAgreePact} />;

            if (!activeSession) return (
                <div className="min-h-screen bg-gray-100 flex flex-col">
                    <header className="bg-teal-600 text-white p-4 shadow-md flex justify-between items-center"><div><div className="text-xs opacity-80">Halo,</div><div className="font-bold">{user.data.name}</div></div><button onClick={onLogout} className="bg-teal-700 p-2 rounded hover:bg-teal-800"><i className="fas fa-sign-out-alt"></i></button></header>
                    <main className="flex-1 p-4 space-y-4 max-w-3xl mx-auto w-full">
                        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i className="fas fa-check-circle"></i></div>
                                <div><div className="font-bold text-gray-700">Status Akun</div><div className="text-xs text-green-600 font-semibold">Pakta Integritas Disetujui</div></div>
                            </div>
                        </div>
                        <h3 className="font-bold text-gray-700 mt-4">Jadwal Tugas Anda</h3>
                        {mySchedules.length === 0 ? <div className="text-center p-10 bg-white rounded-xl shadow text-gray-400"><i className="fas fa-coffee text-4xl mb-3"></i><p>Tidak ada jadwal pengawasan.</p></div> : mySchedules.map((sch, i) => { 
                            const sub = subjects.find(s => s.id === sch.subjectId); 
                            const room = rooms.find(r => r.id === sch.roomId); 
                            const isPresent = supervisorAttendance && supervisorAttendance[sch.id];
                            return (
                                <div key={i} onClick={() => setActiveSession(sch)} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-500 cursor-pointer hover:shadow-md transition relative overflow-hidden">
                                    <div className="flex justify-between items-start">
                                        <div><h4 className="font-bold text-gray-800">{sub?.name}</h4><div className="text-sm text-gray-500 mt-1"><i className="far fa-clock mr-1"></i>{sub?.time}</div></div>
                                        <div className="text-right"><div className="bg-teal-50 text-teal-700 px-3 py-1 rounded-lg text-sm font-bold mb-1">{room?.name}</div>{isPresent && <div className="text-xs font-bold text-green-600 flex items-center justify-end"><i className="fas fa-check mr-1"></i> Hadir {isPresent}</div>}</div>
                                    </div>
                                </div>
                            ); 
                        })}
                    </main>
                </div>
            );

            const sch = activeSession; 
            const sub = subjects.find(s => s.id === sch.subjectId); 
            const room = rooms.find(r => r.id === sch.roomId); 
            const roomStudents = Array.from({length: 20}, (_, i) => ({id: i + (room.id * 100), name: `Siswa ${room.name} - ${i+1}`, examNumber: `24-${room.id}-${String(i+1).padStart(3,'0')}`})); 
            const scheduleKey = `${sch.subjectId}-${sch.roomId}`; 
            const currentAttendance = studentAttendance[scheduleKey] || {}; 
            const currentViolation = violationLogs[scheduleKey] || "";
            const presenceTime = supervisorAttendance && supervisorAttendance[sch.id];

            return ( 
                <div className="min-h-screen bg-gray-100 flex flex-col"> 
                    <header className="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3"><button onClick={() => setActiveSession(null)} className="hover:bg-teal-700 p-1 rounded"><i className="fas fa-arrow-left text-xl"></i></button><div className="flex-1"><div className="font-bold text-lg leading-tight">{sub?.name}</div><div className="text-xs opacity-80">{room?.name}</div></div></header> 
                    <main className="flex-1 p-4 space-y-6 max-w-3xl mx-auto w-full"> 
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-user-check text-teal-600 mr-2"></i> Presensi Pengawas</h4>
                            {presenceTime ? (
                                <div className="w-full bg-green-50 text-green-700 border border-green-200 py-4 rounded-lg font-bold flex flex-col items-center justify-center animate-fade-in-down">
                                    <div className="text-2xl mb-1"><i className="fas fa-check-circle"></i></div>
                                    <div>Anda sudah Check-In</div>
                                    <div className="text-sm font-normal">Waktu Masuk: {presenceTime}</div>
                                </div>
                            ) : (
                                <button onClick={() => handleSupervisorCheckIn(sch.id)} className="w-full bg-teal-50 text-teal-700 border border-teal-200 py-4 rounded-lg font-bold hover:bg-teal-100 transition shadow-sm hover:shadow active:scale-95 flex flex-col items-center justify-center group">
                                    <i className="fas fa-fingerprint text-2xl mb-2 group-hover:scale-110 transition-transform"></i> 
                                    <span>Klik untuk Check-In Kehadiran</span>
                                    <span className="text-xs font-normal mt-1 text-teal-500">Pastikan Anda sudah di ruang ujian</span>
                                </button>
                            )}
                        </div> 
                        <div className={`transition-opacity duration-300 ${!presenceTime ? 'opacity-50 pointer-events-none filter blur-[1px]' : 'opacity-100'}`}>
                            <div className="bg-white p-4 rounded-xl shadow-sm mb-6">
                                <h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-users text-blue-600 mr-2"></i> Kehadiran Peserta</h4>
                                <div className="space-y-2 max-h-80 overflow-y-auto pr-1">
                                    {roomStudents.map(s => (
                                        <div key={s.id} className="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                                            <div className="flex-1"><div className="font-bold text-sm">{s.name}</div><div className="text-xs text-gray-500">{s.examNumber}</div></div>
                                            <div className="flex gap-1">{['H','S','I','A'].map(st => <button key={st} onClick={()=>handleAttendance(scheduleKey, s.id, st)} className={`w-8 h-8 rounded text-xs font-bold transition ${currentAttendance[s.id]===st ? (st==='H'?'bg-green-500 text-white':st==='A'?'bg-red-500 text-white':'bg-yellow-500 text-white') : 'bg-white border text-gray-400'}`}>{st}</button>)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div> 
                            <div className="bg-white p-4 rounded-xl shadow-sm">
                                <h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-exclamation-triangle text-red-600 mr-2"></i> Laporan Kejadian</h4>
                                <textarea className="w-full border p-3 rounded-lg h-32 focus:ring-2 focus:ring-red-200 outline-none" placeholder="Tuliskan kejadian khusus..." value={currentViolation} onChange={e=>handleViolation(scheduleKey, e.target.value)}></textarea>
                            </div>
                        </div>
                        {!presenceTime && <div className="text-center text-xs text-red-500 font-bold bg-red-50 p-2 rounded">Check-In terlebih dahulu untuk mengisi Absensi Siswa & Laporan.</div>}
                    </main> 
                </div> 
            );
        };

        const LoginPage = ({ teachers, schoolInfo, onLogin }) => {
            const [role, setRole] = useState('admin');
            const [selectedTeacher, setSelectedTeacher] = useState('');
            const [adminPass, setAdminPass] = useState('');

            const handleLogin = () => {
                if (role === 'admin') {
                    if(adminPass === (schoolInfo?.adminPassword || 'admin')) {
                        onLogin({ role: 'admin', data: null });
                    } else {
                        alert("Password Admin Salah!");
                    }
                } else {
                    if (!selectedTeacher) return alert("Pilih nama Anda terlebih dahulu.");
                    const teacherData = teachers.find(t => t.id === parseInt(selectedTeacher));
                    onLogin({ role: 'teacher', data: teacherData });
                }
            };
            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="bg-blue-600 p-8 text-center">
                            <div className="inline-block p-3 rounded-full bg-blue-500 mb-3 shadow-inner"><i className="fas fa-school text-4xl text-white"></i></div>
                            <h1 className="text-2xl font-bold text-white tracking-tight">Portal Asesmen</h1>
                            <p className="text-blue-100 text-sm mt-1">Sistem Manajemen Terpadu & Digital</p>
                        </div>
                        <div className="p-8">
                            <div className="flex bg-gray-100 rounded-lg p-1 mb-6 shadow-inner">
                                <button onClick={()=>setRole('admin')} className={`flex-1 py-2.5 rounded-md text-sm font-bold transition-all duration-200 ${role==='admin' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}><i className="fas fa-user-shield mr-2"></i>Admin</button>
                                <button onClick={()=>setRole('teacher')} className={`flex-1 py-2.5 rounded-md text-sm font-bold transition-all duration-200 ${role==='teacher' ? 'bg-white shadow text-teal-600' : 'text-gray-500 hover:text-gray-700'}`}><i className="fas fa-chalkboard-teacher mr-2"></i>Pengawas</button>
                            </div>
                            {role === 'teacher' && (
                                <div className="mb-6 animate-fade-in-down">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Pilih Identitas Pengawas</label>
                                    <div className="relative"><i className="fas fa-user absolute left-3 top-3.5 text-gray-400"></i><select className="w-full border border-gray-300 p-3 pl-10 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition bg-white" value={selectedTeacher} onChange={e=>setSelectedTeacher(e.target.value)}><option value="">-- Pilih Nama Anda --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                                </div>
                            )}
                            {role === 'admin' && (
                                <div className="mb-6 animate-fade-in-down">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Password Admin</label>
                                    <div className="relative"><i className="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i><input type="password" className="w-full border border-gray-300 p-3 pl-10 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-white" placeholder="Masukkan Password..." value={adminPass} onChange={e=>setAdminPass(e.target.value)} /></div>
                                </div>
                            )}
                            <button onClick={handleLogin} className={`w-full py-3.5 rounded-lg text-white font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center ${role==='admin' ? 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800' : 'bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700'}`}>Masuk Sistem <i className="fas fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const DataMaster = ({ students, setStudents, teachers, setTeachers, subjects, setSubjects, rooms, setRooms, schoolInfo }) => {
            const [tab, setTab] = useState('siswa');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            const generateExamNumbers = () => {
                if (!confirm("Generate ulang No Ujian untuk semua siswa sesuai format di Pengaturan?")) return;
                const format = schoolInfo.studentIdFormat || '{YY}-{CLASS}-{NUM}';
                const currentYearFull = new Date().getFullYear().toString();
                const currentYearShort = currentYearFull.slice(-2);
                const sortedStudents = [...students].sort((a, b) => {
                    const classA = (a.class || "").toString();
                    const classB = (b.class || "").toString();
                    if (classA === classB) { return (a.name || "").localeCompare(b.name || ""); }
                    return classA.localeCompare(classB);
                });
                const classCounters = {};
                const updatedStudents = sortedStudents.map(student => {
                    const rawClass = (student.class || "X").toString();
                    const classCode = rawClass.replace(/[^a-zA-Z0-9]/g, '').substring(0, 3).toUpperCase(); 
                    if (!classCounters[rawClass]) { classCounters[rawClass] = 1; }
                    const serial = String(classCounters[rawClass]).padStart(3, '0');
                    let newExamNumber = format.replace('{YY}', currentYearShort).replace('{YYYY}', currentYearFull).replace('{CLASS}', classCode).replace('{NUM}', serial);
                    classCounters[rawClass]++;
                    return { ...student, examNumber: newExamNumber };
                });
                setStudents(updatedStudents);
                alert('Nomor Ujian berhasil di-generate ulang sesuai format pengaturan!');
            };
            
            const resetExamNumbers = () => {
                if (!confirm("Hapus semua Nomor Ujian siswa? Tindakan ini akan mengosongkan kolom No. Ujian.")) return;
                const updatedStudents = students.map(student => ({ ...student, examNumber: "" }));
                setStudents(updatedStudents);
                alert('Nomor Ujian berhasil di-reset!');
            };

            const downloadTemplate = () => {
                const templateData = [
                    { "Nama": "Contoh Siswa 1", "Kelas": "XII IPA 1", "No Ujian": "24-IPA-001", "ID Ruang (Angka)": 1 },
                    { "Nama": "Contoh Siswa 2", "Kelas": "XII IPS 2", "No Ujian": "24-IPS-005", "ID Ruang (Angka)": 2 }
                ];
                const ws = XLSX.utils.json_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Template Siswa");
                XLSX.writeFile(wb, "Template_Import_Siswa.xlsx");
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if(!file) return;

                // --- PENGAMANAN IMPOR DATA ---
                if (tab !== 'siswa') {
                    alert("PERHATIAN: Anda sedang tidak berada di Tab Siswa.\n\nHarap pindah ke Tab Siswa terlebih dahulu sebelum melakukan impor data siswa untuk mencegah kesalahan data.");
                    e.target.value = ''; // Reset input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const wb = XLSX.read(ev.target.result, {type:'array'});
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        if(json.length){
                            const newS = json.map((r,i)=>({
                                id: `student-${Date.now()}-${i}-${Math.random().toString(36).slice(2, 7)}`, 
                                name: String(r['Nama'] || r['nama'] || r['Nama Lengkap'] || r['Name'] || '-').trim(),
                                class: String(r['Kelas'] || r['kelas'] || r['Class'] || '-').trim(),
                                examNumber: String(r['No Ujian'] || r['no ujian'] || r['Nomor Ujian'] || '').trim(),
                                roomId: Number(r['ID Ruang (Angka)'] || r['id ruang'] || r['ruang']) || 0
                            }));

                            const validStudents = newS.filter(s => s.name && s.name !== '-' && s.name !== 'undefined');

                            if (validStudents.length === 0) {
                                alert("Data tidak terbaca! Pastikan nama kolom di Excel sesuai Template: 'Nama', 'Kelas', 'No Ujian', 'ID Ruang (Angka)'");
                                return;
                            }

                            setStudents(prev => {
                                const combined = [...prev, ...validStudents];
                                return combined;
                            });
                            
                            alert(`Berhasil membaca ${validStudents.length} data siswa.\n\nSistem sedang menyinkronkan ke server (Cloud). Tunggu beberapa saat hingga ikon loading selesai jika ada perubahan.`);
                        }
                    } catch (error) {
                        alert('Gagal membaca file. Pastikan file Excel tidak rusak dan formatnya benar.');
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = '';
            };

            const handleDelete = (id, type) => { if(confirm("Hapus data ini?")) { if(type==='siswa') setStudents(prev=>prev.filter(x=>x.id!==id)); if(type==='guru') setTeachers(prev=>prev.filter(x=>x.id!==id)); if(type==='mapel') setSubjects(prev=>prev.filter(x=>x.id!==id)); if(type==='ruang') setRooms(prev=>prev.filter(x=>x.id!==id)); } };
            
            const handleSave = (e) => { 
                e.preventDefault(); 
                const id = formData.id || `manual-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`; 
                let newData = { ...formData, id }; 
                
                if(tab==='siswa') { 
                    if(formData.id) setStudents(prev=>prev.map(x=>x.id===id?newData:x)); 
                    else setStudents(prev=>[...prev,newData]); 
                } 
                if(tab==='guru') { 
                    newData = {
                        ...newData,
                        subjects: formData.subjectsStr ? formData.subjectsStr.split(',').map(s => s.trim()).filter(Boolean) : [],
                        classes: formData.classesStr ? formData.classesStr.split(',').map(s => s.trim()).filter(Boolean) : []
                    };
                    delete newData.subjectsStr;
                    delete newData.classesStr;

                    if(formData.id) setTeachers(prev=>prev.map(x=>x.id===id?newData:x)); 
                    else setTeachers(prev=>[...prev,newData]); 
                } 
                if(tab==='mapel') { 
                    if(formData.id) setSubjects(prev=>prev.map(x=>x.id===id?newData:x)); 
                    else setSubjects(prev=>[...prev,newData]); 
                } 
                if(tab==='ruang') { 
                    if(formData.id) setRooms(prev=>prev.map(x=>x.id===id?newData:x)); 
                    else setRooms(prev=>[...prev,newData]); 
                } 
                setIsModalOpen(false); 
                setFormData({}); 
            };
            
            const openEdit = (item) => { 
                let editData = { ...item };
                if (tab === 'guru') {
                    editData.subjectsStr = item.subjects ? item.subjects.join(', ') : '';
                    editData.classesStr = item.classes ? item.classes.join(', ') : '';
                }
                setFormData(editData); 
                setIsModalOpen(true); 
            };
            
            const openAdd = () => { setFormData({}); setIsModalOpen(true); };

            const tabs = [{id:'siswa', label:'Siswa', icon:'fa-user'}, {id:'guru', label:'Guru', icon:'fa-chalkboard-teacher'}, {id:'mapel', label:'Mapel', icon:'fa-book'}, {id:'ruang', label:'Ruang', icon:'fa-door-open'}];
            const getData = () => { if(tab==='siswa') return students; if(tab==='guru') return teachers; if(tab==='mapel') return subjects; return rooms; };
            const filtered = getData().filter(i => JSON.stringify(i).toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="space-y-6 animate-fade-in-down">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Data Master</h2>
                        <button onClick={openAdd} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition"><i className="fas fa-plus mr-2"></i> Tambah Data</button>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex gap-2 mb-4 overflow-x-auto">
                            {tabs.map(t => <button key={t.id} onClick={()=>setTab(t.id)} className={`px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap ${tab===t.id ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}><i className={`fas ${t.icon} mr-2`}></i>{t.label}</button>)}
                        </div>
                        <div className="flex flex-col md:flex-row gap-3 mb-4">
                            <input type="text" placeholder="Cari data..." className="w-full md:w-1/3 border p-2 rounded-lg" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                            {tab === 'siswa' && (
                                <div className="flex gap-2 overflow-x-auto pb-1 md:pb-0">
                                    <button onClick={generateExamNumbers} className="bg-purple-100 text-purple-700 border border-purple-200 px-3 py-2 rounded-lg text-xs font-bold hover:bg-purple-200 transition whitespace-nowrap flex items-center"><i className="fas fa-magic mr-2"></i> Auto No.</button>
                                    <button onClick={resetExamNumbers} className="bg-red-100 text-red-700 border border-red-200 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-200 transition whitespace-nowrap flex items-center"><i className="fas fa-eraser mr-2"></i> Reset No.</button>
                                    <button onClick={downloadTemplate} className="bg-green-100 text-green-700 border border-green-200 px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-200 transition whitespace-nowrap flex items-center"><i className="fas fa-file-excel mr-2"></i> Template</button>
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".xlsx, .xls" />
                                    <button onClick={() => fileInputRef.current.click()} className="bg-emerald-100 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-200 transition whitespace-nowrap flex items-center"><i className="fas fa-upload mr-2"></i> Import</button>
                                </div>
                            )}
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-4 py-3">Nama</th>
                                        <th className="px-4 py-3">Detail</th>
                                        {tab === 'guru' && <th className="px-4 py-3">Mengajar</th>}
                                        <th className="px-4 py-3 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filtered.map(item => (
                                        <tr key={item.id} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 font-medium">{item.name}</td>
                                            <td className="px-4 py-3 text-gray-500">
                                                {tab==='siswa' && `${item.class} - ${item.examNumber}`}
                                                {tab==='guru' && `NIP: ${item.nip}`}
                                                {tab==='mapel' && `${item.date} ${item.time}`}
                                                {tab==='ruang' && `Kapasitas: ${item.capacity}`}
                                            </td>
                                            {tab === 'guru' && (
                                                <td className="px-4 py-3 text-gray-500">
                                                    <div className="text-xs">
                                                        <span className="font-bold">Mapel:</span> {item.subjects ? item.subjects.join(', ') : '-'}
                                                    </div>
                                                    <div className="text-xs mt-1">
                                                        <span className="font-bold">Kelas:</span> {item.classes ? item.classes.join(', ') : '-'}
                                                    </div>
                                                </td>
                                            )}
                                            <td className="px-4 py-3 text-right">
                                                <button onClick={()=>openEdit(item)} className="text-blue-600 hover:text-blue-800 mr-3"><i className="fas fa-edit"></i></button>
                                                <button onClick={()=>handleDelete(item.id, tab)} className="text-red-600 hover:text-red-800"><i className="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {isModalOpen && (
                        <div className="modal-backdrop" onClick={()=>setIsModalOpen(false)}>
                            <div className="bg-white p-6 rounded-xl w-full max-w-md m-4" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">{formData.id ? 'Edit' : 'Tambah'} {tabs.find(t=>t.id===tab).label}</h3>
                                <form onSubmit={handleSave} className="space-y-3">
                                    <input required className="w-full border p-2 rounded" placeholder="Nama" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} />
                                    {tab==='siswa' && <><input required className="w-full border p-2 rounded" placeholder="Kelas" value={formData.class||''} onChange={e=>setFormData({...formData, class:e.target.value})} /><input required className="w-full border p-2 rounded" placeholder="No Ujian" value={formData.examNumber||''} onChange={e=>setFormData({...formData, examNumber:e.target.value})} /><select required className="w-full border p-2 rounded" value={formData.roomId||''} onChange={e=>setFormData({...formData, roomId: Number(e.target.value)})}> <option value="">Pilih Ruang</option> {rooms.map(r=><option key={r.id} value={r.id}>{r.name}</option>)} </select></>}
                                    {tab==='guru' && (
                                        <>
                                            <input className="w-full border p-2 rounded" placeholder="NIP" value={formData.nip||''} onChange={e=>setFormData({...formData, nip:e.target.value})} />
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">Mata Pelajaran (pisahkan dengan koma)</label>
                                                <input className="w-full border p-2 rounded" placeholder="Contoh: Matematika, Fisika" value={formData.subjectsStr||''} onChange={e=>setFormData({...formData, subjectsStr:e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 mb-1">Kelas (pisahkan dengan koma)</label>
                                                <input className="w-full border p-2 rounded" placeholder="Contoh: XII IPA 1, XII IPS 2" value={formData.classesStr||''} onChange={e=>setFormData({...formData, classesStr:e.target.value})} />
                                            </div>
                                        </>
                                    )}
                                    {tab==='mapel' && <><input required type="date" className="w-full border p-2 rounded" value={formData.date||''} onChange={e=>setFormData({...formData, date:e.target.value})} /><input required className="w-full border p-2 rounded" placeholder="Waktu" value={formData.time||''} onChange={e=>setFormData({...formData, time:e.target.value})} /></>}
                                    {tab==='ruang' && <input required type="number" className="w-full border p-2 rounded" placeholder="Kapasitas" value={formData.capacity||''} onChange={e=>setFormData({...formData, capacity:e.target.value})} />}
                                    <div className="flex justify-end gap-2 mt-4">
                                        <button type="button" onClick={()=>setIsModalOpen(false)} className="px-4 py-2 text-gray-600">Batal</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ScheduleManager = ({ subjects, rooms, teachers, schedules, setSchedules }) => {
            const clearSchedule = () => { if(confirm('PERHATIAN: Hapus semua jadwal? \nJadwal yang sudah dikunci (gembok) juga akan ikut terhapus.')) { setSchedules([]); } };
            const generateSchedule = () => {
                const lockedSchedules = schedules.filter(s => s.isLocked);
                const isSlotLocked = (subId, roomId) => lockedSchedules.some(s => String(s.subjectId) === String(subId) && String(s.roomId) === String(roomId));
                const newSchedules = [...lockedSchedules];
                let teacherIndex = 0;
                subjects.forEach(sub => {
                    rooms.forEach(room => {
                        if (!isSlotLocked(sub.id, room.id)) {
                            const teacher = teachers[teacherIndex % teachers.length];
                            teacherIndex++;
                            newSchedules.push({ id: `${sub.id}-${room.id}`, subjectId: sub.id, roomId: room.id, invigilatorId: teacher.id, isLocked: false });
                        }
                    });
                });
                setSchedules(newSchedules);
                alert(`Jadwal berhasil digenerate!\n${lockedSchedules.length} jadwal terkunci dipertahankan.`);
            };
            const handleManualChange = (schId, newTeacherId) => { setSchedules(prev => prev.map(s => s.id === schId ? { ...s, invigilatorId: Number(newTeacherId), isLocked: true } : s)); };
            const toggleLock = (schId) => { setSchedules(prev => prev.map(s => s.id === schId ? { ...s, isLocked: !s.isLocked } : s)); };
            const totalSlots = subjects.length * rooms.length;
            const filledSlots = schedules.length;

            return (
                <div className="space-y-8 animate-fade-in-down">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h2 className="text-xl font-bold text-gray-800">Manajemen Jadwal</h2><p className="text-gray-500 text-sm">Terisi: <span className="font-bold text-blue-600">{filledSlots}</span> / {totalSlots} Slot. Gunakan <i className="fas fa-lock text-xs mx-1"></i> untuk mengunci posisi pengawas.</p></div>
                        <div className="flex gap-2">
                            <button onClick={clearSchedule} className="bg-white text-red-600 border border-red-200 px-4 py-2 rounded-lg font-bold hover:bg-red-50 transition flex items-center shadow-sm text-sm"><i className="fas fa-trash-alt mr-2"></i> Reset Semua</button>
                            <button onClick={generateSchedule} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center shadow-md text-sm"><i className="fas fa-magic mr-2"></i> Auto Generate</button>
                        </div>
                    </div>
                    {subjects.length === 0 ? (<div className="p-12 text-center text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-300"><i className="fas fa-calendar-times text-4xl mb-3"></i><p>Belum ada mata pelajaran. Silakan tambah di Data Master.</p></div>) : (<div className="space-y-6">{subjects.map(sub => {
                        const subSchedules = schedules.filter(s => String(s.subjectId) === String(sub.id));
                        return (
                            <div key={sub.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="bg-gray-50 px-6 py-3 border-b border-gray-200 flex justify-between items-center"><div className="font-bold text-gray-700 flex items-center gap-2"><div className="w-8 h-8 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs"><i className="fas fa-book"></i></div> {sub.name} <span className="text-xs font-normal text-gray-500 ml-2 bg-white px-2 py-1 rounded border border-gray-200"><i className="far fa-clock mr-1"></i> {sub.date}, {sub.time}</span></div></div>
                                <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-white border-b border-gray-100 text-xs uppercase text-gray-500"><tr><th className="px-6 py-3 w-1/4">Ruang Ujian</th><th className="px-6 py-3">Pengawas (Bisa Diubah)</th><th className="px-6 py-3 w-24 text-center">Kunci</th></tr></thead><tbody className="divide-y divide-gray-50">{rooms.map(room => {
                                    const sch = subSchedules.find(s => String(s.roomId) === String(room.id));
                                    if (!sch) return (<tr key={room.id}><td className="px-6 py-3 font-medium text-gray-600 pl-6 border-l-4 border-transparent">{room.name}</td><td className="px-6 py-3 text-gray-400 italic">-- Belum dijadwalkan --</td><td className="px-6 py-3 text-center">-</td></tr>);
                                    return (
                                        <tr key={sch.id} className={`transition duration-200 ${sch.isLocked ? "bg-amber-50/60" : "hover:bg-gray-50"}`}>
                                            <td className={`px-6 py-3 font-medium text-gray-700 border-l-4 ${sch.isLocked ? 'border-amber-400' : 'border-transparent'}`}>{room.name}<div className="text-[10px] text-gray-400">Kapasitas: {room.capacity}</div></td>
                                            <td className="px-6 py-3"><div className="relative"><select className={`appearance-none bg-transparent border-b-2 py-1.5 pr-8 outline-none cursor-pointer transition w-full text-sm ${sch.isLocked ? 'border-amber-400 text-amber-900 font-bold' : 'border-transparent hover:border-gray-300 text-gray-700'}`} value={sch.invigilatorId || ''} onChange={(e) => handleManualChange(sch.id, e.target.value)}><option value="">-- Pilih Pengawas --</option>{teachers.map(t => (<option key={t.id} value={t.id}>{t.name}</option>))}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><i className="fas fa-chevron-down text-xs"></i></div></div></td>
                                            <td className="px-6 py-3 text-center"><button onClick={() => toggleLock(sch.id)} className={`w-9 h-9 rounded-full flex items-center justify-center transition shadow-sm ${sch.isLocked ? 'bg-amber-500 text-white hover:bg-amber-600' : 'bg-white text-gray-300 hover:text-gray-500 hover:bg-gray-100 border border-gray-200'}`} title={sch.isLocked ? "Terkunci: Aman dari Auto-Generate" : "Klik untuk Mengunci Pengawas"}><i className={`fas ${sch.isLocked ? 'fa-lock' : 'fa-lock-open'}`}></i></button></td>
                                        </tr>
                                    );
                                })}</tbody></table></div>
                            </div>
                        );
                    })}</div>)}
                </div>
            );
        };

        const PrintCenter = ({ schoolInfo, students, rooms, subjects, schedules, teachers, supervisorAttendance }) => {
            const [view, setView] = useState('menu');
            const [selectedRoom, setSelectedRoom] = useState('all');
            const [selectedSubject, setSelectedSubject] = useState(subjects[0]?.id || 0);
            const ITEMS_PER_PAGE = 20;

            const handlePrint = () => window.print();

            // Helper Components
            const BackBtn = () => (
                <div className="no-print mb-4 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-lg shadow border border-slate-200 sticky top-0 z-50">
                    <button onClick={() => setView('menu')} className="text-slate-600 hover:text-slate-800 font-bold flex items-center gap-2">
                        <i className="fas fa-arrow-left"></i> Kembali ke Menu
                    </button>
                    <div className="flex flex-wrap items-center gap-2">
                        {(view === 'attendance' || view === 'supervisor' || view === 'ba_naskah' || view === 'ba_ljk') && (
                            <select className="border border-slate-300 p-2 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={selectedSubject} onChange={e=>setSelectedSubject(Number(e.target.value))}>
                                {subjects.map(s => <option key={s.id} value={s.id}>{s.name} ({s.date})</option>)}
                            </select>
                        )}
                        {(view === 'cards' || view === 'attendance' || view === 'label' || view === 'ba_naskah' || view === 'ba_ljk') && (
                            <select className="border border-slate-300 p-2 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={selectedRoom} onChange={e=>setSelectedRoom(e.target.value === 'all' ? 'all' : Number(e.target.value))}>
                                <option value="all">Semua Ruang</option>
                                {rooms.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                            </select>
                        )}
                        <button onClick={handlePrint} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 transition">
                            <i className="fas fa-print"></i> Cetak Dokumen
                        </button>
                    </div>
                </div>
            );

            const DocHeader = ({ school, title, subtitle }) => (
                <div className="text-center pb-2 mb-4 relative">
                    <div className="flex items-center gap-4 mb-2 justify-center relative">
                        {school?.logo && <img src={school.logo} alt="Logo" className="w-20 h-20 object-contain absolute left-0" />}
                        <div className="flex-1 px-20">
                            <h1 className="text-lg font-bold uppercase leading-tight">{school?.agency || 'PEMERINTAH PROVINSI'}</h1>
                            <h2 className="text-xl font-bold uppercase text-blue-900 leading-tight mb-1">{school?.name || 'NAMA SEKOLAH'}</h2>
                            <p className="text-xs italic text-gray-600">{school?.address || 'Alamat Sekolah'}</p>
                        </div>
                    </div>
                    <div className="border-t-2 border-black mt-1 pt-2">
                        <div className="font-bold text-lg uppercase mb-1">{title}</div>
                        {subtitle && <div className="font-bold text-md uppercase">{subtitle}</div>}
                        <div className="text-xs uppercase tracking-wide mt-1">{school?.examName || 'UJIAN'}</div>
                    </div>
                </div>
            );

            // 1. Kartu Peserta
            const CardLayout = () => {
                const filteredStudents = selectedRoom === 'all' ? students : students.filter(s => String(s.roomId) === String(selectedRoom));
                const chunks = [];
                for (let i = 0; i < filteredStudents.length; i += 8) { chunks.push(filteredStudents.slice(i, i + 8)); }
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pageIdx) => (
                            <div key={pageIdx} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                <div className="card-grid">
                                    {chunk.map(s => {
                                        const roomName = rooms.find(r => String(r.id) === String(s.roomId))?.name || '-';
                                        
                                        // --- LOGIC QR CODE LENGKAP ---
                                        // 1. Cari jadwal yang terhubung ke ruangan siswa ini
                                        const mySchedules = schedules.filter(sch => String(sch.roomId) === String(s.roomId));
                                        
                                        // 2. Ambil detail subject berdasarkan schedule
                                        const mySubjects = mySchedules.map(sch => {
                                            return subjects.find(sub => String(sub.id) === String(sch.subjectId));
                                        }).filter(Boolean); // Hapus jika undefined

                                        // 3. Urutkan berdasarkan Tanggal lalu Waktu
                                        mySubjects.sort((a, b) => {
                                            const dateA = a.date || '';
                                            const dateB = b.date || '';
                                            if (dateA !== dateB) return dateA.localeCompare(dateB);
                                            return (a.time || '').localeCompare(b.time || '');
                                        });

                                        // 4. Susun Text QR Code
                                        let qrInfo = `SISWA: ${s.name}\nNO: ${s.examNumber}\nKELAS: ${s.class}\nRUANG: ${roomName}\n\nJADWAL UJIAN:`;
                                        
                                        if (mySubjects.length > 0) {
                                            mySubjects.forEach((sub, idx) => {
                                                qrInfo += `\n${idx + 1}. ${sub.name}\n   [${sub.date}, ${sub.time}]`;
                                            });
                                        } else {
                                            qrInfo += "\n(Belum ada jadwal)";
                                        }

                                        // Encode ke URL QR Code
                                        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrInfo)}`;
                                        // -----------------------------
                                        
                                        return (
                                            <div key={s.id} className="exam-card">
                                                <div className="ec-header">
                                                    {schoolInfo.logo ? <img src={schoolInfo.logo} className="ec-logo" /> : <i className="fas fa-university text-3xl text-gray-400"></i>}
                                                    <div className="ec-title-box">
                                                        <div className="ec-agency">{schoolInfo.agency}</div>
                                                        <div className="ec-school">{schoolInfo.name}</div>
                                                        <div className="ec-exam">{schoolInfo.examName}</div>
                                                    </div>
                                                </div>
                                                <div className="ec-body">
                                                    <div className="ec-photo-box flex flex-col items-center justify-center bg-white p-1 border-slate-300 relative group">
                                                        <img src={qrUrl} alt="QR" className="w-full h-full object-contain" />
                                                        {/* Tooltip sederhana saat hover di layar (tidak tercetak) */}
                                                        <div className="absolute inset-0 bg-black bg-opacity-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity no-print">
                                                            <span className="text-[8px] bg-black text-white px-1 rounded">Scan Info</span>
                                                        </div>
                                                    </div>
                                                    <div className="ec-details">
                                                        <div>
                                                            <div className="ec-row"><div className="ec-label">No. Ujian</div><div className="ec-sep">:</div><div className="ec-val mono">{s.examNumber}</div></div>
                                                            <div className="ec-row"><div className="ec-label">Nama</div><div className="ec-sep">:</div><div className="ec-val uppercase">{s.name}</div></div>
                                                            <div className="ec-row"><div className="ec-label">Kelas</div><div className="ec-sep">:</div><div className="ec-val">{s.class}</div></div>
                                                            <div className="ec-row"><div className="ec-label">Ruang</div><div className="ec-sep">:</div><div className="ec-val">{roomName}</div></div>
                                                        </div>
                                                        <div className="ec-footer">
                                                            <div className="ec-signature" style={{ width: '140px', textAlign: 'center' }}>
                                                                <div style={{ marginBottom: '2px' }}>Jakarta, {new Date().toLocaleDateString('id-ID')}</div>
                                                                <div style={{ fontWeight: 'bold' }}>Kepala Sekolah</div>
                                                                <div className="ec-sign-space">
                                                                    {schoolInfo.signature && <img src={schoolInfo.signature} className="ec-sign-img" alt="TTD" />}
                                                                    {schoolInfo.stamp && <img src={schoolInfo.stamp} className="ec-stamp-img" alt="Cap" />}
                                                                </div>
                                                                <div className="ec-kepsek">{schoolInfo.headmaster}</div>
                                                                <div style={{ fontSize: '6pt' }}>NIP. {schoolInfo.headmasterNip}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            // 2. Daftar Hadir (Attendance)
            const AttendanceLayout = () => {
                const targetRooms = selectedRoom === 'all' ? rooms : rooms.filter(r => String(r.id) === String(selectedRoom));
                const activeSubject = subjects.find(s => String(s.id) === String(selectedSubject)) || subjects[0];
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {targetRooms.map(room => {
                            const roomStudents = students.filter(s => String(s.roomId) === String(room.id));
                            const schedule = schedules.find(s => String(s.subjectId) === String(activeSubject.id) && String(s.roomId) === String(room.id));
                            const t1 = teachers.find(t => String(t.id) === String(schedule?.invigilatorId));
                            
                            // FILL EMPTY ROWS
                            const rows = [...roomStudents];
                            while(rows.length < 20) {
                                rows.push({ id: `empty-${rows.length}`, name: '', examNumber: '' });
                            }

                            return (
                                <div key={room.id} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                    <DocHeader school={schoolInfo} title="DAFTAR HADIR PESERTA" subtitle={`RUANG: ${room.name}`} />
                                    <div className="flex justify-between text-sm mb-4 border-b border-black pb-2">
                                        <div><table><tbody><tr><td className="font-bold pr-4">Mata Pelajaran</td><td>: {activeSubject.name}</td></tr><tr><td className="font-bold pr-4">Hari / Tanggal</td><td>: {activeSubject.date}</td></tr></tbody></table></div>
                                        <div><table><tbody><tr><td className="font-bold pr-4">Waktu</td><td>: {activeSubject.time}</td></tr><tr><td className="font-bold pr-4">Jml Peserta</td><td>: {roomStudents.length} Org</td></tr></tbody></table></div>
                                    </div>
                                    <table className="doc-table">
                                        <thead><tr><th className="w-10">No</th><th className="w-32">No. Ujian</th><th>Nama Peserta</th><th className="w-32">Tanda Tangan</th><th className="w-16">Ket</th></tr></thead>
                                        <tbody>
                                            {rows.map((s, idx) => (
                                                <tr key={s.id}>
                                                    <td className="text-center h-8 align-middle">{idx + 1}</td>
                                                    <td className="text-center font-mono align-middle">{s.examNumber}</td>
                                                    <td className="uppercase align-middle pl-2">{s.name}</td>
                                                    <td className="text-left text-xs text-gray-400 align-bottom pl-2">
                                                        {s.name ? (idx % 2 === 0 ? `${idx + 1}..........` : `..........${idx + 1}`) : ''}
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="mt-8 flex justify-end text-sm"><div className="signature-box text-center w-64"><div className="mb-8"><div>Pengawas Ruang,</div></div><div className="font-bold underline mt-16">{t1?.name || '....................................'}</div><div>NIP. {t1?.nip || '-'}</div></div></div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // 3. Label Meja
            const DeskLabelLayout = () => {
                const filteredStudents = selectedRoom === 'all' ? students : students.filter(s => String(s.roomId) === String(selectedRoom));
                const chunks = []; for (let i = 0; i < filteredStudents.length; i += 4) { chunks.push(filteredStudents.slice(i, i + 4)); }
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pIdx) => (
                            <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                <div className="desk-label-grid">
                                    {chunk.map(s => (
                                        <div key={s.id} className="desk-label-card">
                                            <div className="text-xl font-bold uppercase mb-2">{schoolInfo.examName}</div>
                                            <div className="text-6xl font-black font-mono my-2 tracking-widest">{s.examNumber.split('-').pop()}</div>
                                            <div className="w-full border-t-2 border-black my-4"></div>
                                            <div className="text-xl font-bold uppercase">{s.name}</div>
                                            <div className="text-lg text-gray-600 mt-1">{s.class}</div>
                                            <div className="mt-auto text-sm bg-black text-white px-6 py-1 rounded-full font-mono">{s.examNumber}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            // 4. Laporan Kehadiran Pengawas (Real-time Report)
            const SupervisorListLayout = () => {
                const activeSubject = subjects.find(s => String(s.id) === String(selectedSubject)) || subjects[0];
                const relevantSchedules = schedules.filter(s => String(s.subjectId) === String(activeSubject?.id));
                const scheduledTeachers = relevantSchedules.map(sch => {
                    const teacher = teachers.find(t => String(t.id) === String(sch.invigilatorId));
                    const room = rooms.find(r => String(r.id) === String(sch.roomId));
                    const checkInTime = supervisorAttendance ? supervisorAttendance[sch.id] : null;
                    return { ...teacher, roomName: room?.name, checkInTime };
                }).filter(t => t.id).sort((a, b) => (a.roomName || '').localeCompare(b.roomName || ''));
                
                const ITEMS_PER_PAGE = 15; 
                const chunks = []; 
                
                if (scheduledTeachers.length === 0) {
                     chunks.push([]);
                } else {
                    for (let i = 0; i < scheduledTeachers.length; i += ITEMS_PER_PAGE) { 
                        chunks.push(scheduledTeachers.slice(i, i + ITEMS_PER_PAGE)); 
                    }
                }

                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pIdx) => {
                            const rows = [...chunk];
                            while(rows.length < ITEMS_PER_PAGE) {
                                rows.push({ id: `empty-${rows.length}`, name: '', nip: '', roomName: '', checkInTime: '' });
                            }

                            return (
                                <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break flex flex-col justify-between">
                                    <div>
                                        <DocHeader school={schoolInfo} title="LAPORAN HASIL CHECK-IN PENGAWAS" />
                                        <div className="mb-4 text-sm"> 
                                            <table className="w-full">
                                                <tbody>
                                                    <tr><td className="font-bold w-32">Hari / Tanggal</td><td>: {activeSubject?.date || '....................'}</td></tr>
                                                    <tr><td className="font-bold w-32">Mata Pelajaran</td><td>: {activeSubject?.name || '....................'}</td></tr>
                                                    <tr><td className="font-bold w-32">Waktu</td><td>: {activeSubject?.time || '....................'}</td></tr>
                                                </tbody>
                                            </table> 
                                        </div>
                                        <table className="doc-table w-full">
                                            <thead>
                                                <tr>
                                                    <th className="w-10 py-2">No</th>
                                                    <th className="py-2">Nama Pengawas</th>
                                                    <th className="w-32 py-2">NIP</th>
                                                    <th className="w-32 py-2">Ruang</th>
                                                    <th className="w-32 py-2">Waktu Check-In</th>
                                                    <th className="w-24 py-2">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {rows.map((t, idx) => {
                                                    const rowNum = idx + 1 + (pIdx * ITEMS_PER_PAGE);
                                                    const showNum = t.name ? rowNum : '';
                                                    return (
                                                        <tr key={t.id || idx}>
                                                            <td className="text-center py-2 h-10 align-middle">{showNum}</td>
                                                            <td className="font-bold px-2 py-2 uppercase align-middle text-xs">{t.name}</td>
                                                            <td className="text-center py-2 align-middle text-xs">{t.nip}</td>
                                                            <td className="text-center py-2 align-middle text-xs">{t.roomName}</td>
                                                            <td className="text-center py-2 font-mono align-middle text-xs">{t.checkInTime}</td>
                                                            <td className="text-center py-2 font-bold align-middle text-xs">
                                                                {t.name ? (t.checkInTime ? <span className="text-green-600">HADIR</span> : <span className="text-red-500">BELUM</span>) : ''}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* PERBAIKAN: Tanda Tangan Kepala Sekolah di Bagian Bawah */}
                                    <div className="mt-4 flex justify-end text-sm"> 
                                        <div className="signature-box text-center w-64"> 
                                            <div className="mb-4">
                                                <div>Mengetahui,</div>
                                                <div>Kepala Sekolah</div>
                                            </div> 
                                            <div className="ec-sign-space" style={{height: '60px'}}> 
                                                {schoolInfo.signature && <img src={schoolInfo.signature} className="sign-img" alt="TTD" />} 
                                                {schoolInfo.stamp && <img src={schoolInfo.stamp} className="stamp-img" alt="Cap" />} 
                                            </div> 
                                            <div className="font-bold underline mt-2">{schoolInfo.headmaster}</div> 
                                            <div>NIP. {schoolInfo.headmasterNip}</div> 
                                        </div> 
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // 5. Jadwal Pengawasan (Recap)
            const SupervisorScheduleLayout = () => {
                const fullSchedules = schedules.map(sch => {
                    const sub = subjects.find(s => String(s.id) === String(sch.subjectId));
                    const room = rooms.find(r => String(r.id) === String(sch.roomId));
                    const teacher = teachers.find(t => String(t.id) === String(sch.invigilatorId));
                    return { ...sch, sub, room, teacher };
                }).sort((a, b) => {
                    if (a.sub?.date !== b.sub?.date) return (a.sub?.date || '').localeCompare(b.sub?.date || '');
                    return (a.sub?.time || '').localeCompare(b.sub?.time || '');
                });
                
                const ITEMS_PER_PAGE = 15; 
                const chunks = []; 
                if (fullSchedules.length === 0) {
                     chunks.push([]);
                } else {
                    for (let i = 0; i < fullSchedules.length; i += ITEMS_PER_PAGE) { 
                        chunks.push(fullSchedules.slice(i, i + ITEMS_PER_PAGE)); 
                    }
                }

                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pIdx) => {
                            const rows = [...chunk];
                            while(rows.length < ITEMS_PER_PAGE) {
                                rows.push({ id: `empty-${rows.length}`, sub: {}, room: {}, teacher: {} });
                            }

                            return (
                                <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break flex flex-col justify-between">
                                    <div>
                                        <DocHeader school={schoolInfo} title="JADWAL TUGAS PENGAWASAN" />
                                        <table className="doc-table w-full">
                                            <thead>
                                                <tr>
                                                    <th className="w-10 py-2">No</th>
                                                    <th className="w-32 py-2">Hari / Tanggal</th>
                                                    <th className="w-24 py-2">Waktu</th>
                                                    <th className="py-2">Mata Pelajaran</th>
                                                    <th className="w-24 py-2">Ruang</th>
                                                    <th className="w-48 py-2">Nama Pengawas</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {rows.map((item, idx) => {
                                                    const rowNum = idx + 1 + (pIdx * ITEMS_PER_PAGE);
                                                    const showNum = item.sub?.name ? rowNum : '';
                                                    return (
                                                        <tr key={item.id || idx}>
                                                            <td className="text-center h-10 align-middle">{showNum}</td>
                                                            <td className="text-center align-middle text-xs">{item.sub?.date}</td>
                                                            <td className="text-center align-middle text-xs">{item.sub?.time}</td>
                                                            <td className="px-2 font-semibold align-middle text-xs">{item.sub?.name}</td>
                                                            <td className="text-center align-middle text-xs">{item.room?.name}</td>
                                                            <td className="px-2 uppercase align-middle text-xs">{item.teacher?.name || (item.sub?.name ? '-' : '')}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div className="mt-4 flex justify-end text-sm">
                                        <div className="signature-box text-center w-64">
                                            <div className="mb-4">
                                                <div>Mengetahui,</div>
                                                <div>Kepala Sekolah</div>
                                            </div>
                                            <div className="ec-sign-space" style={{height: '60px'}}>
                                                {schoolInfo.signature && <img src={schoolInfo.signature} className="sign-img" alt="TTD" />}
                                                {schoolInfo.stamp && <img src={schoolInfo.stamp} className="stamp-img" alt="Cap" />}
                                            </div>
                                            <div className="font-bold underline mt-2">{schoolInfo.headmaster}</div>
                                            <div>NIP. {schoolInfo.headmasterNip}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // 6. BA Serah Terima Naskah
            const HandoverScriptLayout = () => {
                const targetRooms = selectedRoom === 'all' ? rooms : rooms.filter(r => String(r.id) === String(selectedRoom));
                const activeSubject = subjects.find(s => String(s.id) === String(selectedSubject)) || subjects[0];
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {targetRooms.map(room => {
                            const schedule = schedules.find(s => String(s.subjectId) === String(activeSubject.id) && String(s.roomId) === String(room.id));
                            const teacher = teachers.find(t => String(t.id) === String(schedule?.invigilatorId));
                            const studentCount = students.filter(s => String(s.roomId) === String(room.id)).length;
                            return (
                                <div key={room.id} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                    <DocHeader school={schoolInfo} title="BERITA ACARA" subtitle="SERAH TERIMA NASKAH SOAL UJIAN" />
                                    <div className="text-justify leading-relaxed mb-6">
                                        <p>Pada hari ini <b>....................</b> tanggal <b>{activeSubject.date}</b>, telah diserahterimakan naskah soal ujian:</p>
                                        <table className="w-full mt-4 mb-4">
                                            <tbody>
                                                <tr><td className="w-40 py-1">Mata Pelajaran</td><td className="font-bold">: {activeSubject.name}</td></tr>
                                                <tr><td className="w-40 py-1">Ruang</td><td className="font-bold">: {room.name}</td></tr>
                                                <tr><td className="w-40 py-1">Jumlah Amplop</td><td>: 1 (Satu) Amplop Tertutup</td></tr>
                                                <tr><td className="w-40 py-1">Jumlah Eksemplar</td><td>: {studentCount} Eksemplar + Cadangan</td></tr>
                                            </tbody>
                                        </table>
                                        <p>Naskah soal tersebut diserahkan dalam keadaan baik dan tersegel. Demikian berita acara ini dibuat untuk dapat dipergunakan sebagaimana mestinya.</p>
                                    </div>
                                    <div className="signature-grid mt-16">
                                        <div className="signature-box">
                                            <div className="mb-16">Yang Menyerahkan<br/>(Panitia Ujian)</div>
                                            <div className="font-bold underline">( ............................................ )</div>
                                        </div>
                                        <div className="signature-box">
                                            <div className="mb-16">Yang Menerima<br/>(Pengawas Ruang)</div>
                                            <div className="font-bold underline">{teacher?.name || '( ............................................ )'}</div>
                                            <div>NIP. {teacher?.nip || '-'}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // 7. BA Serah Terima LJK
            const HandoverAnswerLayout = () => {
                const targetRooms = selectedRoom === 'all' ? rooms : rooms.filter(r => String(r.id) === String(selectedRoom));
                const activeSubject = subjects.find(s => String(s.id) === String(selectedSubject)) || subjects[0];
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {targetRooms.map(room => {
                            const schedule = schedules.find(s => String(s.subjectId) === String(activeSubject.id) && String(s.roomId) === String(room.id));
                            const teacher = teachers.find(t => String(t.id) === String(schedule?.invigilatorId));
                            const studentCount = students.filter(s => String(s.roomId) === String(room.id)).length;
                            return (
                                <div key={room.id} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                    <DocHeader school={schoolInfo} title="BERITA ACARA" subtitle="SERAH TERIMA LEMBAR JAWABAN UJIAN" />
                                    <div className="text-justify leading-relaxed mb-6">
                                        <p>Pada hari ini <b>....................</b> tanggal <b>{activeSubject.date}</b>, telah diserahterimakan Lembar Jawaban Ujian (LJK) dari Pengawas Ruang kepada Panitia/Guru Mata Pelajaran:</p>
                                        <table className="w-full mt-4 mb-4">
                                            <tbody>
                                                <tr><td className="w-48 py-1">Mata Pelajaran</td><td className="font-bold">: {activeSubject.name}</td></tr>
                                                <tr><td className="w-48 py-1">Ruang</td><td className="font-bold">: {room.name}</td></tr>
                                                <tr><td className="w-48 py-1">Jml Peserta Terdaftar</td><td>: {studentCount} Orang</td></tr>
                                                <tr><td className="w-48 py-1">Jml Peserta Hadir</td><td>: ....... Orang</td></tr>
                                                <tr><td className="w-48 py-1">Jml LJK Diserahkan</td><td>: ....... Lembar</td></tr>
                                                <tr><td className="w-48 py-1">Berita Acara & Absensi</td><td>: Lengkap / Tidak Lengkap *)</td></tr>
                                            </tbody>
                                        </table>
                                        <p>Demikian berita acara serah terima ini dibuat dengan sebenar-benarnya.</p>
                                    </div>
                                    <div className="signature-grid mt-16">
                                        <div className="signature-box">
                                            <div className="mb-16">Yang Menyerahkan<br/>(Pengawas Ruang)</div>
                                            <div className="font-bold underline">{teacher?.name || '( ............................................ )'}</div>
                                            <div>NIP. {teacher?.nip || '-'}</div>
                                        </div>
                                        <div className="signature-box">
                                            <div className="mb-16">Yang Menerima<br/>(Panitia / Guru Mapel)</div>
                                            <div className="font-bold underline">( ............................................ )</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // 8. Daftar Pengambilan LJK oleh Guru (FITUR BARU)
            const CollectionListLayout = () => {
                // Filter guru yang memiliki data mapel/kelas (asumsi guru aktif)
                const activeTeachers = teachers.filter(t => t.subjects && t.subjects.length > 0).sort((a,b) => a.name.localeCompare(b.name));
                
                // PERBAIKAN: Kurangi baris per halaman agar muat tanda tangan
                const ITEMS_PER_PAGE = 10; 
                
                const chunks = [];
                if (activeTeachers.length === 0) {
                     chunks.push([]);
                } else {
                    for (let i = 0; i < activeTeachers.length; i += ITEMS_PER_PAGE) {
                        chunks.push(activeTeachers.slice(i, i + ITEMS_PER_PAGE));
                    }
                }

                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pIdx) => {
                            // FILL EMPTY ROWS agar tabel selalu penuh proporsional
                            const rows = [...chunk];
                            while(rows.length < ITEMS_PER_PAGE) {
                                rows.push({ id: `empty-${rows.length}` });
                            }

                            return (
                                <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break flex flex-col justify-between">
                                    <div>
                                        <DocHeader school={schoolInfo} title="DAFTAR PENGAMBILAN LEMBAR JAWABAN" />
                                        
                                        <table className="doc-table w-full">
                                            <thead>
                                                <tr>
                                                    <th className="w-10 py-2">No</th>
                                                    <th className="py-2">Nama Guru & NIP</th>
                                                    <th className="w-1/4 py-2">Mata Pelajaran Diampu</th>
                                                    <th className="w-1/4 py-2">Kelas Diajar</th>
                                                    <th className="w-32 py-2">Tanda Tangan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {rows.map((t, idx) => {
                                                    const globalIdx = idx + 1 + (pIdx * ITEMS_PER_PAGE);
                                                    // Cek apakah ini baris data atau baris kosong
                                                    const isData = !!t.name;

                                                    return (
                                                        <tr key={t.id || idx}>
                                                            <td className="text-center align-top py-2 h-16">{isData ? globalIdx : ''}</td>
                                                            <td className="align-top py-2 px-2">
                                                                {isData && (
                                                                    <>
                                                                        <div className="font-bold uppercase text-xs">{t.name}</div>
                                                                        <div className="text-[10px] text-gray-500 mt-1">NIP. {t.nip}</div>
                                                                    </>
                                                                )}
                                                            </td>
                                                            <td className="align-top py-2 px-2 text-xs">
                                                                {isData && t.subjects && t.subjects.length > 0 ? (
                                                                    <ul className="list-disc list-inside">
                                                                        {t.subjects.map((sub, i) => <li key={i}>{sub}</li>)}
                                                                    </ul>
                                                                ) : (isData ? '-' : '')}
                                                            </td>
                                                            <td className="align-top py-2 px-2 text-xs">
                                                                {isData && t.classes ? (
                                                                    <div className="leading-relaxed">{t.classes.join(', ')}</div>
                                                                ) : (isData ? '-' : '')}
                                                            </td>
                                                            <td className="text-left align-bottom px-2 text-xs text-gray-400 border-b-0">
                                                                {isData ? (globalIdx % 2 === 1 ? `${globalIdx}..........` : `..........${globalIdx}`) : ''}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {/* PERBAIKAN: Tanda Tangan Lengkap (Panitia & Kepala Sekolah) */}
                                    <div className="mt-4 flex justify-between text-sm items-end">
                                        <div className="signature-box text-center w-64">
                                            {/* Posisi Hari/Tanggal dipindah ke sini */}
                                            <div className="mb-2 text-left pl-2 font-bold" style={{fontSize: '11px'}}>
                                                Hari/Tanggal: .......................................
                                            </div>
                                            <div className="mb-4">
                                                <div>Koordinator Ujian / Panitia,</div>
                                            </div>
                                            <div className="ec-sign-space" style={{height: '60px'}}>
                                                {/* Space untuk TTD Panitia manual */}
                                            </div>
                                            <div className="font-bold underline mt-2">( ............................................ )</div>
                                        </div>

                                        <div className="signature-box text-center w-64">
                                            <div className="mb-4">
                                                <div>Mengetahui,</div>
                                                <div>Kepala Sekolah</div>
                                            </div>
                                            <div className="ec-sign-space" style={{height: '60px'}}>
                                                {schoolInfo.signature && <img src={schoolInfo.signature} className="sign-img" alt="TTD" />}
                                                {schoolInfo.stamp && <img src={schoolInfo.stamp} className="stamp-img" alt="Cap" />}
                                            </div>
                                            <div className="font-bold underline mt-2">{schoolInfo.headmaster}</div>
                                            <div>NIP. {schoolInfo.headmasterNip}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // Main Render Switch
            if (view === 'cards') return <CardLayout />;
            if (view === 'attendance') return <AttendanceLayout />;
            if (view === 'label') return <DeskLabelLayout />;
            if (view === 'supervisor') return <SupervisorListLayout />;
            if (view === 'supervisor_schedule') return <SupervisorScheduleLayout />;
            if (view === 'ba_naskah') return <HandoverScriptLayout />;
            if (view === 'ba_ljk') return <HandoverAnswerLayout />;
            if (view === 'collection') return <CollectionListLayout />; // Tambahan

            return (
                <div className="animate-fade-in-down">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">Pusat Cetak</h2>
                    <p className="text-gray-500 mb-8">Pilih jenis dokumen yang ingin dicetak.</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <DocCard title="Kartu Peserta" desc="Cetak kartu identitas ujian untuk semua siswa." icon="fa-id-card" color="text-blue-500" onClick={() => setView('cards')} />
                        <DocCard title="Daftar Hadir Siswa" desc="Lembar absensi tanda tangan peserta per ruang." icon="fa-clipboard-list" color="text-green-500" onClick={() => setView('attendance')} />
                        <DocCard title="Label Meja" desc="Nomor peserta ukuran besar untuk ditempel di meja." icon="fa-tag" color="text-orange-500" onClick={() => setView('label')} />
                        <DocCard title="Laporan Kehadiran Pengawas" desc="Rekapitulasi otomatis check-in pengawas di ruang ujian." icon="fa-user-clock" color="text-teal-600" onClick={() => setView('supervisor')} />
                        <DocCard title="Jadwal Pengawas" desc="Rekapitulasi jadwal tugas mengawas yang telah digenerate." icon="fa-calendar-day" color="text-indigo-600" onClick={() => setView('supervisor_schedule')} />
                        <DocCard title="Daftar Pengambilan LJK" desc="Lembar tanda tangan guru saat mengambil hasil jawaban siswa." icon="fa-file-signature" color="text-pink-600" onClick={() => setView('collection')} />
                        <DocCard title="BA Serah Terima Naskah" desc="Dokumen serah terima soal dari panitia ke pengawas." icon="fa-file-import" color="text-rose-600" onClick={() => setView('ba_naskah')} />
                        <DocCard title="BA Serah Terima LJK" desc="Dokumen serah terima jawaban dari pengawas ke panitia." icon="fa-file-export" color="text-purple-600" onClick={() => setView('ba_ljk')} />
                    </div>
                </div>
            );
        };

        const Settings = ({ info, setInfo, onReset }) => {
            const [toast, setToast] = useState(null);
            
            useEffect(() => { 
                if (toast) { 
                    const timer = setTimeout(() => setToast(null), 3000); 
                    return () => clearTimeout(timer); 
                } 
            }, [toast]);

            const handleChange = (e) => setInfo({...info, [e.target.name]: e.target.value});
            
            const handleImageUpload = (e, field) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setInfo(prev => ({ ...prev, [field]: ev.target.result }));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = () => {
                // Di sistem nyata ini akan save ke Firebase via useFirestoreState otomatis
                // Kita cuma kasih feedback UI aja
                setToast({ type: 'success', message: 'Konfigurasi tersimpan ke Cloud.' });
            };

            const handleReset = () => {
                if(confirm("PERINGATAN KERAS:\nSemua data (Siswa, Guru, Jadwal, Laporan) akan dihapus permanen dari Cloud Database dan tidak bisa dikembalikan.\n\nKetik 'RESET' untuk melanjutkan.")) {
                    onReset();
                    alert("Data telah di-reset ke kondisi awal (Pabrik).");
                }
            };

            return (
                <div className="animate-fade-in-down max-w-4xl">
                    {toast && (
                        <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 text-white transform transition-all duration-300 animate-fade-in-down border-l-4 border-white/20 backdrop-blur-sm ${toast.type === 'success' ? 'bg-emerald-600/95' : 'bg-rose-600/95'}`}>
                            <div className="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center"><i className={`fas ${toast.type === 'success' ? 'fa-check' : 'fa-exclamation'} text-sm`}></i></div>
                            <div><h4 className="font-bold text-sm tracking-wide">{toast.type === 'success' ? 'BERHASIL' : 'GAGAL'}</h4><p className="text-xs opacity-90">{toast.message}</p></div>
                            <button onClick={() => setToast(null)} className="ml-2 opacity-70 hover:opacity-100 hover:rotate-90 transition-transform"><i className="fas fa-times"></i></button>
                        </div>
                    )}

                    <h2 className="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <i className="fas fa-cog text-gray-400"></i> Pengaturan Sekolah
                    </h2>
                    
                    <div className="bg-white rounded-xl shadow-lg border border-gray-100 p-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Identitas Instansi */}
                            <div className="md:col-span-2 pb-4 border-b border-gray-100 mb-2">
                                <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center"><i className="fas fa-building text-blue-500 mr-2"></i> Identitas Instansi</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nama Instansi / Dinas</label>
                                        <input name="agency" value={info.agency || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-gray-50 focus:bg-white" placeholder="DINAS PENDIDIKAN..." />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nama Sekolah</label>
                                        <input name="name" value={info.name || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-gray-50 focus:bg-white" />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Alamat Lengkap</label>
                                        <input name="address" value={info.address || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-gray-50 focus:bg-white" />
                                    </div>
                                </div>
                            </div>

                            {/* Detail Ujian */}
                            <div className="md:col-span-2 pb-4 border-b border-gray-100 mb-2">
                                <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center"><i className="fas fa-file-alt text-purple-500 mr-2"></i> Detail Ujian</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nama Ujian (Kop Surat)</label>
                                        <input name="examName" value={info.examName || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Tahun Ajaran</label>
                                        <input name="year" value={info.year || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition" />
                                    </div>
                                </div>
                            </div>

                            {/* Pejabat */}
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Kepala Sekolah</label>
                                <input name="headmaster" value={info.headmaster || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">NIP Kepala Sekolah</label>
                                <input name="headmasterNip" value={info.headmasterNip || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition" />
                            </div>

                            {/* --- FORMAT NOMOR PESERTA --- */}
                            <div className="md:col-span-2 pb-4 border-b border-gray-100 mb-2">
                                <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center"><i className="fas fa-barcode text-indigo-500 mr-2"></i> Format Nomor Peserta</h3>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Template Format</label>
                                    <input name="studentIdFormat" value={info.studentIdFormat || '{YY}-{CLASS}-{NUM}'} onChange={handleChange} className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition font-mono" placeholder="{YY}-{CLASS}-{NUM}" />
                                    <p className="text-xs text-gray-500 mt-2">
                                        Gunakan placeholder: <span className="font-mono bg-gray-100 px-1 rounded">{'{YY}'}</span> (Tahun 2 digit), <span className="font-mono bg-gray-100 px-1 rounded">{'{YYYY}'}</span> (Tahun 4 digit), <span className="font-mono bg-gray-100 px-1 rounded">{'{CLASS}'}</span> (Kode Kelas), <span className="font-mono bg-gray-100 px-1 rounded">{'{NUM}'}</span> (No Urut).
                                        <br/>Contoh hasil: <span className="font-bold">24-XIP-001</span>
                                    </p>
                                </div>
                            </div>

                            {/* Keamanan */}
                            <div className="md:col-span-2 mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100">
                                <h3 className="font-bold text-yellow-800 mb-4 flex items-center"><i className="fas fa-shield-alt mr-2"></i> Keamanan Akses</h3>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Password Admin</label>
                                    <div className="relative">
                                        <i className="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                                        <input type="text" name="adminPassword" value={info.adminPassword || ''} onChange={handleChange} className="w-full border border-gray-300 p-3 pl-10 rounded-lg bg-white focus:ring-2 focus:ring-yellow-500 outline-none transition" placeholder="Masukkan password baru..." />
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2 italic"><i className="fas fa-info-circle mr-1"></i> Default password adalah "admin". Segera ganti untuk keamanan sistem.</p>
                                </div>
                            </div>

                            {/* Upload Assets */}
                            <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6 pt-6 border-t border-gray-200">
                                <div className="text-center group">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-3">Logo Sekolah</label>
                                    <div className="relative w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden group-hover:border-blue-400 transition cursor-pointer">
                                        {info.logo ? <img src={info.logo} className="h-full object-contain p-2" /> : <div className="text-gray-400"><i className="fas fa-image text-2xl mb-2"></i><div className="text-xs">Upload Logo</div></div>}
                                        <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'logo')} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                                <div className="text-center group">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-3">Tanda Tangan KS</label>
                                    <div className="relative w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden group-hover:border-blue-400 transition cursor-pointer">
                                        {info.signature ? <img src={info.signature} className="h-full object-contain p-2" /> : <div className="text-gray-400"><i className="fas fa-signature text-2xl mb-2"></i><div className="text-xs">Upload TTD</div></div>}
                                        <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'signature')} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                                <div className="text-center group">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-3">Cap Sekolah</label>
                                    <div className="relative w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden group-hover:border-blue-400 transition cursor-pointer">
                                        {info.stamp ? <img src={info.stamp} className="h-full object-contain p-2" /> : <div className="text-gray-400"><i className="fas fa-stamp text-2xl mb-2"></i><div className="text-xs">Upload Cap</div></div>}
                                        <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'stamp')} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="mt-10 flex flex-col md:flex-row justify-between items-center gap-4 pt-6 border-t border-gray-200">
                            <button onClick={handleReset} className="text-red-500 hover:text-red-700 font-bold text-sm px-4 py-2 rounded-lg hover:bg-red-50 transition flex items-center">
                                <i className="fas fa-trash-alt mr-2"></i> Reset Data Aplikasi
                            </button>
                            <button onClick={handleSave} className="w-full md:w-auto bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-indigo-800 transition transform active:scale-95 flex items-center justify-center">
                                <i className="fas fa-save mr-2"></i> Simpan Pengaturan
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ stats, schedules, subjects, rooms = [], students = [], attendance = {} }) => {
            const [date, setDate] = useState(new Date());
            const [viewMode, setViewMode] = useState('grid');
            
            useEffect(() => { const timer = setInterval(() => setDate(new Date()), 60000); return () => clearInterval(timer); }, []);
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            // Logic Monitoring Ruang
            const roomStats = rooms.map(room => {
                const roomStudents = students.filter(s => String(s.roomId) === String(room.id));
                const total = roomStudents.length;
                const roomSchedules = schedules.filter(s => String(s.roomId) === String(room.id));
                const uniqueAbsentStudents = new Set();
                roomSchedules.forEach(sch => {
                    const key = `${sch.subjectId}-${sch.roomId}`;
                    const log = attendance[key] || {};
                    Object.entries(log).forEach(([studentId, status]) => {
                        if (['S', 'I', 'A'].includes(status)) {
                            uniqueAbsentStudents.add(studentId);
                        }
                    });
                });
                const absentList = Array.from(uniqueAbsentStudents).map(id => {
                    const st = students.find(s => String(s.id) === String(id));
                    return st ? st.name : `ID: ${id}`;
                });
                return { ...room, total, absentCount: uniqueAbsentStudents.size, absentList };
            });

            return ( 
                <div className="space-y-8 animate-fade-in-down pb-10"> 
                    <div className="flex flex-col md:flex-row justify-between items-end gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100"> 
                        <div><h2 className="text-2xl font-bold text-slate-800">Dashboard Overview</h2><p className="text-slate-500 mt-1">Pantau aktivitas asesmen secara real-time (Online Mode).</p></div> 
                        <div className="text-right"><div className="text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full inline-block mb-1">{date.toLocaleDateString('id-ID', dateOptions)}</div><p className="text-xs text-slate-400">Semester Ganjil 2023/2024</p></div> 
                    </div> 
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"> 
                        <StatCard title="Total Peserta" value={stats.s || 0} icon="fa-user-graduate" color="text-blue-600" /> 
                        <StatCard title="Pengawas" value={stats.t || 0} icon="fa-chalkboard-teacher" color="text-emerald-600" /> 
                        <StatCard title="Mapel Ujian" value={stats.m || 0} icon="fa-book" color="text-violet-600" /> 
                        <StatCard title="Ruang Ujian" value={stats.r || 0} icon="fa-door-open" color="text-orange-600" /> 
                    </div> 
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2">
                                <div className="bg-rose-100 text-rose-600 w-8 h-8 rounded flex items-center justify-center"><i className="fas fa-clipboard-check"></i></div>
                                <h3 className="font-bold text-slate-700 text-lg">Monitoring Kehadiran Per Ruang</h3>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setViewMode('grid')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${viewMode === 'grid' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><i className="fas fa-th-large mr-1"></i> Kartu</button>
                                <button onClick={() => setViewMode('table')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${viewMode === 'table' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><i className="fas fa-list mr-1"></i> Tabel</button>
                            </div>
                        </div>
                        {viewMode === 'grid' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {roomStats.map(r => (
                                    <div key={r.id} className="border border-slate-200 rounded-xl p-4 bg-slate-50 hover:bg-white hover:shadow-md transition duration-300">
                                        <div className="flex justify-between items-start mb-3 border-b border-slate-200 pb-3"><div><div className="font-bold text-slate-800 text-lg">{r.name}</div><div className="text-xs text-slate-500">Kapasitas: {r.capacity} Kursi</div></div><div className="text-right"><div className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Total Siswa</div><div className="text-xl font-black text-slate-700">{r.total}</div></div></div>
                                        <div className="bg-white rounded-lg p-3 border border-slate-100">
                                            <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-rose-600 uppercase tracking-wide">Tidak Hadir</span><span className={`text-lg font-bold ${r.absentCount > 0 ? 'text-rose-600' : 'text-emerald-500'}`}>{r.absentCount} <span className="text-xs font-normal text-slate-400">Siswa</span></span></div>
                                            {r.absentCount > 0 ? (<div className="mt-2 space-y-1 max-h-24 overflow-y-auto custom-scrollbar">{r.absentList.map((name, i) => (<div key={i} className="text-xs text-slate-600 bg-rose-50 px-2 py-1 rounded border border-rose-100 flex items-center gap-2"><i className="fas fa-times-circle text-rose-400 text-[10px]"></i><span className="truncate">{name}</span></div>))}</div>) : (<div className="text-xs text-emerald-600 bg-emerald-50 px-2 py-2 rounded border border-emerald-100 text-center font-medium"><i className="fas fa-check-circle mr-1"></i> Semua Hadir / Belum Absen</div>)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="overflow-x-auto border border-slate-200 rounded-lg">
                                <table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200"><tr><th className="px-4 py-3">Nama Ruang</th><th className="px-4 py-3 text-center">Kapasitas</th><th className="px-4 py-3 text-center">Total Siswa</th><th className="px-4 py-3 text-center">Hadir</th><th className="px-4 py-3 text-center">Tidak Hadir</th><th className="px-4 py-3 w-1/3">Detail Ketidakhadiran</th></tr></thead><tbody className="divide-y divide-slate-100 bg-white">{roomStats.map(r => (<tr key={r.id} className="hover:bg-slate-50"><td className="px-4 py-3 font-bold text-slate-700">{r.name}</td><td className="px-4 py-3 text-center text-slate-500">{r.capacity}</td><td className="px-4 py-3 text-center font-bold">{r.total}</td><td className="px-4 py-3 text-center text-emerald-600 font-bold">{r.total - r.absentCount}</td><td className={`px-4 py-3 text-center font-bold ${r.absentCount > 0 ? 'text-rose-600' : 'text-slate-300'}`}>{r.absentCount}</td><td className="px-4 py-3">{r.absentCount > 0 ? (<div className="flex flex-wrap gap-1">{r.absentList.map((name, i) => (<span key={i} className="text-[10px] bg-rose-50 text-rose-600 px-2 py-0.5 rounded border border-rose-100 truncate max-w-[150px]" title={name}>{name}</span>))}</div>) : (<span className="text-xs text-emerald-500 italic"><i className="fas fa-check mr-1"></i> Lengkap</span>)}</td></tr>))}</tbody></table>
                            </div>
                        )}
                    </div>
                </div> 
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [page, setPage] = useState('dashboard');
            
            const [students, setStudents, l1] = useFirestoreState(initialStudents, 'students');
            const [teachers, setTeachers, l2] = useFirestoreState(initialTeachers, 'teachers');
            const [subjects, setSubjects, l3] = useFirestoreState(initialSubjects, 'subjects');
            const [rooms, setRooms, l4] = useFirestoreState(initialRooms, 'rooms');
            const [schoolInfo, setSchoolInfo, l5] = useFirestoreState(initialSchoolInfo, 'schoolInfo');
            const [schedules, setSchedules, l6] = useFirestoreState([], 'schedules');
            const [studentAttendance, setStudentAttendance, l7] = useFirestoreState({}, 'attendance');
            const [violationLogs, setViolationLogs, l8] = useFirestoreState({}, 'logs');
            const [teacherAgreements, setTeacherAgreements, l9] = useFirestoreState({}, 'teacherAgreements');
            const [supervisorAttendance, setSupervisorAttendance, l10] = useFirestoreState({}, 'supervisorAttendance');

            const isLoading = l1 || l2 || l3 || l4 || l5 || l6 || l7 || l8 || l9 || l10;
            const stats = useMemo(() => ({ s: students.length, t: teachers.length, m: subjects.length, r: rooms.length, sch: schedules.length }), [students, teachers, subjects, rooms, schedules]);

            if (isLoading) return <div className="loading-screen"><div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div><p className="text-gray-500 font-medium">Menghubungkan ke Server Sekolah...</p></div>;

            if (!user) return <LoginPage teachers={teachers} schoolInfo={schoolInfo} onLogin={setUser} />;

            if (user.role === 'teacher') {
                return <TeacherDashboard 
                    user={user} 
                    schedules={schedules} 
                    subjects={subjects} 
                    rooms={rooms} 
                    onLogout={() => setUser(null)} 
                    studentAttendance={studentAttendance} 
                    setStudentAttendance={setStudentAttendance} 
                    violationLogs={violationLogs} 
                    setViolationLogs={setViolationLogs}
                    teacherAgreements={teacherAgreements}
                    setTeacherAgreements={setTeacherAgreements}
                    supervisorAttendance={supervisorAttendance}
                    setSupervisorAttendance={setSupervisorAttendance}
                />;
            }

            return (
                <div className="min-h-screen flex text-gray-800 font-sans main-content-wrapper">
                    <div className="w-64 bg-slate-800 text-slate-300 flex flex-col shadow-2xl z-20 no-print fixed h-full">
                        <div className="p-6 text-center border-b border-slate-700"> <i className="fas fa-layer-group text-4xl text-blue-500 mb-3"></i> <h1 className="text-white font-bold text-xl tracking-tight">Admin Panel</h1> </div>
                        <nav className="flex-1 p-4 overflow-y-auto"> 
                            <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-2">Menu Utama</p> 
                            <NavButton active={page==='dashboard'} onClick={()=>setPage('dashboard')} icon="fa-home" label="Dashboard" /> 
                            <NavButton active={page==='master'} onClick={()=>setPage('master')} icon="fa-database" label="Data Master" /> 
                            <NavButton active={page==='schedule'} onClick={()=>setPage('schedule')} icon="fa-calendar-alt" label="Jadwal Ujian" /> 
                            <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-6">Cetak & Laporan</p> 
                            <NavButton active={page==='print'} onClick={()=>setPage('print')} icon="fa-print" label="Pusat Cetak" /> 
                            <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-6">Konfigurasi</p> 
                            <NavButton active={page==='settings'} onClick={()=>setPage('settings')} icon="fa-cog" label="Pengaturan" /> 
                        </nav>
                        <div className="p-4 border-t border-slate-700"> <button onClick={()=>setUser(null)} className="flex items-center text-red-400 hover:text-red-300 transition w-full p-2"><i className="fas fa-sign-out-alt w-8"></i> Logout</button> </div>
                    </div>
                    <div className="flex-1 ml-64 p-8 overflow-y-auto h-screen print:ml-0 print:p-0">
                         {page === 'dashboard' && <Dashboard stats={stats} schedules={schedules} subjects={subjects} rooms={rooms} students={students} attendance={studentAttendance} />}
                         {page === 'master' && <DataMaster students={students} setStudents={setStudents} teachers={teachers} setTeachers={setTeachers} subjects={subjects} setSubjects={setSubjects} rooms={rooms} setRooms={setRooms} schoolInfo={schoolInfo} />}
                         {page === 'schedule' && <ScheduleManager subjects={subjects} rooms={rooms} teachers={teachers} schedules={schedules} setSchedules={setSchedules} />}
                         {page === 'print' && <PrintCenter schoolInfo={schoolInfo} students={students} rooms={rooms} subjects={subjects} schedules={schedules} teachers={teachers} supervisorAttendance={supervisorAttendance} />}
                         {page === 'settings' && <Settings info={schoolInfo} setInfo={setSchoolInfo} onReset={() => {
                            setStudents(initialStudents);
                            setTeachers(initialTeachers);
                            setSubjects(initialSubjects);
                            setRooms(initialRooms);
                            setSchedules([]);
                            setStudentAttendance({});
                            setSupervisorAttendance({});
                            setTeacherAgreements({});
                            setViolationLogs({});
                         }} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
