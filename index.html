<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Administrasi Asesmen (Online)</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        
        // Expose Firebase to Window so React can use it
        window.firebaseModules = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }

        /* --- SETTING CETAK (PRINT) --- */
        @media print {
            @page { 
                size: A4; 
                margin: 0; 
            }
            
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: white;
            }

            .no-print, .no-print * {
                display: none !important;
                height: 0 !important;
                width: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            #root, .main-content-wrapper, .print-wrapper {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: none !important;
                position: static !important;
                background: white !important;
            }

            .a4-sheet {
                margin: 0 !important;
                padding: 10mm !important;
                width: 210mm !important;
                height: 296mm !important; 
                box-shadow: none !important;
                border: none !important;
                page-break-after: always;
                page-break-inside: avoid;
                overflow: hidden !important;
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
            }
        }

        .print-only { display: none; }
        
        /* --- LAYOUT KERTAS A4 (Layar Monitor) --- */
        .a4-sheet {
            background: white;
            width: 210mm;
            height: 297mm;
            padding: 10mm; 
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }

        .doc-header { border-bottom: 3px double black; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
        .doc-table th, .doc-table td { border: 1px solid black; padding: 5px; }
        .doc-table th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
        
        /* --- KARTU PESERTA (8 per halaman) --- */
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            gap: 4mm;
            height: 100%;
        }
        
        .exam-card {
            border: 1px solid #000;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            box-sizing: border-box;
            position: relative;
            font-size: 8pt;
            overflow: hidden;
        }

        .ec-header { border-bottom: 2px double #000; padding: 4px; display: flex; align-items: center; gap: 6px; height: 15mm; }
        .ec-logo { width: 30px; height: 30px; object-fit: contain; }
        .ec-title-box { flex: 1; text-align: center; line-height: 1.1; }
        .ec-agency { font-size: 5pt; text-transform: uppercase; font-weight: bold; }
        .ec-school { font-size: 7pt; font-weight: 800; text-transform: uppercase; }
        .ec-exam { font-size: 6pt; font-weight: bold; margin-top: 1px; }

        .ec-body { padding: 4px; flex: 1; display: flex; gap: 6px; }
        .ec-photo-box { width: 20mm; height: 25mm; border: 1px solid #aaa; background: #f9f9f9; display: flex; align-items: center; justify-content: center; font-size: 6pt; text-align: center; color: #bbb; flex-shrink: 0; margin-top: 2px; }
        
        .ec-details { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .ec-row { display: flex; margin-bottom: 1px; line-height: 1.2; }
        .ec-label { width: 50px; font-weight: 600; font-size: 7.5pt; }
        .ec-sep { width: 5px; text-align: center; font-size: 7.5pt; }
        .ec-val { flex: 1; font-weight: bold; font-size: 8pt; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ec-val.mono { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }

        .ec-footer { display: flex; justify-content: flex-end; align-items: flex-end; margin-top: auto; font-size: 7pt; }
        .ec-signature { text-align: center; width: 120px; line-height: 1.1; position: relative; }
        .ec-sign-space { height: 30px; position: relative; width: 100%; }
        .ec-sign-img { height: 100%; width: auto; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 2; object-fit: contain; }
        .ec-stamp-img { height: 110%; width: auto; position: absolute; bottom: -5px; left: 10px; transform: rotate(-5deg); z-index: 1; opacity: 0.85; object-fit: contain; }
        .ec-kepsek { font-weight: bold; text-decoration: underline; font-size: 7pt; margin-top: 2px; position: relative; z-index: 3; }
        .ec-nip { font-size: 6pt; }

        /* --- KARTU MEJA (4 per halaman) --- */
        .desk-label-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10mm;
            height: 100%;
        }

        .desk-label-card {
            border: 4px solid #333;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            position: relative;
        }

        /* --- UTILS --- */
        .modal-backdrop { background-color: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; z-index: 50; }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI FIREBASE ---
        // PENTING: Ganti dengan konfigurasi dari Firebase Console Anda
        const firebaseConfig = {
          apiKey: "AIzaSyBXmFBcJix6doD1ZWxZ-bio-oqpeYqT7bM", // GANTI DENGAN API KEY ANDA
          authDomain: "manajemenass.firebaseapp.com",
          projectId: "manajemenass",
          storageBucket: "manajemenass.firebasestorage.app",
          messagingSenderId: "665901034368",
          appId: "1:665901034368:web:ae4b55872ff47955b82f65"
        };
        
        // --- REACT LOGIC ---
        const { useState, useEffect, useMemo, useRef } = React;

        let db, auth;
        const waitForFirebase = () => new Promise(resolve => {
            const check = () => {
                if(window.firebaseModules) resolve(window.firebaseModules);
                else setTimeout(check, 100);
            };
            check();
        });

        // --- HOOK: FIREBASE FIRESTORE SYNC ---
        const useFirestoreState = (defaultValue, collectionKey) => {
            const [value, setValue] = useState(defaultValue);
            const [loading, setLoading] = useState(true);
            const [isDbReady, setIsDbReady] = useState(false);

            useEffect(() => {
                let unsubscribe = () => {};

                const initSync = async () => {
                    if (!db) {
                        const fb = await waitForFirebase();
                        const app = fb.initializeApp(firebaseConfig); 
                        db = fb.getFirestore(app);
                        auth = fb.getAuth(app);
                        await fb.signInAnonymously(auth);
                    }

                    const { doc, onSnapshot, setDoc } = window.firebaseModules;
                    const docRef = doc(db, 'artifacts', 'sekolah_demo', 'data', collectionKey);

                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            setValue(docSnap.data().val);
                        } else {
                            setDoc(docRef, { val: defaultValue });
                        }
                        setLoading(false);
                    });
                    setIsDbReady(true);
                };

                initSync();
                return () => unsubscribe();
            }, [collectionKey]);

            const updateValue = (newValue) => {
                setValue(currentData => {
                    const resolvedValue = typeof newValue === 'function' ? newValue(currentData) : newValue;
                    if(isDbReady) {
                        const { doc, setDoc } = window.firebaseModules;
                        const docRef = doc(db, 'artifacts', 'sekolah_demo', 'data', collectionKey);
                        setDoc(docRef, { val: resolvedValue === undefined ? null : resolvedValue })
                            .catch(err => console.error("Firestore Save Error:", err)); 
                    }
                    return resolvedValue;
                });
            };

            return [value, updateValue, loading];
        };

        // --- DATA DEFAULT ---
        const initialStudents = Array.from({ length: 42 }, (_, i) => ({ id: i + 1, name: `Siswa Peserta ${i + 1}`, class: i < 20 ? "XII IPA 1" : "XII IPS 1", examNumber: `24-01-${String(i+1).padStart(3,'0')}`, roomId: i < 20 ? 1 : 2 }));
        const initialTeachers = [{ id: 1, name: "Budi Santoso, S.Pd", nip: "19800101" }, { id: 2, name: "Siti Aminah, M.Pd", nip: "19850202" }, { id: 3, name: "Dedi Corbusi, S.Kom", nip: "-" }, { id: 4, name: "Rina Nose, S.Psi", nip: "-" }, { id: 5, name: "Joko Anwar, S.Sn", nip: "19900303" }, { id: 6, name: "Melly Goeslaw, S.Mus", nip: "-" }];
        const initialSubjects = [{ id: 1, name: "Matematika Wajib", date: "2023-12-04", time: "07:30 - 09:30" }, { id: 2, name: "Bahasa Indonesia", date: "2023-12-04", time: "10:00 - 12:00" }, { id: 3, name: "Fisika", date: "2023-12-05", time: "07:30 - 09:30" }];
        const initialRooms = [{ id: 1, name: "Ruang 01", capacity: 20 }, { id: 2, name: "Ruang 02", capacity: 20 }];
        const initialSchoolInfo = { agency: "PEMERINTAH PROVINSI DAERAH KHUSUS", name: "SMA NEGERI CONTOH JAKARTA", address: "Jl. Pendidikan No. 1, Jakarta Selatan Telp. (021) 1234567", examName: "PENILAIAN AKHIR SEMESTER (PAS)", year: "2023/2024", headmaster: "Dr. Kepala Sekolah, M.Pd", headmasterNip: "19700101 199002 1 001", logo: null, signature: null, stamp: null };

        // --- COMPONENTS UI ---
        const NavButton = ({ active, onClick, icon, label }) => ( <button onClick={onClick} className={`no-print w-full flex items-center p-3 rounded-lg transition-colors duration-200 mb-1 ${active ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-slate-700 text-slate-300 hover:text-white'}`}> <div className="w-8 flex justify-center"><i className={`fas ${icon}`}></i></div> <span className="font-medium text-sm">{label}</span> </button> );
        const StatCard = ({ title, value, icon, color, subtext }) => ( <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all duration-300 group relative overflow-hidden"> <div className={`absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 rounded-full opacity-10 ${color.replace('text-', 'bg-')}`}></div> <div className="flex justify-between items-start relative z-10"> <div> <p className="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">{title}</p> <h3 className="text-3xl font-bold text-slate-800">{value}</h3> {subtext && <p className="text-xs text-slate-400 mt-2 font-medium">{subtext}</p>} </div> <div className={`w-10 h-10 rounded-lg ${color.replace('text-', 'bg-').replace('600', '50')} ${color} flex items-center justify-center text-lg shadow-sm group-hover:scale-110 transition-transform`}> <i className={`fas ${icon}`}></i> </div> </div> </div> );
        const StatusItem = ({ label, status, active, icon }) => ( <div className="flex justify-between items-center py-3 border-b border-dashed border-slate-700 last:border-0"> <div className="flex items-center text-slate-300 text-sm"> {icon && <i className={`fas ${icon} w-5 text-center mr-2 text-slate-500`}></i>} {label} </div> <span className={`text-xs font-bold px-2 py-1 rounded-full ${active ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700 text-slate-400'}`}> {status} </span> </div> );
        const DocCard = ({ title, desc, icon, color, onClick }) => ( <div onClick={onClick} className="bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-lg hover:border-blue-500 border border-transparent transition-all group"> <div className="flex items-start justify-between"> <div> <h4 className="font-bold text-lg group-hover:text-blue-600">{title}</h4> <p className="text-sm text-gray-500 mt-1">{desc}</p> </div> <i className={`fas ${icon} text-2xl ${color}`}></i> </div> <div className="mt-4 text-xs font-bold text-gray-400 uppercase group-hover:text-blue-500">Klik untuk Preview</div> </div> );

        const Dashboard = ({ stats, schedules, subjects, rooms = [], students = [] }) => {
            const [date, setDate] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setDate(new Date()), 60000); return () => clearInterval(timer); }, []);
            const readiness = Math.round(((stats.s > 0 ? 25 : 0) + (stats.t > 0 ? 25 : 0) + (stats.m > 0 ? 25 : 0) + (stats.sch > 0 ? 25 : 0)));
            const totalCapacity = rooms.reduce((acc, curr) => acc + (parseInt(curr.capacity) || 0), 0);
            const capacityPercentage = totalCapacity > 0 ? Math.round((students.length / totalCapacity) * 100) : 0;
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return ( <div className="space-y-8 animate-fade-in-down pb-10"> <div className="flex flex-col md:flex-row justify-between items-end gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-100"> <div><h2 className="text-2xl font-bold text-slate-800">Dashboard Overview</h2><p className="text-slate-500 mt-1">Pantau aktivitas asesmen secara real-time (Online Mode).</p></div> <div className="text-right"><div className="text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full inline-block mb-1">{date.toLocaleDateString('id-ID', dateOptions)}</div><p className="text-xs text-slate-400">Semester Ganjil 2023/2024</p></div> </div> <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"> <StatCard title="Total Peserta" value={stats.s || 0} icon="fa-user-graduate" color="text-blue-600" subtext={`${Math.max(0, stats.s - 5)} data baru minggu ini`} /> <StatCard title="Pengawas" value={stats.t || 0} icon="fa-chalkboard-teacher" color="text-emerald-600" subtext="Siap bertugas" /> <StatCard title="Mapel Ujian" value={stats.m || 0} icon="fa-book" color="text-violet-600" subtext="Terjadwal di sistem" /> <StatCard title="Ruang Ujian" value={stats.r || 0} icon="fa-door-open" color="text-orange-600" subtext={`Kapasitas total: ${totalCapacity}`} /> </div> </div> );
        };

        const DataMaster = ({ students, setStudents, teachers, setTeachers, subjects, setSubjects, rooms, setRooms }) => {
            const [tab, setTab] = useState('siswa');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const [toast, setToast] = useState(null); 
            const fileInputRef = useRef(null);
            useEffect(() => { if (toast) { const timer = setTimeout(() => setToast(null), 3000); return () => clearTimeout(timer); } }, [toast]);
            const showToast = (type, message) => setToast({ type, message });
            const handleDelete = (id, type) => { if(!confirm("Tindakan ini permanen. Hapus data?")) return; try { if(type === 'siswa') setStudents(prev => prev.filter(x => String(x.id) !== String(id))); if(type === 'guru') setTeachers(prev => prev.filter(x => String(x.id) !== String(id))); if(type === 'mapel') setSubjects(prev => prev.filter(x => String(x.id) !== String(id))); if(type === 'ruang') setRooms(prev => prev.filter(x => String(x.id) !== String(id))); showToast('success', 'Data berhasil dihapus dari Database.'); } catch(e) { console.error(e); showToast('error', 'Gagal menghapus data.'); } };
            const handleSave = (e) => { e.preventDefault(); if (!formData.name) return showToast('error', 'Nama wajib diisi!'); try { const id = formData.id || Date.now(); const newData = { ...formData, id }; if (newData.roomId) newData.roomId = Number(newData.roomId); if (tab === 'siswa') { if(formData.id) setStudents(prev => prev.map(s => String(s.id) === String(id) ? newData : s)); else setStudents(prev => [...prev, newData]); } else if (tab === 'guru') { if(formData.id) setTeachers(prev => prev.map(s => String(s.id) === String(id) ? newData : s)); else setTeachers(prev => [...prev, newData]); } else if (tab === 'mapel') { if(formData.id) setSubjects(prev => prev.map(s => String(s.id) === String(id) ? newData : s)); else setSubjects(prev => [...prev, newData]); } else if (tab === 'ruang') { if(formData.id) setRooms(prev => prev.map(s => String(s.id) === String(id) ? newData : s)); else setRooms(prev => [...prev, newData]); } setIsModalOpen(false); setFormData({}); showToast('success', formData.id ? 'Perubahan tersimpan ke Cloud.' : 'Data ditambahkan ke Cloud.'); } catch(e) { showToast('error', 'Terjadi kesalahan sistem.'); } };
            const openAdd = () => { setFormData({}); setIsModalOpen(true); }; const openEdit = (item) => { setFormData(item); setIsModalOpen(true); }; const downloadTemplate = () => { const templateData = [{ "Nama": "Contoh Siswa 1", "Kelas": "X IPA 1", "No Ujian": "24-10-001", "ID Ruang (Angka)": 1 }, { "Nama": "Contoh Siswa 2", "Kelas": "XI IPS 2", "No Ujian": "24-11-050", "ID Ruang (Angka)": 2 }]; const ws = XLSX.utils.json_to_sheet(templateData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template Siswa"); XLSX.writeFile(wb, "Template_Import_Siswa.xlsx"); }; const handleFileChange = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const wb = XLSX.read(ev.target.result, {type:'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(json.length){ const newS = json.map((r,i)=>({id:Date.now()+i, name:r['Nama'], class:r['Kelas'], examNumber:r['No Ujian'], roomId:r['ID Ruang (Angka)']})); setStudents(prev => [...prev, ...newS]); showToast('success', `${newS.length} data siswa berhasil diimpor.`); } } catch (error) { showToast('error', 'Format file Excel tidak valid.'); } }; reader.readAsArrayBuffer(file); e.target.value = ''; };
            const tabs = [{ id: 'siswa', label: 'Peserta Didik', icon: 'fa-user-graduate', count: students.length, color: 'blue', desc: 'Kelola data siswa & nomor ujian' }, { id: 'guru', label: 'Pengawas', icon: 'fa-chalkboard-teacher', count: teachers.length, color: 'emerald', desc: 'Kelola data pengawas & NIP' }, { id: 'mapel', label: 'Mata Pelajaran', icon: 'fa-book-open', count: subjects.length, color: 'violet', desc: 'Atur jadwal & durasi ujian' }, { id: 'ruang', label: 'Ruang Ujian', icon: 'fa-door-open', count: rooms.length, color: 'orange', desc: 'Atur kapasitas & lokasi' }]; const getCurrentData = () => { let data = []; if (tab === 'siswa') data = students; else if (tab === 'guru') data = teachers; else if (tab === 'mapel') data = subjects; else if (tab === 'ruang') data = rooms; if (!searchTerm) return data; const lower = searchTerm.toLowerCase(); return data.filter(item => (item.name && item.name.toLowerCase().includes(lower)) || (item.nip && item.nip.toLowerCase().includes(lower)) || (item.class && item.class.toLowerCase().includes(lower)) || (item.examNumber && item.examNumber.toLowerCase().includes(lower))); }; const filteredData = getCurrentData();
            return ( <div className="space-y-8 animate-fade-in-down relative min-h-[500px]"> {toast && (<div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 text-white transform transition-all duration-300 animate-fade-in-down border-l-4 border-white/20 backdrop-blur-sm ${toast.type === 'success' ? 'bg-emerald-600/95' : 'bg-rose-600/95'}`}><div className="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center"><i className={`fas ${toast.type === 'success' ? 'fa-check' : 'fa-exclamation'} text-sm`}></i></div><div><h4 className="font-bold text-sm tracking-wide">{toast.type === 'success' ? 'BERHASIL' : 'GAGAL'}</h4><p className="text-xs opacity-90">{toast.message}</p></div><button onClick={() => setToast(null)} className="ml-2 opacity-70 hover:opacity-100 hover:rotate-90 transition-transform"><i className="fas fa-times"></i></button></div>)} <div className="flex flex-col gap-6"><div><h2 className="text-2xl font-bold text-slate-800 tracking-tight flex items-center gap-2"><span className="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center text-sm"><i className="fas fa-database"></i></span> Data Master</h2><p className="text-slate-500 text-sm mt-1 ml-10">Pusat kontrol data referensi sistem asesmen.</p></div><div className="grid grid-cols-2 lg:grid-cols-4 gap-4">{tabs.map(t => (<button key={t.id} onClick={() => { setTab(t.id); setSearchTerm(''); }} className={`relative p-5 rounded-xl border-2 transition-all duration-200 text-left group overflow-hidden ${tab === t.id ? `bg-white border-${t.color}-500 shadow-lg ring-1 ring-${t.color}-500 transform scale-[1.02]` : 'bg-white border-slate-100 hover:border-slate-300 hover:shadow-md'}`}><div className={`absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 text-${t.color}-600`}><i className={`fas ${t.icon} text-6xl`}></i></div><div className="relative z-10"><div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl mb-3 shadow-sm ${tab === t.id ? `bg-${t.color}-100 text-${t.color}-600` : 'bg-slate-100 text-slate-400 group-hover:bg-slate-200 group-hover:text-slate-600'}`}><i className={`fas ${t.icon}`}></i></div><div className="flex justify-between items-end"><div><div className={`font-bold text-base ${tab === t.id ? 'text-slate-800' : 'text-slate-600'}`}>{t.label}</div><div className="text-[10px] uppercase font-bold text-slate-400 mt-1 tracking-wider">{t.desc}</div></div><span className={`text-xs font-bold px-2 py-1 rounded-md ${tab === t.id ? `bg-${t.color}-100 text-${t.color}-700` : 'bg-slate-100 text-slate-500'}`}>{t.count}</span></div></div></button>))}</div></div> <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-20"><div className="relative w-full md:w-auto group"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-blue-500 transition-colors"><i className="fas fa-search"></i></div><input type="text" placeholder={`Cari ${tabs.find(t=>t.id===tab).label}...`} className="pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm w-full md:w-80 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all shadow-sm" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div><div className="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">{tab === 'siswa' && (<><button onClick={downloadTemplate} className="whitespace-nowrap bg-white hover:bg-slate-50 text-slate-600 border border-slate-300 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all flex items-center shadow-sm hover:shadow active:scale-95 group"><i className="fas fa-file-excel mr-2 text-green-600 group-hover:scale-110 transition-transform"></i> Template</button><input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".xlsx, .xls" /><button onClick={() => fileInputRef.current.click()} className="whitespace-nowrap bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all flex items-center active:scale-95 group"><i className="fas fa-upload mr-2 group-hover:-translate-y-0.5 transition-transform"></i> Import</button></>)}<div className="w-px h-8 bg-slate-200 mx-1 hidden md:block"></div><button onClick={openAdd} className="whitespace-nowrap bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center text-sm font-bold active:scale-95 group w-full md:w-auto justify-center"><i className="fas fa-plus mr-2 group-hover:rotate-90 transition-transform"></i> Tambah Baru</button></div></div> <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col"><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-600 uppercase text-xs font-bold border-b border-slate-200"><tr><th className="px-6 py-4 whitespace-nowrap w-16 text-center">#</th>{tab === 'siswa' && <><th className="px-6 py-4">Nama Lengkap</th><th className="px-6 py-4">Kelas</th><th className="px-6 py-4">No. Ujian</th><th className="px-6 py-4">Ruang</th></>}{tab === 'guru' && <><th className="px-6 py-4">Nama Guru</th><th className="px-6 py-4">NIP / Identitas</th></>}{tab === 'mapel' && <><th className="px-6 py-4">Mata Pelajaran</th><th className="px-6 py-4">Waktu</th><th className="px-6 py-4">Durasi</th></>}{tab === 'ruang' && <><th className="px-6 py-4">Nama Ruang</th><th className="px-6 py-4">Kapasitas</th></>}<th className="px-6 py-4 text-center w-32">Opsi</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredData.length > 0 ? (filteredData.map((item, idx) => (<tr key={item.id} className="hover:bg-blue-50/50 transition duration-150 group"><td className="px-6 py-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>{tab === 'siswa' && (<><td className="px-6 py-4 font-semibold text-slate-700"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 text-xs"><i className="fas fa-user"></i></div>{item.name}</div></td><td className="px-6 py-4"><span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800 border border-slate-200">{item.class}</span></td><td className="px-6 py-4 font-mono text-slate-500 bg-slate-50/50 rounded">{item.examNumber}</td><td className="px-6 py-4"><span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100"><i className="fas fa-door-open mr-1.5 opacity-50"></i> R-{item.roomId}</span></td></>)}{tab === 'guru' && (<><td className="px-6 py-4 font-semibold text-slate-700 flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-xs border border-emerald-100"><i className="fas fa-user-tie"></i></div>{item.name}</td><td className="px-6 py-4 font-mono text-slate-500">{item.nip}</td></>)}{tab === 'mapel' && (<><td className="px-6 py-4 font-semibold text-slate-700 flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-violet-50 text-violet-600 flex items-center justify-center text-xs border border-violet-100"><i className="fas fa-book"></i></div>{item.name}</td><td className="px-6 py-4 text-slate-600"><div className="text-xs text-slate-400 uppercase font-bold mb-0.5">{item.date}</div><div className="font-medium">{item.time}</div></td><td className="px-6 py-4 text-slate-500 text-xs"><i className="far fa-clock mr-1"></i> 120 Menit</td></>)}{tab === 'ruang' && <><td className="px-6 py-4 font-semibold text-slate-700">{item.name}</td><td className="px-6 py-4"><span className="text-slate-600 font-bold">{item.capacity}</span> <span className="text-xs text-slate-400">Kursi</span></td></>}<td className="px-6 py-4 text-center"><div className="flex items-center justify-center gap-2"><button type="button" onClick={() => openEdit(item)} className="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 flex items-center justify-center transition-all shadow-sm" title="Edit"><i className="fas fa-pen-to-square text-xs"></i></button><button type="button" onClick={() => handleDelete(item.id, tab)} className="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-500 hover:text-rose-600 hover:border-rose-300 hover:bg-rose-50 flex items-center justify-center transition-all shadow-sm" title="Hapus"><i className="fas fa-trash-can text-xs"></i></button></div></td></tr>))) : (<tr><td colSpan="6" className="text-center py-24"><div className="flex flex-col items-center justify-center text-slate-300 opacity-80"><div className="bg-slate-50 p-6 rounded-full mb-4"><i className="fas fa-search text-4xl text-slate-300"></i></div><p className="text-lg font-medium text-slate-500">Data tidak ditemukan</p><p className="text-sm">Coba kata kunci lain atau tambahkan data baru.</p></div></td></tr>)}</tbody></table></div><div className="bg-slate-50 px-6 py-3 border-t border-slate-200 text-xs text-slate-500 flex flex-col sm:flex-row justify-between items-center gap-2"><span className="font-medium">Menampilkan <span className="text-slate-800">{filteredData.length}</span> dari {getCurrentData().length} data</span><div className="flex gap-1"><button className="px-2 py-1 rounded border border-slate-200 bg-white disabled:opacity-50" disabled><i className="fas fa-chevron-left"></i></button><button className="px-2 py-1 rounded border border-slate-200 bg-white disabled:opacity-50" disabled><i className="fas fa-chevron-right"></i></button></div></div></div> {isModalOpen && (<div className="modal-backdrop" onClick={() => setIsModalOpen(false)}><div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl m-4 transform transition-all overflow-hidden border border-slate-100" onClick={e => e.stopPropagation()}><div className="bg-slate-50/80 backdrop-blur px-6 py-4 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white ${tab==='siswa'?'bg-blue-500':tab==='guru'?'bg-emerald-500':tab==='mapel'?'bg-violet-500':'bg-orange-500'}`}><i className={`fas ${tab==='siswa'?'fa-user-graduate':tab==='guru'?'fa-chalkboard-teacher':tab==='mapel'?'fa-book':'fa-door-open'} text-sm`}></i></div><h3 className="text-lg font-bold text-slate-800">{formData.id ? 'Edit Data' : 'Tambah Data'}</h3></div><button onClick={() => setIsModalOpen(false)} className="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-600 transition"><i className="fas fa-times"></i></button></div><form onSubmit={handleSave} className="p-6 space-y-5">{tab === 'siswa' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Nama Lengkap</label><div className="relative"><i className="fas fa-user absolute left-3 top-3 text-slate-300"></i><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 pl-10 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="Nama Siswa" /></div></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Kelas</label><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.class || ''} onChange={e => setFormData({...formData, class: e.target.value})} placeholder="X IPA 1" /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">No Ujian</label><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition font-mono" value={formData.examNumber || ''} onChange={e => setFormData({...formData, examNumber: e.target.value})} placeholder="00-00-000" /></div><div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Ruang Ujian</label><div className="relative"><i className="fas fa-door-open absolute left-3 top-3 text-slate-300"></i><select className="w-full border border-slate-200 rounded-lg p-2.5 pl-10 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition bg-white" value={formData.roomId || ''} onChange={e => setFormData({...formData, roomId: e.target.value})}><option value="">-- Pilih Ruang --</option>{rooms.map(r => <option key={r.id} value={r.id}>{r.name} (Kapasitas: {r.capacity})</option>)}</select></div></div></div>)}{tab === 'guru' && (<div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Nama Guru</label><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">NIP</label><input type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.nip || ''} onChange={e => setFormData({...formData, nip: e.target.value})} /></div></div>)}{tab === 'mapel' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Mapel</label><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Tanggal</label><input required type="date" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.date || ''} onChange={e => setFormData({...formData, date: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Waktu</label><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.time || ''} onChange={e => setFormData({...formData, time: e.target.value})} /></div></div>)}{tab === 'ruang' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Nama Ruang</label><input required type="text" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Kapasitas</label><input required type="number" className="w-full border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" value={formData.capacity || ''} onChange={e => setFormData({...formData, capacity: e.target.value})} /></div></div>)}<div className="flex justify-end gap-3 pt-6 border-t border-slate-100 mt-2"><button type="button" onClick={() => setIsModalOpen(false)} className="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg font-bold text-sm transition">Batal</button><button type="submit" className="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:shadow-lg hover:from-blue-700 hover:to-blue-800 transition-all font-bold text-sm shadow-md flex items-center"><i className="fas fa-save mr-2"></i> Simpan Data</button></div></form></div></div>)} </div> );
        };

        const ScheduleManager = ({ subjects, rooms, teachers, schedules, setSchedules }) => {
            const generateSchedule = () => {
                const lockedSchedules = schedules.filter(s => s.isLocked);
                const teacherWorkload = {}; teachers.forEach(t => teacherWorkload[t.id] = 0);
                lockedSchedules.forEach(s => { if (teacherWorkload[s.invigilatorId] !== undefined) teacherWorkload[s.invigilatorId]++; });
                const newSchedules = [...lockedSchedules];
                subjects.forEach(sub => {
                    const roomsToFill = rooms.filter(room => !lockedSchedules.some(s => s.subjectId === sub.id && s.roomId === room.id));
                    const busyTeacherIds = lockedSchedules.filter(s => s.subjectId === sub.id).map(s => s.invigilatorId);
                    let availableTeachers = teachers.filter(t => !busyTeacherIds.includes(t.id));
                    roomsToFill.forEach(room => {
                        if (availableTeachers.length === 0) {
                            const t = teachers[Math.floor(Math.random() * teachers.length)];
                             newSchedules.push({ id: `${sub.id}-${room.id}`, subjectId: sub.id, roomId: room.id, invigilatorId: t.id, isLocked: false });
                        } else {
                            availableTeachers.sort((a, b) => { const loadA = teacherWorkload[a.id]; const loadB = teacherWorkload[b.id]; if (loadA === loadB) return 0.5 - Math.random(); return loadA - loadB; });
                            const selectedTeacher = availableTeachers[0];
                            newSchedules.push({ id: `${sub.id}-${room.id}`, subjectId: sub.id, roomId: room.id, invigilatorId: selectedTeacher.id, isLocked: false });
                            teacherWorkload[selectedTeacher.id]++; availableTeachers = availableTeachers.filter(t => t.id !== selectedTeacher.id);
                        }
                    });
                });
                setSchedules(newSchedules);
            };
            const clearSchedule = () => { if(confirm('Hapus semua jadwal? Semua penguncian manual juga akan hilang.')) setSchedules([]); }
            const handleManualChange = (schId, newTeacherId) => { setSchedules(prev => prev.map(s => s.id === schId ? { ...s, invigilatorId: Number(newTeacherId), isLocked: true } : s)); };
            const toggleLock = (schId) => { setSchedules(prev => prev.map(s => s.id === schId ? { ...s, isLocked: !s.isLocked } : s)); };
            const getReserves = (subId) => { const assignedIds = schedules.filter(s => s.subjectId === subId).map(s => s.invigilatorId); return teachers.filter(t => !assignedIds.includes(t.id)); };

            return (
                <div className="space-y-8 animate-fade-in-down">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                        <div><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-3"><div className="bg-indigo-600 text-white w-10 h-10 rounded-lg flex items-center justify-center text-lg shadow-md"><i className="fas fa-calendar-alt"></i></div> Manajemen Jadwal</h2><p className="text-slate-500 text-sm mt-1">Distribusi otomatis proporsional & penentuan cadangan.</p></div>
                        <div className="flex gap-2"><button onClick={clearSchedule} className="bg-white text-rose-600 border border-rose-200 hover:bg-rose-50 px-5 py-2.5 rounded-lg font-bold text-sm transition shadow-sm active:scale-95 flex items-center"><i className="fas fa-trash-alt mr-2"></i> Reset</button><button onClick={generateSchedule} className="bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-lg px-6 py-2.5 rounded-lg font-bold text-sm shadow-md transition active:scale-95 flex items-center"><i className="fas fa-magic mr-2"></i> Auto Generate</button></div>
                    </div>
                    {subjects.length === 0 ? (<div className="p-12 text-center bg-white rounded-xl border border-dashed border-slate-300"><div className="text-slate-300 text-4xl mb-3"><i className="fas fa-clipboard-list"></i></div><p className="text-slate-500">Belum ada data mata pelajaran.</p></div>) : (<div className="space-y-8">{subjects.map(sub => { const subSchedules = schedules.filter(s => s.subjectId === sub.id); const reserves = getReserves(sub.id); return (<div key={sub.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2"><div><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><i className="fas fa-book text-indigo-500"></i> {sub.name}</h3><div className="text-sm text-slate-500 flex items-center gap-3 mt-1"><span><i className="far fa-calendar mr-1"></i> {sub.date}</span><span><i className="far fa-clock mr-1"></i> {sub.time}</span></div></div><div className="text-xs font-bold px-3 py-1 bg-white border border-slate-200 rounded-full text-slate-500 shadow-sm">{subSchedules.length} Ruang Terisi</div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-white text-slate-500 border-b border-slate-100 uppercase text-xs font-bold tracking-wider"><tr><th className="px-6 py-3 w-1/4">Ruang Ujian</th><th className="px-6 py-3">Pengawas Ruang</th><th className="px-6 py-3 w-24 text-center">Status</th></tr></thead><tbody className="divide-y divide-slate-50">{rooms.map(room => { const sch = subSchedules.find(s => s.roomId === room.id); if (!sch) return (<tr key={room.id} className="bg-slate-50/50"><td className="px-6 py-4 font-medium text-slate-600">{room.name}</td><td className="px-6 py-4 text-slate-400 italic">Belum ada jadwal</td><td className="px-6 py-4"></td></tr>); const currentTeacher = teachers.find(t => t.id === sch.invigilatorId); return (<tr key={sch.id} className={`hover:bg-indigo-50/30 transition ${sch.isLocked ? 'bg-amber-50/40' : ''}`}><td className="px-6 py-4"><div className="font-bold text-slate-700">{room.name}</div><div className="text-xs text-slate-400">Kapasitas: {room.capacity}</div></td><td className="px-6 py-4"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border ${sch.isLocked ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-white text-slate-500 border-slate-200'}`}>{currentTeacher?.name?.charAt(0) || '?'}</div><div className="flex-1"><select className={`w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:ring-0 text-sm py-1 outline-none cursor-pointer transition ${sch.isLocked ? 'font-bold text-amber-900' : 'text-slate-700'}`} value={sch.invigilatorId} onChange={(e) => handleManualChange(sch.id, e.target.value)}>{teachers.map(t => (<option key={t.id} value={t.id}>{t.name}</option>))}</select>{sch.isLocked && <div className="text-[10px] text-amber-600 mt-0.5"><i className="fas fa-lock mr-1"></i>Terkunci Manual</div>}</div></div></td><td className="px-6 py-4 text-center"><button onClick={() => toggleLock(sch.id)} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${sch.isLocked ? 'bg-amber-100 text-amber-600 hover:bg-amber-200' : 'text-slate-300 hover:text-slate-500 hover:bg-slate-100'}`} title={sch.isLocked ? "Buka Kunci" : "Kunci Pengawas"}><i className={`fas ${sch.isLocked ? 'fa-lock' : 'fa-lock-open'}`}></i></button></td></tr>); })}</tbody></table></div><div className="bg-slate-50 px-6 py-3 border-t border-slate-200"><div className="flex items-start gap-3"><div className="text-xs font-bold text-slate-500 uppercase tracking-wide mt-1 whitespace-nowrap"><i className="fas fa-user-shield mr-1"></i> Cadangan:</div><div className="flex flex-wrap gap-2">{reserves.length > 0 ? reserves.map(t => (<span key={t.id} className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-white border border-slate-200 text-slate-600 shadow-sm" title={`NIP: ${t.nip}`}>{t.name}</span>)) : (<span className="text-xs text-slate-400 italic">Tidak ada pengawas cadangan (Semua bertugas)</span>)}</div></div></div></div>); })}</div>)}
                </div>
            );
        };

        const PrintCenter = ({ schoolInfo, students, rooms, subjects, schedules, teachers }) => {
            const [view, setView] = useState('menu'); 
            const [selectedRoom, setSelectedRoom] = useState(rooms[0]?.id || 0);
            const [selectedSubject, setSelectedSubject] = useState(subjects[0]?.id || 0);
            const handlePrint = () => window.print();
            const BackBtn = () => (<div className="no-print mb-4 flex justify-between"><button onClick={() => setView('menu')} className="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded font-bold text-gray-700"><i className="fas fa-arrow-left mr-2"></i> Kembali</button><div className="space-x-2 flex items-center">{view === 'attendance' && (<select className="border p-2 rounded" value={selectedSubject} onChange={e=>setSelectedSubject(Number(e.target.value))}>{subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>)}{(view === 'cards' || view === 'attendance' || view === 'label') && (<select className="border p-2 rounded" value={selectedRoom} onChange={e=>setSelectedRoom(Number(e.target.value))}> <option value="all">Semua Ruang</option>{rooms.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}</select>)}<button onClick={handlePrint} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold shadow"><i className="fas fa-print mr-2"></i> Cetak</button></div></div>);
            const DocHeader = ({ school, title, subtitle }) => (<div className="text-center border-b-4 double border-black pb-4 mb-6"><div className="flex items-center justify-center gap-4 mb-2"><div className="w-20 h-20 bg-gray-100 flex items-center justify-center overflow-hidden">{school?.logo ? <img src={school.logo} alt="Logo" className="w-full h-full object-contain" /> : <i className="fas fa-university text-4xl text-gray-300"></i>}</div><div className="flex-1 text-center"><h1 className="text-lg font-bold m-0 uppercase leading-tight">{school?.agency || 'NAMA DINAS'}</h1><h2 className="text-2xl font-bold m-0 uppercase text-blue-900 leading-tight">{school?.name || 'NAMA SEKOLAH'}</h2><p className="text-sm m-0 italic text-gray-600">{school?.address || 'Alamat Sekolah'}</p></div></div><div className="border-t-2 border-black mt-2 pt-2"><div className="font-bold text-lg uppercase underline decoration-2 underline-offset-4">{title}</div>{subtitle && <div className="font-bold text-md uppercase">{subtitle}</div>}<div className="text-sm uppercase tracking-wide mt-1">{school?.examName || 'UJIAN'}</div></div></div>);
            
            const CardLayout = () => { 
                const filteredStudents = selectedRoom === 'all' ? students : students.filter(s => String(s.roomId) === String(selectedRoom)); 
                const chunks = []; 
                for (let i = 0; i < filteredStudents.length; i += 8) { chunks.push(filteredStudents.slice(i, i + 8)); } 
                return ( <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible"> <BackBtn /> {chunks.map((chunk, pageIdx) => ( <div key={pageIdx} className="a4-sheet mx-auto bg-white mb-4 page-break"> <div className="card-grid"> {chunk.map(s => { const roomName = rooms.find(r => String(r.id) === String(s.roomId))?.name || '-'; const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(s.examNumber)}`; return ( <div key={s.id} className="exam-card"> <div className="ec-header"> {schoolInfo.logo ? <img src={schoolInfo.logo} className="ec-logo" /> : <i className="fas fa-university text-3xl text-gray-400"></i>} <div className="ec-title-box"> <div className="ec-agency">{schoolInfo.agency}</div> <div className="ec-school">{schoolInfo.name}</div> <div className="ec-exam">{schoolInfo.examName}</div> </div> </div> <div className="ec-body"> <div className="ec-photo-box flex flex-col items-center justify-center bg-white p-1 border-slate-300"> <img src={qrUrl} alt="QR Jadwal" className="w-full h-auto object-contain" /> <div className="text-[6pt] text-center mt-1 font-bold text-slate-600">SCAN JADWAL</div> </div> <div className="ec-details"> <div> <div className="ec-row"><div className="ec-label">No. Ujian</div><div className="ec-sep">:</div><div className="ec-val mono">{s.examNumber}</div></div> <div className="ec-row"><div className="ec-label">Nama</div><div className="ec-sep">:</div><div className="ec-val uppercase">{s.name}</div></div> <div className="ec-row"><div className="ec-label">Kelas</div><div className="ec-sep">:</div><div className="ec-val">{s.class}</div></div> <div className="ec-row"><div className="ec-label">Ruang</div><div className="ec-sep">:</div><div className="ec-val">{roomName}</div></div> </div> <div className="ec-footer"> <div className="ec-signature" style={{ width: '140px', textAlign: 'center' }}> <div style={{ marginBottom: '2px' }}>Jakarta, {new Date().toLocaleDateString('id-ID')}</div> <div style={{ fontWeight: 'bold' }}>Kepala Sekolah</div> <div className="ec-sign-space"> {schoolInfo.signature && <img src={schoolInfo.signature} className="ec-sign-img" alt="TTD" />} {schoolInfo.stamp && <img src={schoolInfo.stamp} className="ec-stamp-img" alt="Cap" />} </div> <div className="ec-kepsek">{schoolInfo.headmaster}</div> <div style={{ fontSize: '6pt' }}>NIP. {schoolInfo.headmasterNip}</div> </div> </div> </div> </div> </div> ); })} </div> </div> ))} </div> ); 
            };

            const AttendanceLayout = () => { 
                const targetRooms = selectedRoom === 'all' ? rooms : rooms.filter(r => String(r.id) === String(selectedRoom)); 
                const activeSubject = subjects.find(s => String(s.id) === String(selectedSubject)) || subjects[0]; 
                return ( 
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible"> 
                        <BackBtn /> 
                        {targetRooms.map(room => { 
                            const roomStudents = students.filter(s => String(s.roomId) === String(room.id)); 
                            const schedule = schedules.find(s => String(s.subjectId) === String(activeSubject.id) && String(s.roomId) === String(room.id)); 
                            const t1 = teachers.find(t => String(t.id) === String(schedule?.invigilatorId)); 
                            return ( 
                                <div key={room.id} className="a4-sheet mx-auto bg-white mb-4 page-break"> 
                                    <DocHeader school={schoolInfo} title="DAFTAR HADIR PESERTA" subtitle={`RUANG: ${room.name}`} /> 
                                    <div className="flex justify-between text-sm mb-4 border-b border-black pb-2"> 
                                        <div>
                                            <table><tbody><tr><td className="font-bold pr-4">Mata Pelajaran</td><td>: {activeSubject.name}</td></tr><tr><td className="font-bold pr-4">Hari / Tanggal</td><td>: {activeSubject.date}</td></tr></tbody></table>
                                        </div> 
                                        <div>
                                            <table><tbody><tr><td className="font-bold pr-4">Waktu</td><td>: {activeSubject.time}</td></tr><tr><td className="font-bold pr-4">Jml Peserta</td><td>: {roomStudents.length} Org</td></tr></tbody></table>
                                        </div> 
                                    </div> 
                                    <table className="doc-table"> 
                                        <thead><tr><th className="w-10">No</th><th className="w-32">No. Ujian</th><th>Nama Peserta</th><th className="w-32">Tanda Tangan</th><th className="w-16">Ket</th></tr></thead> 
                                        <tbody> 
                                            {roomStudents.map((s, idx) => (<tr key={s.id}><td className="text-center">{idx + 1}</td><td className="text-center font-mono">{s.examNumber}</td><td className="uppercase">{s.name}</td><td className="text-left text-xs text-gray-400 align-bottom h-8">{idx % 2 === 0 ? `${idx + 1}..........` : `..........${idx + 1}`}</td><td></td></tr>))} 
                                            {Array.from({length: Math.max(0, 20 - roomStudents.length)}).map((_, i) => (<tr key={`empty-${i}`}><td className="h-8"></td><td></td><td></td><td></td><td></td></tr>))} 
                                        </tbody> 
                                    </table> 
                                    <div className="mt-8 flex justify-end text-sm">
                                        <div className="signature-box text-center w-64">
                                            <div className="mb-8"><div>Pengawas Ruang,</div></div>
                                            <div className="font-bold underline mt-16">{t1?.name || '....................................'}</div>
                                            <div>NIP. {t1?.nip || '-'}</div>
                                        </div>
                                    </div> 
                                </div> 
                            ); 
                        })} 
                    </div> 
                ); 
            };

            const DeskLabelLayout = () => { 
                const filteredStudents = selectedRoom === 'all' ? students : students.filter(s => String(s.roomId) === String(selectedRoom)); 
                const chunks = []; 
                for (let i = 0; i < filteredStudents.length; i += 4) { chunks.push(filteredStudents.slice(i, i + 4)); } 
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pIdx) => (
                            <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                <div className="desk-label-grid">
                                    {chunk.map(s => (
                                        <div key={s.id} className="desk-label-card">
                                            <div className="text-xl font-bold uppercase mb-2">{schoolInfo.examName}</div>
                                            <div className="text-6xl font-black font-mono my-2 tracking-widest">{s.examNumber.split('-').pop()}</div>
                                            <div className="w-full border-t-2 border-black my-4"></div>
                                            <div className="text-xl font-bold uppercase">{s.name}</div>
                                            <div className="text-lg text-gray-600 mt-1">{s.class}</div>
                                            <div className="mt-auto text-sm bg-black text-white px-6 py-1 rounded-full font-mono">{s.examNumber}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                ); 
            };
            
            const SupervisorListLayout = () => { 
                const chunks = []; for (let i = 0; i < teachers.length; i += 20) { chunks.push(teachers.slice(i, i + 20)); } 
                return ( 
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible"> 
                        <BackBtn /> 
                        {chunks.map((chunk, pIdx) => ( 
                            <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break"> 
                                <DocHeader school={schoolInfo} title="DAFTAR HADIR PENGAWAS" /> 
                                <div className="mb-6 text-sm"> 
                                    <table className="w-full"><tbody><tr><td className="font-bold w-32">Hari / Tanggal</td><td>: ........................................................................</td></tr><tr><td className="font-bold w-32">Mata Pelajaran</td><td>: ........................................................................</td></tr></tbody></table> 
                                </div> 
                                <table className="doc-table"> 
                                    <thead><tr><th className="w-12 py-3">No</th><th className="py-3">Nama Pengawas</th><th className="w-48 py-3">NIP</th><th className="w-48 py-3">Tanda Tangan</th></tr></thead> 
                                    <tbody> 
                                        {chunk.map((t, idx) => (<tr key={t.id}><td className="text-center py-3">{idx + 1 + (pIdx * 20)}</td><td className="font-bold px-3 py-3 uppercase">{t.name}</td><td className="text-center py-3">{t.nip}</td><td className="text-left px-2 text-xs text-gray-400 align-bottom h-12">{(idx + 1 + (pIdx * 20)) % 2 === 1 ? `${idx + 1 + (pIdx * 20)}..........` : `..........${idx + 1 + (pIdx * 20)}`}</td></tr>))} 
                                        {Array.from({length: Math.max(0, 15 - chunk.length)}).map((_, i) => (<tr key={`empty-${i}`}><td className="h-12"></td><td></td><td></td><td></td></tr>))} 
                                    </tbody> 
                                </table> 
                                <div className="mt-12 flex justify-end text-sm"> 
                                    <div className="signature-box text-center w-64"> 
                                        <div className="mb-2"><div>Kepala Sekolah,</div></div> 
                                        <div className="ec-sign-space" style={{height: '60px'}}> {schoolInfo.signature && <img src={schoolInfo.signature} className="sign-img" alt="TTD" />} {schoolInfo.stamp && <img src={schoolInfo.stamp} className="stamp-img" alt="Cap" />} </div> 
                                        <div className="font-bold underline mt-2">{schoolInfo.headmaster}</div> 
                                        <div>NIP. {schoolInfo.headmasterNip}</div> 
                                    </div> 
                                </div> 
                            </div> 
                        ))} 
                    </div> 
                ); 
            };
            
            // FIX: Tambahkan String() pada ID lookup untuk memastikan kecocokan
            const SupervisorScheduleLayout = () => { 
                const fullSchedules = schedules.map(sch => { 
                    const sub = subjects.find(s => String(s.id) === String(sch.subjectId)); 
                    const room = rooms.find(r => String(r.id) === String(sch.roomId)); 
                    const teacher = teachers.find(t => String(t.id) === String(sch.invigilatorId)); 
                    return { ...sch, sub, room, teacher }; 
                }).sort((a, b) => { 
                    if (a.sub?.date !== b.sub?.date) return (a.sub?.date || '').localeCompare(b.sub?.date || ''); 
                    return (a.sub?.time || '').localeCompare(b.sub?.time || ''); 
                }); 
                const ITEMS_PER_PAGE = 18; 
                const chunks = []; for (let i = 0; i < fullSchedules.length; i += ITEMS_PER_PAGE) { chunks.push(fullSchedules.slice(i, i + ITEMS_PER_PAGE)); } 
                if (fullSchedules.length === 0) return <div className="bg-gray-200 p-4 min-h-screen flex items-center justify-center"><div className="bg-white p-8 rounded-lg shadow text-center"><i className="fas fa-exclamation-circle text-4xl text-yellow-500 mb-2"></i><p className="text-gray-600 font-bold">Belum ada jadwal yang di-generate.</p><button onClick={() => setView('menu')} className="mt-4 text-blue-600 underline">Kembali</button></div></div>; 
                return (
                    <div className="bg-gray-200 p-4 min-h-screen overflow-auto print-wrapper print:p-0 print:bg-white print:overflow-visible">
                        <BackBtn />
                        {chunks.map((chunk, pIdx) => (
                            <div key={pIdx} className="a4-sheet mx-auto bg-white mb-4 page-break">
                                <DocHeader school={schoolInfo} title="JADWAL TUGAS PENGAWASAN" />
                                <table className="doc-table">
                                    <thead><tr><th className="w-10">No</th><th className="w-32">Hari / Tanggal</th><th className="w-32">Waktu</th><th>Mata Pelajaran</th><th className="w-32">Ruang</th><th className="w-64">Nama Pengawas</th></tr></thead>
                                    <tbody>
                                        {chunk.map((item, idx) => (<tr key={item.id}><td className="text-center">{idx + 1 + (pIdx * ITEMS_PER_PAGE)}</td><td className="text-center">{item.sub?.date}</td><td className="text-center">{item.sub?.time}</td><td className="px-2 font-semibold">{item.sub?.name}</td><td className="text-center">{item.room?.name}</td><td className="px-2 uppercase">{item.teacher?.name || '-'}</td></tr>))}
                                        {Array.from({length: Math.max(0, ITEMS_PER_PAGE - chunk.length)}).map((_, i) => (<tr key={`empty-${i}`}><td className="h-8"></td><td></td><td></td><td></td><td></td><td></td></tr>))}
                                    </tbody>
                                </table>
                                {pIdx === chunks.length - 1 && (<div className="mt-8 flex justify-end text-sm"><div className="signature-box text-center w-64"><div className="mb-2"><div>Kepala Sekolah,</div></div><div className="ec-sign-space" style={{height: '60px'}}>{schoolInfo.signature && <img src={schoolInfo.signature} className="sign-img" alt="TTD" />}{schoolInfo.stamp && <img src={schoolInfo.stamp} className="stamp-img" alt="Cap" />}</div><div className="font-bold underline mt-2">{schoolInfo.headmaster}</div><div>NIP. {schoolInfo.headmasterNip}</div></div></div>)}
                            </div>
                        ))}
                    </div>
                ); 
            };

            if (view === 'cards') return <CardLayout />;
            if (view === 'attendance') return <AttendanceLayout />;
            if (view === 'label') return <DeskLabelLayout />;
            if (view === 'supervisor') return <SupervisorListLayout />;
            if (view === 'supervisor_schedule') return <SupervisorScheduleLayout />;

            return (
                <div className="animate-fade-in-down">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">Pusat Cetak</h2>
                    <p className="text-gray-500 mb-8">Pilih jenis dokumen yang ingin dicetak.</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <DocCard title="Kartu Peserta" desc="Cetak kartu identitas ujian untuk semua siswa." icon="fa-id-card" color="text-blue-500" onClick={() => setView('cards')} />
                        <DocCard title="Daftar Hadir Siswa" desc="Lembar absensi tanda tangan peserta per ruang." icon="fa-clipboard-list" color="text-green-500" onClick={() => setView('attendance')} />
                        <DocCard title="Label Meja" desc="Nomor peserta ukuran besar untuk ditempel di meja." icon="fa-tag" color="text-orange-500" onClick={() => setView('label')} />
                        <DocCard title="Absensi Pengawas" desc="Lembar kehadiran manual untuk semua pengawas." icon="fa-user-clock" color="text-teal-600" onClick={() => setView('supervisor')} />
                        <DocCard title="Jadwal Pengawas" desc="Rekapitulasi jadwal tugas mengawas yang telah digenerate." icon="fa-calendar-day" color="text-indigo-600" onClick={() => setView('supervisor_schedule')} />
                    </div>
                </div>
            );
        };

        const Settings = ({ info, setInfo }) => {
            const [toast, setToast] = useState(null);
            useEffect(() => { if (toast) { const timer = setTimeout(() => setToast(null), 3000); return () => clearTimeout(timer); } }, [toast]);
            const handleChange = (e) => setInfo({...info, [e.target.name]: e.target.value});
            const handleImageUpload = (e, field) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { setInfo(prev => ({ ...prev, [field]: ev.target.result })); }; reader.readAsDataURL(file); } };
            const handleSave = () => { setToast({ type: 'success', message: 'Konfigurasi tersimpan ke Cloud.' }); };
            // Reset di Firebase berarti menimpa data dengan array kosong
            const handleReset = () => {
                if(confirm("PERINGATAN: Semua data di Cloud Database akan dihapus. Lanjutkan?")) {
                   alert("Silakan hapus manual lewat Data Master atau Console Firebase untuk keamanan.");
                }
            };

            return (
                <div className="animate-fade-in-down max-w-4xl">
                    {toast && ( <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 text-white transform transition-all duration-300 animate-fade-in-down border-l-4 border-white/20 backdrop-blur-sm ${toast.type === 'success' ? 'bg-emerald-600/95' : 'bg-rose-600/95'}`}> <div className="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center"><i className={`fas ${toast.type === 'success' ? 'fa-check' : 'fa-exclamation'} text-sm`}></i></div> <div><h4 className="font-bold text-sm tracking-wide">{toast.type === 'success' ? 'BERHASIL' : 'GAGAL'}</h4><p className="text-xs opacity-90">{toast.message}</p></div> <button onClick={() => setToast(null)} className="ml-2 opacity-70 hover:opacity-100 hover:rotate-90 transition-transform"><i className="fas fa-times"></i></button> </div> )}
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">Pengaturan Sekolah</h2>
                    <div className="bg-white rounded-xl shadow p-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div> <label className="block text-sm font-bold text-gray-700 mb-2">Nama Instansi / Dinas</label> <input name="agency" value={info.agency} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            <div> <label className="block text-sm font-bold text-gray-700 mb-2">Nama Sekolah</label> <input name="name" value={info.name} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            <div className="md:col-span-2"> <label className="block text-sm font-bold text-gray-700 mb-2">Alamat Lengkap</label> <input name="address" value={info.address} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            <div> <label className="block text-sm font-bold text-gray-700 mb-2">Nama Ujian</label> <input name="examName" value={info.examName} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            <div> <label className="block text-sm font-bold text-gray-700 mb-2">Tahun Ajaran</label> <input name="year" value={info.year} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            <div> <label className="block text-sm font-bold text-gray-700 mb-2">Kepala Sekolah</label> <input name="headmaster" value={info.headmaster} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            <div> <label className="block text-sm font-bold text-gray-700 mb-2">NIP Kepala Sekolah</label> <input name="headmasterNip" value={info.headmasterNip} onChange={handleChange} className="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white transition" /> </div>
                            
                            <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-6 mt-4 pt-4 border-t border-gray-200">
                                <div> <label className="block text-sm font-bold text-gray-700 mb-2">Logo Sekolah</label> <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'logo')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition"/> {info.logo && <div className="mt-2 border p-2 rounded bg-gray-50 flex justify-center"><img src={info.logo} alt="Logo Preview" className="h-16 object-contain" /></div>} </div>
                                <div> <label className="block text-sm font-bold text-gray-700 mb-2">Tanda Tangan KS</label> <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'signature')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition"/> {info.signature && <div className="mt-2 border p-2 rounded bg-gray-50 flex justify-center"><img src={info.signature} alt="TTD Preview" className="h-16 object-contain" /></div>} </div>
                                <div> <label className="block text-sm font-bold text-gray-700 mb-2">Cap Sekolah</label> <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'stamp')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition"/> {info.stamp && <div className="mt-2 border p-2 rounded bg-gray-50 flex justify-center"><img src={info.stamp} alt="Cap Preview" className="h-16 object-contain" /></div>} </div>
                            </div>
                        </div>
                        <div className="mt-8 flex justify-between items-center">
                            <button onClick={handleReset} className="text-red-600 hover:text-red-800 font-bold text-sm"><i className="fas fa-trash-alt mr-2"></i> Reset Data Awal</button>
                            <button onClick={handleSave} className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition active:scale-95"><i className="fas fa-save mr-2"></i> Simpan Pengaturan</button>
                        </div>
                    </div>
                </div>
            )
        };

        const LoginPage = ({ teachers, onLogin }) => {
            const [role, setRole] = useState('admin');
            const [selectedTeacher, setSelectedTeacher] = useState('');
            const handleLogin = () => {
                if (role === 'admin') onLogin({ role: 'admin', data: null });
                else {
                    if (!selectedTeacher) return alert("Pilih nama Anda terlebih dahulu.");
                    const teacherData = teachers.find(t => t.id === parseInt(selectedTeacher));
                    onLogin({ role: 'teacher', data: teacherData });
                }
            };
            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="bg-blue-600 p-8 text-center">
                            <div className="inline-block p-3 rounded-full bg-blue-500 mb-3 shadow-inner"> <i className="fas fa-school text-4xl text-white"></i> </div>
                            <h1 className="text-2xl font-bold text-white tracking-tight">Portal Asesmen (Cloud)</h1>
                            <p className="text-blue-100 text-sm mt-1">Sistem Manajemen Terpadu & Digital</p>
                        </div>
                        <div className="p-8">
                            <div className="flex bg-gray-100 rounded-lg p-1 mb-6 shadow-inner">
                                <button onClick={()=>setRole('admin')} className={`flex-1 py-2.5 rounded-md text-sm font-bold transition-all duration-200 ${role==='admin' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}><i className="fas fa-user-shield mr-2"></i>Admin</button>
                                <button onClick={()=>setRole('teacher')} className={`flex-1 py-2.5 rounded-md text-sm font-bold transition-all duration-200 ${role==='teacher' ? 'bg-white shadow text-teal-600' : 'text-gray-500 hover:text-gray-700'}`}><i className="fas fa-chalkboard-teacher mr-2"></i>Pengawas</button>
                            </div>
                            {role === 'teacher' && ( <div className="mb-6 animate-fade-in-down"> <label className="block text-sm font-bold text-gray-700 mb-2">Pilih Identitas Pengawas</label> <div className="relative"><i className="fas fa-user absolute left-3 top-3.5 text-gray-400"></i><select className="w-full border border-gray-300 p-3 pl-10 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition bg-white" value={selectedTeacher} onChange={e=>setSelectedTeacher(e.target.value)}><option value="">-- Pilih Nama Anda --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div> </div> )}
                            <button onClick={handleLogin} className={`w-full py-3.5 rounded-lg text-white font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center ${role==='admin' ? 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800' : 'bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700'}`}>Masuk Sistem <i className="fas fa-arrow-right ml-2"></i></button>
                        </div>
                        <div className="bg-gray-50 p-4 text-center border-t border-gray-100"> <p className="text-xs text-gray-500 font-medium">&copy; 2024 Aplikasi Administrasi Sekolah</p> </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ user, schedules, subjects, rooms, onLogout, studentAttendance, setStudentAttendance, violationLogs, setViolationLogs }) => {
            const [activeSession, setActiveSession] = useState(null);
            const mySchedules = schedules.filter(s => s.invigilator1Id === user.data.id || s.invigilator2Id === user.data.id || s.invigilatorId === user.data.id);
            const handleAttendance = (key, sId, status) => setStudentAttendance(prev => ({...prev, [key]: {...(prev[key]||{}), [sId]: status}}));
            const handleViolation = (key, text) => setViolationLogs(prev => ({...prev, [key]: text}));

            if (!activeSession) return (
                <div className="min-h-screen bg-gray-100 flex flex-col">
                    <header className="bg-teal-600 text-white p-4 shadow-md flex justify-between items-center"><div><div className="text-xs opacity-80">Halo,</div><div className="font-bold">{user.data.name}</div></div><button onClick={onLogout} className="bg-teal-700 p-2 rounded hover:bg-teal-800"><i className="fas fa-sign-out-alt"></i></button></header>
                    <main className="flex-1 p-4 space-y-4 max-w-3xl mx-auto w-full">
                        <h3 className="font-bold text-gray-700">Jadwal Anda</h3>
                        {mySchedules.length === 0 ? <div className="text-center p-10 bg-white rounded-xl shadow text-gray-400"><i className="fas fa-coffee text-4xl mb-3"></i><p>Tidak ada jadwal pengawasan.</p></div> : mySchedules.map((sch, i) => { const sub = subjects.find(s => s.id === sch.subjectId); const room = rooms.find(r => r.id === sch.roomId); return <div key={i} onClick={() => setActiveSession(sch)} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-500 cursor-pointer hover:shadow-md transition"><div className="flex justify-between items-start"><div><h4 className="font-bold text-gray-800">{sub?.name}</h4><div className="text-sm text-gray-500 mt-1"><i className="far fa-clock mr-1"></i>{sub?.time}</div></div><div className="bg-teal-50 text-teal-700 px-3 py-1 rounded-lg text-sm font-bold">{room?.name}</div></div></div>; })}
                    </main>
                </div>
            );
            const sch = activeSession; const sub = subjects.find(s => s.id === sch.subjectId); const room = rooms.find(r => r.id === sch.roomId); const roomStudents = Array.from({length: 20}, (_, i) => ({id: i + (room.id * 100), name: `Siswa ${room.name} - ${i+1}`, examNumber: `24-${room.id}-${String(i+1).padStart(3,'0')}`})); const scheduleKey = `${sch.subjectId}-${sch.roomId}`; const currentAttendance = studentAttendance[scheduleKey] || {}; const currentViolation = violationLogs[scheduleKey] || "";
            return ( <div className="min-h-screen bg-gray-100 flex flex-col"> <header className="bg-teal-600 text-white p-4 shadow-md flex items-center gap-3"><button onClick={() => setActiveSession(null)} className="hover:bg-teal-700 p-1 rounded"><i className="fas fa-arrow-left text-xl"></i></button><div className="flex-1"><div className="font-bold text-lg leading-tight">{sub?.name}</div><div className="text-xs opacity-80">{room?.name}</div></div></header> <main className="flex-1 p-4 space-y-6 max-w-3xl mx-auto w-full"> <div className="bg-white p-4 rounded-xl shadow-sm"><h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-user-check text-teal-600 mr-2"></i> Presensi Pengawas</h4><button className="w-full bg-teal-50 text-teal-700 border border-teal-200 py-3 rounded-lg font-bold hover:bg-teal-100 transition"><i className="fas fa-fingerprint mr-2"></i> Klik untuk Check-In</button></div> <div className="bg-white p-4 rounded-xl shadow-sm"><h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-users text-blue-600 mr-2"></i> Kehadiran Peserta</h4><div className="space-y-2 max-h-80 overflow-y-auto pr-1">{roomStudents.map(s => <div key={s.id} className="flex items-center justify-between p-3 border rounded-lg bg-gray-50"><div className="flex-1"><div className="font-bold text-sm">{s.name}</div><div className="text-xs text-gray-500">{s.examNumber}</div></div><div className="flex gap-1">{['H','S','I','A'].map(st => <button key={st} onClick={()=>handleAttendance(scheduleKey, s.id, st)} className={`w-8 h-8 rounded text-xs font-bold transition ${currentAttendance[s.id]===st ? (st==='H'?'bg-green-500 text-white':st==='A'?'bg-red-500 text-white':'bg-yellow-500 text-white') : 'bg-white border text-gray-400'}`}>{st}</button>)}</div></div>)}</div></div> <div className="bg-white p-4 rounded-xl shadow-sm"><h4 className="font-bold text-gray-800 mb-3 flex items-center"><i className="fas fa-exclamation-triangle text-red-600 mr-2"></i> Laporan Kejadian</h4><textarea className="w-full border p-3 rounded-lg h-32 focus:ring-2 focus:ring-red-200 outline-none" placeholder="Tuliskan kejadian khusus..." value={currentViolation} onChange={e=>handleViolation(scheduleKey, e.target.value)}></textarea></div> </main> </div> );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [page, setPage] = useState('dashboard');
            
            // --- FIRESTORE STATES ---
            const [students, setStudents, l1] = useFirestoreState(initialStudents, 'students');
            const [teachers, setTeachers, l2] = useFirestoreState(initialTeachers, 'teachers');
            const [subjects, setSubjects, l3] = useFirestoreState(initialSubjects, 'subjects');
            const [rooms, setRooms, l4] = useFirestoreState(initialRooms, 'rooms');
            const [schoolInfo, setSchoolInfo, l5] = useFirestoreState(initialSchoolInfo, 'schoolInfo');
            const [schedules, setSchedules, l6] = useFirestoreState([], 'schedules');
            const [studentAttendance, setStudentAttendance, l7] = useFirestoreState({}, 'attendance');
            const [violationLogs, setViolationLogs, l8] = useFirestoreState({}, 'logs');

            // Cek apakah semua data sudah siap
            const isLoading = l1 || l2 || l3 || l4 || l5 || l6 || l7 || l8;

            const stats = useMemo(() => ({ s: students.length, t: teachers.length, m: subjects.length, r: rooms.length, sch: schedules.length }), [students, teachers, subjects, rooms, schedules]);

            // Loading Screen
            if (isLoading) return <div className="loading-screen"><div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div><p className="text-gray-500 font-medium">Menghubungkan ke Server Sekolah...</p></div>;

            if (!user) return <LoginPage teachers={teachers} onLogin={setUser} />;

            if (user.role === 'teacher') {
                return <TeacherDashboard user={user} schedules={schedules} subjects={subjects} rooms={rooms} onLogout={() => setUser(null)} studentAttendance={studentAttendance} setStudentAttendance={setStudentAttendance} violationLogs={violationLogs} setViolationLogs={setViolationLogs} />;
            }

            return (
                <div className="min-h-screen flex text-gray-800 font-sans main-content-wrapper">
                    <div className="w-64 bg-slate-800 text-slate-300 flex flex-col shadow-2xl z-20 no-print fixed h-full">
                        <div className="p-6 text-center border-b border-slate-700"> <i className="fas fa-layer-group text-4xl text-blue-500 mb-3"></i> <h1 className="text-white font-bold text-xl tracking-tight">Admin Panel</h1> </div>
                        <nav className="flex-1 p-4 overflow-y-auto"> <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-2">Menu Utama</p> <NavButton active={page==='dashboard'} onClick={()=>setPage('dashboard')} icon="fa-home" label="Dashboard" /> <NavButton active={page==='master'} onClick={()=>setPage('master')} icon="fa-database" label="Data Master" /> <NavButton active={page==='schedule'} onClick={()=>setPage('schedule')} icon="fa-calendar-alt" label="Jadwal Ujian" /> <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-6">Cetak & Laporan</p> <NavButton active={page==='print'} onClick={()=>setPage('print')} icon="fa-print" label="Pusat Cetak" /> <p className="text-xs uppercase font-bold text-slate-500 mb-2 mt-6">Konfigurasi</p> <NavButton active={page==='settings'} onClick={()=>setPage('settings')} icon="fa-cog" label="Pengaturan" /> </nav>
                        <div className="p-4 border-t border-slate-700"> <button onClick={()=>setUser(null)} className="flex items-center text-red-400 hover:text-red-300 transition w-full p-2"><i className="fas fa-sign-out-alt w-8"></i> Logout</button> </div>
                    </div>
                    {/* Tambahkan print:ml-0 agar margin left hilang saat diprint */}
                    <div className="flex-1 ml-64 p-8 overflow-y-auto h-screen print:ml-0 print:p-0">
                         {page === 'dashboard' && <Dashboard stats={stats} schedules={schedules} subjects={subjects} rooms={rooms} students={students} />}
                         {page === 'master' && <DataMaster students={students} setStudents={setStudents} teachers={teachers} setTeachers={setTeachers} subjects={subjects} setSubjects={setSubjects} rooms={rooms} setRooms={setRooms} />}
                         {page === 'schedule' && <ScheduleManager subjects={subjects} rooms={rooms} teachers={teachers} schedules={schedules} setSchedules={setSchedules} />}
                         {page === 'print' && <PrintCenter schoolInfo={schoolInfo} students={students} rooms={rooms} subjects={subjects} schedules={schedules} teachers={teachers} />}
                         {page === 'settings' && <Settings info={schoolInfo} setInfo={setSchoolInfo} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>